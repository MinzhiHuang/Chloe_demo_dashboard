<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Volume vs. Customer Service Agent Analysis - Complete Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="./output.js"></script><!-- Chatwoot widget -->

    <script>
        (function (d, t) {
            var BASE_URL = "http://165.154.110.75:3000";
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = BASE_URL + "/packs/js/sdk.js";
            g.defer = true;
            g.async = true;
            s.parentNode.insertBefore(g, s);
            g.onload = function () {
                window.chatwootSDK.run({
                    websiteToken: 'bD8xdXcLEPEtHSs1q5hqzdKf',
                    baseUrl: BASE_URL
                });
            };
        })(document, "script");
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            font-weight: bold;
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: -10px auto 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 28px;
            margin-top: -10px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            display: none;
        }

        .time-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 8px;
            margin-top: 6px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .business-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .time-tabs .tab {
            flex: 1;
            padding: 15px 25px;
            text-align: center;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: transparent;
            position: relative;
            overflow: hidden;
        }

        .business-tabs .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .time-tabs .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .time-tabs .tab:hover::before {
            left: 100%;
        }

        .time-tabs .tab.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .business-tabs .tab.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .time-tabs .tab:hover,
        .business-tabs .tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .period-header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .period-header .period-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .period-header .period-range {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            letter-spacing: 0.5px;
        }

        .period-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }

        .period-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .period-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .period-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stats-comparison {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-legend {
            display: flex;
            align-items: center;
            gap: 18px;
            margin: 8px 0 12px 4px;
            color: #ffffff;
            font-weight: 700;
        }

        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08);
        }

        .legend-this {
            background: #4285F4;
        }

        .legend-last {
            background: #a78bfa;
        }

        .comparison-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .comparison-card:hover {
            transform: translateY(-3px);
        }

        .metric-name {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .metric-values {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        #comparison-content .metric-values,
        #monthly-content .metric-values {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        #comparison-content .metric-values .current-value,
        #monthly-content .metric-values .current-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        #comparison-content .metric-values .previous-value,
        #monthly-content .metric-values .previous-value {
            font-size: 1.2rem;
            color: #999;
            margin-left: 0;
        }

        #comparison-content .metric-values::after {
            content: '';
            position: absolute;
            width: 1px;
            height: 20px;
            background: #ddd;
            left: 50%;
            transform: translateX(-50%);
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        #comparison-content .metric-values {
            position: relative;
        }

        .current-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .previous-value {
            font-size: 1.2rem;
            color: #999;
        }

        .change-indicator {
            font-size: 1rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
        }

        .change-positive {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
        }

        .change-negative {
            background: linear-gradient(45deg, #f44336, #EF5350);
        }

        .change-neutral {
            background: linear-gradient(45deg, #FF9800, #FFB74D);
        }

        .change-stable {
            background: linear-gradient(45deg, #FF9800, #FFB74D);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 450px;
            margin: 20px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .detailed-comparison {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .comparison-table tbody tr:hover {
            background: #f8f9fa;
        }

        .agent-name {
            color: #667eea;
            font-weight: bold;
        }

        .agent-name:hover {
            color: #5a67d8;
            text-decoration: underline;
            cursor: pointer;
        }

        .agent-name-no-link {
            color: #333;
            font-weight: bold;
        }

        .score-cell {
            font-weight: bold;
        }

        .improvement {
            color: #4CAF50;
            font-weight: bold;
        }

        .decline {
            color: #f44336;
            font-weight: bold;
        }

        .stable {
            color: #FF9800;
            font-weight: bold;
        }

        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .insight-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .insight-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .insight-content {
            color: #666;
            line-height: 1.6;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        @media (max-width: 1200px) {
            .stats-comparison {
                grid-template-columns: repeat(3, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-comparison {
                grid-template-columns: 1fr 1fr;
            }

            .period-info {
                flex-direction: column;
                gap: 15px;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        .issues-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .issue-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .issue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .issue-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .issue-count {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .issue-rate {
            font-size: 0.9rem;
            color: #666;
        }

        .error-rate-high {
            color: #f44336;
        }

        .error-rate-medium {
            color: #ff9800;
        }

        .error-rate-low {
            color: #4caf50;
        }

        .score-badge {
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .score-excellent {
            background: #4CAF50;
        }

        .score-good {
            background: #2196F3;
        }

        .score-average {
            background: #FF9800;
        }

        .score-poor {
            background: #f44336;
        }

        .issue-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }

        .issue-yes {
            background: #f44336;
        }

        .issue-no {
            background: #4CAF50;
        }





        .agent-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .agent-summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .agent-summary-card .label {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .agent-summary-card .value {
            color: #333;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .agent-section-title {
            font-weight: 700;
            margin: 12px 0 8px;
            color: #333;
        }

        .agent-issue-list {
            list-style: disc;
            padding-left: 18px;
            color: #444;
        }

        .collapse-item {
            border: 1px solid #eee;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            background: #fff;
        }

        .collapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: #fafafa;
            cursor: pointer;
        }

        .collapse-title {
            font-weight: 700;
            color: #333;
        }

        .collapse-meta {
            color: #888;
            font-size: 0.9rem;
        }

        .collapse-body {
            display: none;
            padding: 14px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        .collapse-item.active .collapse-body {
            display: block;
        }

        .suggestion-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            padding: 12px;
            color: #333;
        }

        #agent-flyout-panel {
            animation: flyin 0.18s ease-out;
        }

        @keyframes flyin {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .flyout-header {
            position: sticky;
            top: 0;
            padding: 12px 14px;
            margin: -6px -6px 10px -6px;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #0ea5e9 100%);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
            z-index: 1;
        }

        .agent-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            letter-spacing: .5px;
        }

        .flyout-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .chip {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
            font-size: 12px;
            margin-left: 8px;
        }

        .collapse-header {
            border-left: 3px solid #e0e7ff;
            transition: background .2s ease;
        }

        .collapse-item:hover .collapse-header {
            background: #f5f7ff;
        }

        .collapse-item.active .collapse-header {
            background: #eef4ff;
            border-left-color: #667eea;
        }

        .collapse-header::after {
            content: '▾';
            color: #667eea;
            transition: transform .2s ease;
        }

        .collapse-item.active .collapse-header::after {
            transform: rotate(180deg);
        }

        .collapse-meta {
            background: #eef2ff;
            padding: 2px 8px;
            border-radius: 999px;
        }

        .record-item {
            border-left: 4px solid #e0e7ff;
        }

        .record-item {
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        .record-suggestion {
            background: #fff7e6;
            border-bottom: 1px dashed #ffd596;
            padding: 10px 12px;
            color: #8a6d3b;
        }

        .record-dialog {
            background: #ffffff;
            padding: 10px 12px;
            color: #333;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .sub-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            padding-left: 0;
            margin-left: 0;
        }

        .sub-tab {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-radius: 8px;
            text-transform: uppercase;
            font-weight: 600;
            margin-right: 10px;
            margin-left: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .sub-tab:first-child {
            margin-left: 0;
        }

        .sub-tab:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .sub-tab.active {
            color: white;
            background: #667eea;
            border-color: #667eea;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #comparison-content .chart-title {
            line-height: 1.4;
            white-space: normal;
        }

        .chart-title br+span {
            font-size: 1rem;
            color: #666;
            font-weight: normal;
        }
    </style>

</head>

<body>
    <div class="dashboard">
        <div class="header">
            <h1>Message Volume and Agent Analysis</h1>
            <div class="subtitle">Customer Service Quality Assurance Report (2025-06-09 - 2025-06-15)</div>
            <div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,0.9);opacity:0.9;">
                All data in this demo is fake for confidentiality; visualizations were modified for presentation.
            </div>
        </div>

        <div class="time-tabs">
            <div class="tab active" data-time="current">This Week</div>
            <div class="tab" data-time="comparison">This Week vs Last Week</div>
            <div class="tab" data-time="monthly">Monthly Trend</div>
            <div class="tab" data-time="other">Agent Resource Scheduling & Utilization</div>
            <div class="tab" data-time="withdrawal">Withdrawal Review</div>
        </div>

        <div class="business-tabs">
            <div class="tab active" data-business="all">All</div>
            <div class="tab" data-business="language">Standard Language</div>
            <div class="tab" data-business="attitude">Service Attitude</div>
        </div>

        <!-- 本周 vs 上周 内容 -->
        <div id="comparison-content" class="content-section">
            <!-- 全部业务对比视图 -->
            <div id="comparison-all-business-view">
                <!-- Legend -->
                <div class="comparison-legend">
                    <span><span class="legend-dot legend-this"></span>This Week</span>
                    <span><span class="legend-dot legend-last"></span>Last Week</span>
                </div>
                <!-- 核心指标对比 -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                            <span class="previous-value">13</span>
                        </div>
                        <div class="change-indicator change-neutral">No change</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">100</span>
                            <span class="previous-value">89</span>
                        </div>
                        <div class="change-indicator change-positive">+12.4%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">47.41</span>
                            <span class="previous-value">46.33</span>
                        </div>
                        <div class="change-indicator change-positive">+2.3%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">95.8%</span>
                            <span class="previous-value">93.2%</span>
                        </div>
                        <div class="change-indicator change-positive">+2.8%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">88.6%</span>
                            <span class="previous-value">85.4%</span>
                        </div>
                        <div class="change-indicator change-positive">+3.7%</div>
                    </div>
                </div>

                <!-- 图表对比区域 -->
                <div class="charts-grid">
                    <!-- Score distribution change -->
                    <div class="chart-card full-width">
                        <div class="chart-title">All Business Score Distribution Comparison</div>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 详细对比表格 -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">All Business Detailed Comparison Data</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>This Week Score</th>
                                <th>Last Week Score</th>
                                <th>Score Change</th>
                                <th>This Week Tickets</th>
                                <th>Last Week Tickets</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- 规范用语对比视图 -->
            <div id="comparison-language-business-view">
                <!-- Legend -->
                <div class="comparison-legend">
                    <span><span class="legend-dot legend-this"></span>This Week</span>
                    <span><span class="legend-dot legend-last"></span>Last Week</span>
                </div>
                <!-- 规范用语核心指标对比 -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                            <span class="previous-value">13</span>
                        </div>
                        <div class="change-indicator change-neutral">No change</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">79</span>
                            <span class="previous-value">178</span>
                        </div>
                        <div class="change-indicator change-negative">-55.6%</div>
                    </div>


                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">17.8</span>
                            <span class="previous-value">16.9</span>
                        </div>
                        <div class="change-indicator change-positive">+5.3%</div>
                    </div>


                </div>

                <!-- Standard Language comparison -->
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-title">Standard Language Score Distribution Comparison</div>
                        <div class="chart-container">
                            <canvas id="languageScoreComparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 规范用语详细对比表格 -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">Standard Language Detailed Comparison Data</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>This Week Score</th>
                                <th>Last Week Score</th>
                                <th>Score Change</th>
                                <th>This Week Issues/Tickets</th>
                                <th>This Week Issue Rate</th>
                                <th>Last Week Issues/Tickets</th>
                                <th>Last Week Issue Rate</th>
                                <th>Issue Rate Change (This vs Last)</th>
                            </tr>
                        </thead>
                        <tbody id="languageComparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 服务态度对比视图 -->
            <div id="comparison-attitude-business-view" style="display: none;">
                <!-- Legend -->
                <div class="comparison-legend">
                    <span><span class="legend-dot legend-this"></span>This Week</span>
                    <span><span class="legend-dot legend-last"></span>Last Week</span>
                </div>
                <!-- Service Attitude core comparison -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                            <span class="previous-value">13</span>
                        </div>
                        <div class="change-indicator change-neutral">No change</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">100</span>
                            <span class="previous-value">89</span>
                        </div>
                        <div class="change-indicator change-positive">+12.4%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">28.5</span>
                            <span class="previous-value">27.8</span>
                        </div>
                        <div class="change-indicator change-positive">+2.5%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">81.0%</span>
                            <span class="previous-value">88.8%</span>
                        </div>
                        <div class="change-indicator change-negative">-8.8%</div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">49.7%</span>
                            <span class="previous-value">47.6%</span>
                        </div>
                        <div class="change-indicator change-positive">+4.4%</div>
                    </div>
                </div>

                <!-- Service Attitude comparison charts -->
                <div class="charts-grid">
                    <div class="chart-card full-width">
                        <div class="chart-title">Service Attitude Score Distribution Comparison</div>
                        <div class="chart-container">
                            <canvas id="attitudeScoreComparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Service Attitude detailed comparison table -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">Service Attitude Detailed Comparison Data</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>This Week Score</th>
                                <th>Last Week Score</th>
                                <th>Score Change</th>
                                <th>This Week Issues/Tickets</th>
                                <th>This Week Issue Rate</th>
                                <th>Last Week Issues/Tickets</th>
                                <th>Last Week Issue Rate</th>
                                <th>Issue Rate Change (This vs Last)</th>
                            </tr>
                        </thead>
                        <tbody id="attitudeComparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 本周数据 内容 -->
        <div id="current-content" class="content-section active">
            <!-- 全部业务视图 -->
            <div id="all-business-view">
                <!-- 总体统计 -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">100</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">47.41</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">95.8%</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">88.6%</span>
                        </div>
                    </div>
                </div>

                <!-- Current week charts -->
                <div class="charts-grid">
                    <!-- Score distribution -->
                    <div class="chart-card">
                        <div class="chart-title">Score Distribution</div>
                        <div class="chart-container">
                            <canvas id="currentDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Agent ranking by score -->
                    <div class="chart-card">
                        <div class="chart-title">Score Ranking</div>
                        <div class="chart-container">
                            <canvas id="currentRankingChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed data table -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">All Business Quality Inspection Detailed Data</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Agent Name</th>
                                <th>Total Score</th>
                                <th>AI QA Average</th>
                                <th>AI QA Tickets</th>
                                <th>Manual QA Average</th>
                                <th>Manual QA Tickets</th>
                            </tr>
                        </thead>
                        <tbody id="currentTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Response time table -->
            <div id="response-time-table" class="detailed-comparison full-width">
                <div class="chart-title">Response Time Statistics (All Conversations)</div>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>First Response ≤ 30s</th>
                            <th>First Response ≤ 60s</th>
                            <th>First Response ≤ 3m</th>
                            <th>First Response ≤ 5m</th>
                            <th>In-conversation ≤ 30s</th>
                            <th>In-conversation ≤ 60s</th>
                            <th>In-conversation ≤ 3m</th>
                            <th>In-conversation ≤ 5m</th>
                            <th>Total Conversations</th>
                            <th>Valid Conversations</th>
                            <th>Invalid Conversations</th>
                        </tr>
                    </thead>
                    <tbody id="responseTimeTableBody">
                        <!-- 这里将通过JavaScript动态填充每个客服的响应时间数据 -->
                    </tbody>
                </table>
            </div>

            <!-- High-workload response time table -->
            <div id="high-workload-table" class="detailed-comparison full-width">
                <div class="chart-title">High-Workload Statistics (>40 conversations/hour)</div>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>First Response ≤ 30s</th>
                            <th>First Response ≤ 60s</th>
                            <th>First Response ≤ 3m</th>
                            <th>First Response ≤ 5m</th>
                            <th>In-conversation ≤ 30s</th>
                            <th>In-conversation ≤ 60s</th>
                            <th>In-conversation ≤ 3m</th>
                            <th>In-conversation ≤ 5m</th>
                            <th>Total Conversations During High Workload</th>
                        </tr>
                    </thead>
                    <tbody id="highWorkloadTableBody">
                        <!-- 这里将通过JavaScript动态填充高负荷时段数据 -->
                    </tbody>
                </table>
            </div>

            <!-- Standard language view -->
            <div id="language-business-view" style="display: none;">
                <!-- Standard language stats -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">0</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">17.8</span>
                        </div>
                    </div>
                </div>

                <!-- Main charts area -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Score Ranking</div>
                        <div class="chart-container">
                            <canvas id="languageRankingChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-title">Issue Frequency Analysis</div>
                        <div class="issues-grid" id="languageIssuesGrid">
                            <!-- 这里将通过JavaScript动态填充语言质量问题 -->
                        </div>
                    </div>
                </div>

                <!-- 问题类型分析 -->
                <div class="detailed-comparison full-width" style="display: none;">
                    <div class="chart-title">各类问题发生频率分析</div>
                    <div class="issues-grid" id="languageIssuesGrid">
                        <!-- 这里将通过JavaScript动态填充语言质量问题 -->
                    </div>
                </div>

                <!-- 详细数据表格 -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">Standard Language Quality Inspection Details</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Agent Name</th>
                                <th>QA Tickets</th>
                                <th>Standard Language Score</th>
                                <th>Prohibited Phrases</th>
                                <th>Repetitive Description</th>
                                <th>Impolite Words</th>
                                <th>Missing Greeting</th>
                                <th>Missing Closing</th>
                                <th>Typos</th>
                                <th>Incoherent Sentences</th>
                                <th>Other</th>
                            </tr>
                        </thead>
                        <tbody id="languageTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 服务态度专项视图 -->
            <div id="attitude-business-view" style="display: none;">
                <!-- Service Attitude stats -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Number of Agents</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">QA Tickets</div>
                        <div class="metric-values">
                            <span class="current-value">0</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">28.5</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">95.0%</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">15</span>
                        </div>
                    </div>
                </div>



                <!-- Main charts area -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Score Ranking</div>
                        <div class="chart-container">
                            <canvas id="attitudeRankingChart"></canvas>
                        </div>
                    </div>

                    <!-- Issue type analysis -->
                    <div class="chart-card">
                        <div class="chart-title">Issue Frequency Analysis</div>
                        <div class="issues-grid" id="attitudeIssuesGrid">
                            <!-- Filled dynamically via JavaScript -->
                        </div>
                    </div>

                    <!-- Detailed data table -->
                    <div class="detailed-comparison full-width">
                        <div class="chart-title">Service Attitude Quality Inspection Details</div>
                        <!-- 添加tab栏 -->
                        <div class="sub-tabs">
                            <button class="sub-tab" onclick="switchSubTab(this, 'attitude-overall')">OVERALL</button>
                            <button class="sub-tab" onclick="switchSubTab(this, 'attitude-positive')">POSITIVE</button>
                            <button class="sub-tab" onclick="switchSubTab(this, 'attitude-negative')">NEGATIVE</button>
                            <button class="sub-tab" onclick="switchSubTab(this, 'attitude-natural')">NEUTRAL</button>
                        </div>
                        <!-- overall表格 -->
                        <div id="attitude-overall" class="sub-tab-content active">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Agent Name</th>
                                        <th>Politeness Score</th>
                                        <th>Empathy Score</th>
                                        <th>Response Time Score</th>
                                        <th>Service Attitude Total</th>
                                        <th>First Response Rate (%)</th>
                                        <th>Avg. First Response (s)</th>
                                        <th>Avg. Response Time (s)</th>
                                        <th>30s Response Rate (%)</th>
                                        <th>QA Tickets</th>
                                    </tr>
                                </thead>
                                <tbody id="attitudeOverallTableBody">
                                </tbody>
                            </table>
                        </div>
                        <!-- positive表格 -->
                        <div id="attitude-positive" class="sub-tab-content">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Agent Name</th>
                                        <th>Politeness Score</th>
                                        <th>Empathy Score</th>
                                        <th>Response Time Score</th>
                                        <th>Service Attitude Total</th>
                                        <th>First Response Rate (%)</th>
                                        <th>Avg. First Response (s)</th>
                                        <th>Avg. Response Time (s)</th>
                                        <th>30s Response Rate (%)</th>
                                        <th>QA Tickets</th>
                                    </tr>
                                </thead>
                                <tbody id="attitudePositiveTableBody">
                                </tbody>
                            </table>
                        </div>
                        <!-- negative表格 -->
                        <div id="attitude-negative" class="sub-tab-content">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Agent Name</th>
                                        <th>Politeness Score</th>
                                        <th>Empathy Score</th>
                                        <th>Response Time Score</th>
                                        <th>Service Attitude Total</th>
                                        <th>First Response Rate (%)</th>
                                        <th>Avg. First Response (s)</th>
                                        <th>Avg. Response Time (s)</th>
                                        <th>30s Response Rate (%)</th>
                                        <th>QA Tickets</th>
                                    </tr>
                                </thead>
                                <tbody id="attitudeNegativeTableBody">
                                </tbody>
                            </table>
                        </div>
                        <!-- natural表格 -->
                        <div id="attitude-natural" class="sub-tab-content">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Agent Name</th>
                                        <th>Politeness Score</th>
                                        <th>Empathy Score</th>
                                        <th>Response Time Score</th>
                                        <th>Service Attitude Total</th>
                                        <th>First Response Rate (%)</th>
                                        <th>Avg. First Response (s)</th>
                                        <th>Avg. Response Time (s)</th>
                                        <th>30s Response Rate (%)</th>
                                        <th>QA Tickets</th>
                                    </tr>
                                </thead>
                                <tbody id="attitudeNaturalTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="monthly-content" class="content-section">
            <!-- All Business - Monthly View -->
            <div id="monthly-all-business-view">
                <!-- Monthly overview metrics -->
                <div class="stats-comparison">

                    <div class="comparison-card">
                        <div class="metric-name">Active Agents (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">13</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Total Tickets (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">312</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">47.8</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">96.2%</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly 30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">89.3%</span>
                        </div>
                    </div>
                </div>

                <!-- Trend charts -->
                <div class="charts-grid">
                    <!-- Weekly performance comparison -->
                    <div class="chart-card full-width">
                        <div class="chart-title">Weekly Performance Comparison</div>
                        <div class="chart-container">
                            <canvas id="weeklyComparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Trend analysis table -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">All Business Monthly Scores</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Monthly Average</th>
                                <th>Week 1</th>
                                <th>Week 2</th>
                                <th>Week 3</th>
                                <th>Week 4</th>
                                <th>QA Tickets</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTrendTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Standard Language - Monthly View -->
            <div id="monthly-language-business-view" style="display: none;">
                <!-- Monthly overview metrics -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Active Agents (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">19</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Total Tickets (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">583</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">17.2</span>
                        </div>
                    </div>
                </div>

                <!-- Trend charts -->
                <div class="charts-grid">
                    <!-- Weekly Standard Language performance -->
                    <div class="chart-card">
                        <div class="chart-title">Weekly Standard Language Performance</div>
                        <div class="chart-container">
                            <canvas id="languageDailyScoreTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Issue type monthly trend -->
                    <div class="chart-card">
                        <div class="chart-title">Issue Type Monthly Trend</div>
                        <div class="chart-container">
                            <canvas id="languageIssueMonthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Monthly improvement table -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">Standard Language Monthly Scores</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Monthly Average</th>
                                <th>Week 1</th>
                                <th>Week 2</th>
                                <th>Week 3</th>
                                <th>Week 4</th>
                                <th>QA Tickets</th>
                            </tr>
                        </thead>
                        <tbody id="languageMonthlyTrendTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Service Attitude - Monthly View -->
            <div id="monthly-attitude-business-view" style="display: none;">
                <!-- Monthly overview metrics -->
                <div class="stats-comparison">
                    <div class="comparison-card">
                        <div class="metric-name">Active Agents (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">19</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Total Tickets (Monthly)</div>
                        <div class="metric-values">
                            <span class="current-value">583</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly Average Score</div>
                        <div class="metric-values">
                            <span class="current-value">17.2</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly First Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">96.2%</span>
                        </div>
                    </div>

                    <div class="comparison-card">
                        <div class="metric-name">Monthly 30s Response Rate</div>
                        <div class="metric-values">
                            <span class="current-value">89.3%</span>
                        </div>
                    </div>
                </div>

                <!-- Service Attitude monthly charts -->
                <div class="charts-grid">
                    <!-- Weekly Service Attitude Performance -->
                    <div class="chart-card">
                        <div class="chart-title">Weekly Service Attitude Performance</div>
                        <div class="chart-container">
                            <canvas id="attitudeDailyScoreTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Service Attitude Issue Monthly Trend -->
                    <div class="chart-card">
                        <div class="chart-title">Service Attitude Issue Monthly Trend</div>
                        <div class="chart-container">
                            <canvas id="attitudeIndicatorMonthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Monthly improvement table -->
                <div class="detailed-comparison full-width">
                    <div class="chart-title">Service Attitude Monthly Scores</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Monthly Average</th>
                                <th>Week 1</th>
                                <th>Week 2</th>
                                <th>Week 3</th>
                                <th>Week 4</th>
                                <th>QA Tickets</th>
                            </tr>
                        </thead>
                        <tbody id="attitudeMonthlyTrendTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="withdrawal-content" class="content-section">
            <div class="stats-comparison">
                <div class="comparison-card">
                    <div class="metric-name">Total Withdrawals</div>
                    <div class="metric-values">
                        <span class="current-value" id="total-withdrawal-count"></span>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="metric-name">Manual Reviews</div>
                    <div class="metric-values">
                        <span class="current-value" id="total-manual-audit-count"></span>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="metric-name">Reviewed within 1 min (All)</div>
                    <div class="metric-values">
                        <span class="current-value" id="within-1min-count"></span>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="metric-name">Within 1 min Rate (All)</div>
                    <div class="metric-values">
                        <span class="current-value" id="within-1min-rate"></span>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="metric-name">Reviewed within 3 min (All)</div>
                    <div class="metric-values">
                        <span class="current-value" id="within-3min-count"></span>
                    </div>
                </div>

                <div class="comparison-card">
                    <div class="metric-name">Within 3 min Rate (All)</div>
                    <div class="metric-values">
                        <span class="current-value" id="within-3min-rate"></span>
                    </div>
                </div>
            </div>

            <!-- charts removed per requirement -->

            <div class="detailed-comparison full-width">
                <div class="chart-title">Manual Withdrawal Review Details</div>
                <div class="sub-tabs">
                    <button class="sub-tab active" onclick="switchSubTab(this, 'withdraw-overall')">OVERALL</button>
                </div>

                <div id="withdraw-overall" class="sub-tab-content active">
                    <table class="comparison-table ">
                        <thead>
                            <tr>
                                <th>Reviewer</th>
                                <th>Total Reviews</th>
                                <th>Within 1 min</th>
                                <th>Within 1 min Rate</th>
                                <th>Within 3 min</th>
                                <th>Within 3 min Rate</th>
                                <th>Over 3 min</th>
                                <th>Over 3 min Rate</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalOverallTableBody">
                        </tbody>
                    </table>
                </div>


            </div>

            <!-- 出金审核时效趋势图表 - 独立板块 -->
            <div class="detailed-comparison full-width" style="margin-top: 40px;">
                <div class="chart-title">Withdrawal Review Timeliness Trend</div>
                <div style="padding: 20px; background: white; border-radius: 8px;">
                    <div style="width: 100%; height: 400px;">
                        <canvas id="withdrawalTrendLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="daily-summary-section" class="section-header"
        style="text-align: center; margin-top: 50px; margin-bottom: 18px;">
        <h2 style="color: white; font-size: 28px; margin-bottom: 10px;">Daily Workload Analysis</h2>
    </div>

    <div id="daily-summary-table-container"
        style="display: flex; justify-content: center; align-items: center; margin-bottom: 40px;">
        <div
            style="background: #fff; border-radius: 18px; box-shadow: 0 6px 32px rgba(0,0,0,0.10); padding: 30px; max-width: 1200px; width: 100%;">
            <table id="dailySummaryTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th
                            style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
                            Date</th>
                        <th
                            style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
                            Online Agents</th>
                        <th
                            style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
                            Valid Sessions</th>
                        <th
                            style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
                            Invalid Sessions</th>
                        <th
                            style="padding: 12px 8px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; color: #333;">
                            Workload</th>
                    </tr>
                </thead>
                <tbody id="dailySummaryTableBody">
                    <!-- 数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>


    <!-- Agent Resource Scheduling & Utilization -->
    <div id="other-content" class="content-section" style="min-height: 1500px; padding-bottom: 50px;">
        <!-- Message peak interval and agent count distribution (Chart.js) -->
        <div class="section-header" style="text-align: center; margin-top: 50px; margin-bottom: 18px;">
            <h2 style="color: white; font-size: 28px; margin-bottom: 10px;">Conversation Volume vs Staffing (Weekly)
            </h2>
        </div>
        <div class="chart-bg" style="display: flex; justify-content: center; align-items: center;">
            <div
                style="background: #fff; border-radius: 18px; box-shadow: 0 6px 32px rgba(0,0,0,0.10); padding: 36px 36px 24px 36px; max-width: 1200px; width: 100%;">
                <canvas id="messagePeakChart" style="width: 100%; height: 110px;"></canvas>
            </div>
        </div>

        <!-- Original content below -->
        <div class="section-header" style="text-align: center; margin-top: 50px; margin-bottom: 30px;">
            <h2 style="color: white; font-size: 28px; margin-bottom: 5px;">Conversation Volume vs Staffing (Daily)</h2>
        </div>
        <!-- 图表容器待后续插入 -->
        <div class="chart-bg"
            style="display: flex; justify-content: center; align-items: center; margin-bottom: 40px; margin-top: 20px; ">
            <div
                style="background: #fff; border-radius: 18px; box-shadow: 0 6px 32px rgba(0,0,0,0.10); padding: 36px 36px 24px 36px; max-width: 1200px; width: 100%;">
                <div id="msg-vs-agent-tabs" style="text-align:center; margin-bottom:18px;"></div>
                <canvas id="msgVsAgentByDayChart" style="width: 100%; height: 110px;"></canvas>
            </div>
        </div>


        <!-- Agent scheduling heatmap -->
        <div style="margin-top: 60px;">
            <div class="section-header" style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: white; font-size: 28px; margin-bottom: 10px;">Valid Conversation Heatmap (Daily)</h2>
                <div style="margin-top: 10px; margin-bottom: 2px;">
                    <button id="prevDate"
                        style="margin:0 10px;padding:5px 15px;border-radius:5px;border:none;background:#1976D2;color:white;cursor:pointer;">Previous
                        Day</button>
                    <span id="currentDate" style="color:white;font-size:18px;margin:0 15px;"></span>
                    <button id="nextDate"
                        style="margin:0 10px;padding:5px 15px;border-radius:5px;border:none;background:#1976D2;color:white;cursor:pointer;">Next
                        Day</button>
                </div>
            </div>
            <div id="heatmapChart" style="width: 90vw; height: 600px; margin: 0 auto;"></div>
        </div>
    </div>

    <script>
        // 全局数据变量
        let dashboardData = jsonData;
        let currentData = [];
        let monthlyTrendData = {};
        let currentBusinessType = 'all'; // 当前业务类型
        let languageData = []; // 规范用语数据
        let languageMonthlyTrendData = {}; // 规范用语月度趋势数据
        let withdrawalTrendChartInstance = null;
        let withdrawalTimeChartInstance = null;

        // 全局图表实例
        let chartInstances = {};

        // 规范用语专项数据
        let languageSpecialData = [
            { name: 'Jessica', score: 16, issues: { 重复性描述: 1, 淘宝用语: 0, 错别字: 2, 缺少结束语: 0, 缺少开首语: 1, 网络用语: 0, 标点错误: 1, 语句不通: 0, 其他: 0 } },
            { name: 'daria', score: 20, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Miya', score: 20, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Euphemia', score: 20, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'lemon', score: 19, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 1, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Arya', score: 20, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Zara', score: 18, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 1, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Gloria', score: 18, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 1, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'Sara', score: 16, issues: { 重复性描述: 1, 淘宝用语: 0, 错别字: 1, 缺少结束语: 0, 缺少开首语: 1, 网络用语: 0, 标点错误: 1, 语句不通: 0, 其他: 0 } },
            { name: 'Hera', score: 16, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 1, 语句不通: 1, 其他: 0 } },
            { name: 'clara', score: 18, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 0, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 1, 语句不通: 0, 其他: 0 } },
            { name: 'Lucas', score: 18, issues: { 重复性描述: 0, 淘宝用语: 0, 错别字: 1, 缺少结束语: 0, 缺少开首语: 0, 网络用语: 0, 标点错误: 0, 语句不通: 0, 其他: 0 } },
            { name: 'zhenhou', score: 10, issues: { 重复性描述: 1, 淘宝用语: 0, 错别字: 1, 缺少结束语: 0, 缺少开首语: 1, 网络用语: 0, 标点错误: 1, 语句不通: 1, 其他: 0 } }
        ];

        // 服务态度专项数据
        let attitudeSpecialData = [
            { name: 'Jessica', score: 26, issues: { 响应超时: 1, 服务语气不佳: 0, 情绪安抚不足: 1, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 2, 其他: 0 } },
            { name: 'daria', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Miya', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Euphemia', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'lemon', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Arya', score: 29, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 1, 其他: 0 } },
            { name: 'Zara', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Gloria', score: 29, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 1, 其他: 0 } },
            { name: 'Sara', score: 29, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 1, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Hera', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'clara', score: 30, issues: { 响应超时: 0, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'Lucas', score: 29, issues: { 响应超时: 1, 服务语气不佳: 0, 情绪安抚不足: 0, 催促客户: 0, 缺乏服务热情: 0, 响应缓慢: 0, 其他: 0 } },
            { name: 'zhenhou', score: 24, issues: { 响应超时: 1, 服务语气不佳: 1, 情绪安抚不足: 1, 催促客户: 0, 缺乏服务热情: 1, 响应缓慢: 1, 其他: 1 } }
        ];

        // 销毁指定图表
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        // 销毁所有图表
        function destroyAllCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                destroyChart(chartId);
            });
        }

        // 加载数据
        async function loadData() {
            try {

                const jsonData = dashboardData;
                console.log('成功加载JSON数据:', jsonData);

                // 等待DOM完全渲染
                setTimeout(() => {
                    console.log('开始更新数据...');
                    updateDashboardFromJson(jsonData);
                }, 200);
            } catch (error) {
                console.error('数据加载失败:', error);
                // 使用默认数据作为后备
                useDefaultData();
            }
        }

        // 从JSON数据更新仪表盘
        function updateDashboardFromJson(jsonData) {
            if (!jsonData.currentPeriod) return;

            // 将JSON数据存储在全局变量中，供图表使用
            console.log(jsonData);
            dashboardData = jsonData;

            const data = jsonData.currentPeriod;
            // 更新本周数据概览指标
            if (data.overview) {
                const overview = data.overview;
                const statsCards = document.querySelectorAll('#all-business-view .stats-comparison .comparison-card .current-value');
                if (statsCards.length >= 5) {
                    // Display top-7 consistently
                    statsCards[0].textContent = Math.min(7, overview.agentCount);
                    statsCards[1].textContent = overview.totalOrders;
                    statsCards[2].textContent = overview.averageScore.toFixed(1);
                    statsCards[3].textContent = overview.firstResponseRate + '%';  // 索引3对应第4个元素  
                    statsCards[4].textContent = overview.responseIn30sRate + '%';
                }
            }


            // 更新客服表格数据
            if (data.agents) {
                updateAgentTableFromJson(data.agents);
            }

            // 转换数据格式以兼容现有图表代码
            if (data.agents) {
                // 更新全部业务数据
                currentData = data.agents.map(agent => ({
                    name: agent.name,
                    current: agent.score,
                    previous: agent.score - (Math.random() * 2 - 1), // 模拟上周数据
                    currentCount: agent.orderCount,
                    previousCount: agent.orderCount + Math.floor(Math.random() * 5 - 2),
                    ranking: agent.ranking, // 添加ranking信息
                    qualityLevel: agent.qualityLevel // 添加qualityLevel信息
                }));

                // 从personalReports中提取规范用语数据
                if (jsonData.personalReports) {
                    languageData = data.agents.map(agent => {
                        const personalReport = jsonData.personalReports[agent.name];
                        const languageScore = personalReport?.overview?.languageScore || agent.score - 2; // 如果没有语言得分，默认比总分低2分
                        const languageIssues = personalReport?.languageQuality?.totalIssues || 0;
                        // 根据语言问题数量调整工单数（语言维度的工单通常更少）
                        const languageOrderCount = Math.max(1, agent.orderCount - languageIssues);

                        return {
                            name: agent.name,
                            current: languageScore,
                            previous: languageScore - (Math.random() * 2 - 1), // 模拟上周数据
                            currentCount: languageOrderCount,
                            previousCount: languageOrderCount + Math.floor(Math.random() * 3 - 1),
                            ranking: agent.ranking // 添加ranking信息
                        };
                    });

                    // 更新规范用语专项数据（用于规范用语界面的图表和表格）
                    languageSpecialData = data.agents.map(agent => {
                        const personalReport = jsonData.personalReports[agent.name];
                        const languageScore = personalReport?.overview?.languageScore || agent.score - 2;
                        const languageIssues = personalReport?.languageQuality?.issues || {};

                        // 将JSON中的问题类型映射到规范用语界面期望的格式
                        const mappedIssues = {
                            '服务禁语': languageIssues['服务禁语'] || 0,
                            '重复性描述': languageIssues['重复性描述'] || 0,
                            '不礼貌用词': languageIssues['不礼貌用词'] || 0,
                            '缺少开首语': languageIssues['缺少开首语'] || 0,
                            '缺少结束语': languageIssues['缺少结束语'] || 0,
                            '错别字': languageIssues['错别字'] || 0,
                            '语句不通': languageIssues['语句不通'] || 0,
                            '其他': languageIssues['其他'] || 0
                        };

                        // JSON中的languageScore已经是20分制，直接使用即可
                        const normalizedScore = Math.max(10, Math.min(20, languageScore));

                        return {
                            name: agent.name,
                            score: normalizedScore,
                            issues: mappedIssues
                        };
                    });

                    // 输出完整的languageSpecialData数组进行调试
                    console.log('生成的languageSpecialData:', languageSpecialData);

                    // 更新服务态度专项数据（用于服务态度界面的图表和表格）
                    attitudeSpecialData = data.agents.map(agent => {
                        const personalReport = jsonData.personalReports[agent.name];
                        const attitudeScore = personalReport?.overview?.attitudeScore || agent.score - 2;
                        const attitudeIssues = personalReport?.serviceAttitude?.issues || {};

                        // 将JSON中的问题类型映射到服务态度界面期望的格式
                        const mappedIssues = {
                            '响应超时': attitudeIssues['响应超时'] || 0,
                            '服务语气不佳': attitudeIssues['服务语气不佳'] || 0,
                            '情绪安抚不足': attitudeIssues['情绪安抚不足'] || 0,
                            '催促客户': attitudeIssues['催促客户'] || 0,
                            '缺乏服务热情': attitudeIssues['缺乏服务热情'] || 0,
                            '响应缓慢': attitudeIssues['响应缓慢'] || 0,
                            '其他': attitudeIssues['其他'] || 0
                        };

                        // JSON中的attitudeScore已经是30分制，直接使用即可
                        const normalizedScore = Math.max(15, Math.min(30, attitudeScore));

                        return {
                            name: agent.name,
                            score: normalizedScore,
                            issues: mappedIssues
                        };
                    });

                    // 输出完整的attitudeSpecialData数组进行调试
                    console.log('生成的attitudeSpecialData:', attitudeSpecialData);
                } else {
                    // 如果没有personalReports数据，使用总分减去一定数值作为语言得分
                    languageData = data.agents.map(agent => ({
                        name: agent.name,
                        current: Math.max(30, agent.score - 2 - Math.random() * 2), // 语言得分通常比总分低2-4分
                        previous: Math.max(30, agent.score - 2 - Math.random() * 2 - (Math.random() * 2 - 1)),
                        currentCount: Math.max(1, Math.floor(agent.orderCount * 0.6)), // 语言维度工单数约为总数的60%
                        previousCount: Math.max(1, Math.floor(agent.orderCount * 0.6) + Math.floor(Math.random() * 3 - 1))
                    }));

                    // 为languageSpecialData生成基础数据
                    languageSpecialData = data.agents.map(agent => ({
                        name: agent.name,
                        score: Math.max(10, agent.score - 2 - Math.random() * 2), // 语言得分
                        issues: {
                            '重复性描述': Math.floor(Math.random() * 2),
                            '淘宝用语': Math.floor(Math.random() * 2),
                            '错别字': Math.floor(Math.random() * 2),
                            '缺少结束语': Math.floor(Math.random() * 2),
                            '缺少开首语': Math.floor(Math.random() * 2),
                            '网络用语': Math.floor(Math.random() * 2),
                            '标点错误': Math.floor(Math.random() * 2),
                            '语句不通': Math.floor(Math.random() * 2),
                            '其他': 0
                        }
                    }));
                }

                // 初始化月度趋势数据（确保在HTTP服务器环境下也有数据）
                if (jsonData.monthlyTrend && jsonData.monthlyTrend.monthlyTrendSummary && jsonData.monthlyTrend.monthlyTrendSummary.weeklyChartData) {
                    const weeklyChart = jsonData.monthlyTrend.monthlyTrendSummary.weeklyChartData;
                    monthlyTrendData = {
                        weeklyData: {
                            week1: {
                                avg: weeklyChart.week1?.avg || 46.8,
                                workload: weeklyChart.week1?.workload || 64
                            },
                            week2: {
                                avg: weeklyChart.week2?.avg || 47.6,
                                workload: weeklyChart.week2?.workload || 89
                            },
                            week3: {
                                avg: weeklyChart.week3?.avg || 48.1,
                                workload: weeklyChart.week3?.workload || 95
                            },
                            week4: {
                                avg: weeklyChart.week4?.avg || 48.5,
                                workload: weeklyChart.week4?.workload || 102
                            }
                        }
                    };
                } else {
                    // 保留原有的硬编码数据作为后备
                    monthlyTrendData = {
                        weeklyData: {
                            week1: { avg: 46.8, workload: 64 },
                            week2: { avg: 47.6, workload: 89 },
                            week3: { avg: 48.1, workload: 95 },
                            week4: { avg: 48.5, workload: 102 }
                        }
                    };
                }

                // 生成规范用语月度趋势数据
                languageMonthlyTrendData = {
                    dailyScores: [44.8, 45.2, 45.6, 45.3, 45.8, 46.2, 46.5, 46.1, 46.4, 46.7, 46.3, 46.6, 46.9, 46.5, 46.8, 47.1, 46.7, 47.0, 47.3, 46.9, 47.2, 47.5, 47.1, 47.4, 47.7, 47.3, 47.6, 47.9, 47.5, 47.8, 48.1],
                    dailyWorkloads: [6, 8, 11, 8, 10, 13, 11, 9, 12, 13, 11, 11, 14, 13, 12, 15, 13, 13, 15, 14, 13, 16, 15, 14, 17, 15, 15, 18, 16, 15, 18],
                    weeklyData: {
                        week1: { avg: 45.4, workload: 45 },
                        week2: { avg: 46.1, workload: 62 },
                        week3: { avg: 46.8, workload: 67 },
                        week4: { avg: 47.2, workload: 71 }
                    }
                };

                // 按照JSON中的ranking字段排序，而不是按分数排序
                currentData.sort((a, b) => a.ranking - b.ranking);
                languageData.sort((a, b) => a.ranking - b.ranking);
                languageSpecialData.sort((a, b) => b.score - a.score);

                // 重新初始化图表，确保使用最新的数据
                setTimeout(() => {
                    console.log('重新初始化图表，dashboardData:', dashboardData);
                    if (dashboardData && dashboardData.currentPeriod && dashboardData.currentPeriod.scoreDistribution) {
                        console.log('使用JSON中的scoreDistribution数据:', dashboardData.currentPeriod.scoreDistribution);
                    }
                    initCurrentDistributionChart();
                    initCurrentRankingChart();
                    generateCurrentTable(); // 添加表格更新

                    // 同时更新规范用语和服务态度界面的图表
                    initLanguageCharts();
                    generateLanguageTable();
                    initAttitudeCharts();
                    generateAttitudeTable();

                    // 更新本周vs上周界面
                    updateComparisonStats(dashboardData.currentPeriod.overview, dashboardData.previousPeriod.overview);
                    generateComparisonTable();

                    // 初始化月度趋势界面
                    updateMonthlyTrendStats();
                    initMonthlyTrendCharts();

                    // 初始化出金审核数据
                    updateWithdrawStats();
                }, 100);
            }
        }

        // 更新客服表格（从JSON数据）
        function updateAgentTableFromJson(agents) {
            const tbody = document.getElementById('currentTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            agents.forEach((agent, index) => {
                const row = document.createElement('tr');

                // 计算总分
                const totalScore = agent.score + (agent.human_score || 0);

                // 🎯 修复：按照表头顺序生成列
                row.innerHTML = `
                    <td>${index + 1}</td>                                      <!-- 排名 -->
                    <td><span class="agent-name" data-agent="${agent.name.replace(/"/g, '&quot;')}">${(agent.name === 'jackkob	' || agent.name === 'jackkob	') ? 'jackkob	' : agent.name}</span></td>  <!-- 客服姓名（可点击，委托绑定） -->
                    <td><span class="score-cell" style="font-weight: bold;">${totalScore.toFixed(1)}</span></td>  <!-- 总分 - 第3列 -->
                    <td><span class="score-cell">${agent.score.toFixed(1)}</span></td>  <!-- AI质检平均分 -->
                    <td><strong>${agent.orderCount}</strong></td>               <!-- AI质检工单数量 -->
                    <td><span class="score-cell">${agent.human_score > 0 ? agent.human_score.toFixed(1) : '-'}</span></td>  <!-- 业务质检平均分 -->
                    <td><strong>${agent.human_order_count > 0 ? agent.human_order_count : '-'}</strong></td>  <!-- 业务质检工单数量 -->
                `;
                tbody.appendChild(row);
            });
        }

        // 使用默认数据（原有的硬编码数据作为后备）
        function useDefaultData() {
            currentData = [
                { name: 'Jessica', current: 52.00, previous: 48.5, currentCount: 9, previousCount: 7 },
                { name: 'daria', current: 51.00, previous: 50.0, currentCount: 6, previousCount: 5 },
                { name: 'Miya', current: 50.00, previous: 49.2, currentCount: 2, previousCount: 3 },
                { name: 'Euphemia', current: 50.00, previous: 50.0, currentCount: 6, previousCount: 6 },
                { name: 'lemon', current: 49.00, previous: 47.8, currentCount: 2, previousCount: 2 },
                { name: 'Arya', current: 49.00, previous: 49.5, currentCount: 3, previousCount: 4 },
                { name: 'Zara', current: 48.00, previous: 46.8, currentCount: 13, previousCount: 11 },
                { name: 'Gloria', current: 47.67, previous: 47.2, currentCount: 18, previousCount: 15 },
                { name: 'Hera', current: 47.22, previous: 46.9, currentCount: 9, previousCount: 8 },
                { name: 'Sara', current: 47.00, previous: 48.1, currentCount: 4, previousCount: 5 },
                { name: 'clara', current: 46.88, previous: 47.5, currentCount: 8, previousCount: 9 },
                { name: 'Lucas', current: 46.72, previous: 45.8, currentCount: 18, previousCount: 16 },
                { name: 'zhenhou', current: 33.75, previous: 35.2, currentCount: 4, previousCount: 3 }
            ];

            // 生成规范用语默认数据
            languageData = [
                { name: 'Jessica', current: 48.50, previous: 46.8, currentCount: 6, previousCount: 5 },
                { name: 'daria', current: 48.20, previous: 48.5, currentCount: 4, previousCount: 4 },
                { name: 'Miya', current: 47.80, previous: 47.1, currentCount: 1, previousCount: 2 },
                { name: 'Euphemia', current: 47.60, previous: 48.2, currentCount: 4, previousCount: 4 },
                { name: 'lemon', current: 46.50, previous: 45.9, currentCount: 1, previousCount: 1 },
                { name: 'Arya', current: 46.20, previous: 47.1, currentCount: 2, previousCount: 3 },
                { name: 'Zara', current: 45.80, previous: 44.5, currentCount: 9, previousCount: 8 },
                { name: 'Gloria', current: 45.30, previous: 45.0, currentCount: 13, previousCount: 11 },
                { name: 'Sara', current: 44.50, previous: 45.8, currentCount: 3, previousCount: 4 },
                { name: 'Hera', current: 44.80, previous: 44.2, currentCount: 6, previousCount: 6 },
                { name: 'clara', current: 44.20, previous: 45.1, currentCount: 6, previousCount: 6 },
                { name: 'Lucas', current: 44.10, previous: 43.5, currentCount: 13, previousCount: 11 },
                { name: 'zhenhou', current: 31.20, previous: 32.8, currentCount: 3, previousCount: 2 }
            ];

            monthlyTrendData = {
                dailyScores: [46.2, 46.8, 47.1, 46.9, 47.3, 47.8, 48.1, 47.6, 47.9, 48.2, 47.7, 48.0, 48.3, 47.8, 48.1, 48.4, 47.9, 48.2, 48.5, 48.1, 48.3, 48.6, 48.2, 48.4, 48.7, 48.3, 48.5, 48.8, 48.4, 48.6, 48.9],
                dailyWorkloads: [8, 12, 15, 11, 14, 18, 16, 13, 17, 19, 15, 16, 20, 18, 17, 21, 19, 18, 22, 20, 19, 23, 21, 20, 24, 22, 21, 25, 23, 22, 26],
                weeklyData: {
                    week1: { avg: 46.8, workload: 64 },
                    week2: { avg: 47.6, workload: 89 },
                    week3: { avg: 48.1, workload: 95 },
                    week4: { avg: 48.5, workload: 102 },
                    week5: { avg: 48.7, workload: 62 }
                }
            };

            // 生成规范用语月度趋势默认数据
            languageMonthlyTrendData = {
                dailyScores: [44.8, 45.2, 45.6, 45.3, 45.8, 46.2, 46.5, 46.1, 46.4, 46.7, 46.3, 46.6, 46.9, 46.5, 46.8, 47.1, 46.7, 47.0, 47.3, 46.9, 47.2, 47.5, 47.1, 47.4, 47.7, 47.3, 47.6, 47.9, 47.5, 47.8, 48.1],
                dailyWorkloads: [6, 8, 11, 8, 10, 13, 11, 9, 12, 13, 11, 11, 14, 13, 12, 15, 13, 13, 15, 14, 13, 16, 15, 14, 17, 15, 15, 18, 16, 15, 18],
                weeklyData: {
                    week1: { avg: 45.4, workload: 45 },
                    week2: { avg: 46.1, workload: 62 },
                    week3: { avg: 46.8, workload: 67 },
                    week4: { avg: 47.2, workload: 71 },
                    week5: { avg: 47.6, workload: 43 }
                }
            };

            currentData.sort((a, b) => b.current - a.current);
            languageData.sort((a, b) => b.current - a.current);
            languageSpecialData.sort((a, b) => b.score - a.score);
            updatePageContent();
        }

        // 获取当前业务类型的数据
        function getCurrentBusinessData() {
            if (!dashboardData) {
                return currentBusinessType === 'language' ? languageData : currentData;
            }

            // 从JSON数据构建对比数据结构
            const currentAgents = dashboardData.currentPeriod?.agents || [];
            const previousAgents = dashboardData.previousPeriod?.agents || [];

            return currentAgents.map(currentAgent => {
                const previousAgent = previousAgents.find(p => p.name === currentAgent.name);
                const personalReport = dashboardData.personalReports?.[currentAgent.name];

                if (currentBusinessType === 'language') {
                    return {
                        name: currentAgent.name,
                        current: personalReport?.overview?.languageScore || currentAgent.score,
                        previous: personalReport?.previousOverview?.languageScore || (previousAgent?.score || currentAgent.score - 1),
                        currentCount: personalReport?.languageQuality?.totalIssues || 5,
                        previousCount: personalReport?.languageQuality?.previousTotalIssues || 6,
                        ranking: currentAgent.ranking,
                        qualityLevel: currentAgent.qualityLevel // 添加qualityLevel
                    };
                } else if (currentBusinessType === 'attitude') {
                    return {
                        name: currentAgent.name,
                        current: personalReport?.overview?.attitudeScore || currentAgent.score * 0.6,
                        previous: personalReport?.previousOverview?.attitudeScore || (previousAgent?.score || currentAgent.score - 1) * 0.6,
                        currentCount: personalReport?.serviceAttitude?.totalIssues || 3,
                        previousCount: personalReport?.serviceAttitude?.previousTotalIssues || 4,
                        ranking: currentAgent.ranking,
                        qualityLevel: currentAgent.qualityLevel // 添加qualityLevel
                    };
                } else {
                    // 全部业务
                    return {
                        name: currentAgent.name,
                        current: currentAgent.score,
                        previous: previousAgent?.score,
                        currentCount: currentAgent.orderCount,
                        previousCount: previousAgent?.orderCount || -1,
                        ranking: currentAgent.ranking,
                        qualityLevel: currentAgent.qualityLevel // 添加qualityLevel
                    };
                }
            });
        }

        // 获取当前业务类型的月度趋势数据
        function getCurrentMonthlyTrendData() {
            return currentBusinessType === 'language' ? languageMonthlyTrendData : monthlyTrendData;
        }

        // 更新页面内容
        function updatePageContent() {
            // 更新标题
            const titleSuffix = currentBusinessType === 'language' ? '' :
                currentBusinessType === 'attitude' ? '' : '';

            if (dashboardData && dashboardData.metadata) {
                document.querySelector('.header h1').textContent = dashboardData.metadata.title;
                document.querySelector('.header .subtitle').textContent = dashboardData.metadata.subtitle;
            } else {
                // 使用默认标题
                document.querySelector('.header h1').textContent = '消息量与客服人数分析' + titleSuffix;

            }

            // 更新统计数据（只有在有dashboardData时才更新）
            if (dashboardData) {
                updateStatistics();
                updateInsights();

                // 重新初始化所有图表和表格
                setTimeout(() => {
                    // 本周数据
                    initCurrentDistributionChart();
                    initCurrentRankingChart();
                    generateCurrentTable();

                    // 本周vs上周
                    updateComparisonStats(dashboardData.currentPeriod.overview, dashboardData.previousPeriod.overview);
                    generateComparisonTable();

                    // 规范用语图表
                    initLanguageCharts();
                    generateLanguageTable();

                    // 服务态度图表
                    initAttitudeCharts();
                    // generateAttitudeTable();

                    // 月度趋势
                    updateMonthlyTrendStats();
                    initMonthlyTrendCharts();

                    // 

                }, 100);
            }

            // 切换业务视图（无论是否有dashboardData都要切换）
            switchBusinessView(currentBusinessType);
        }

        function renderDailySummaryTable() {
            const tableBody = document.getElementById('dailySummaryTableBody');
            if (!tableBody) return;

            // 清空现有内容
            tableBody.innerHTML = '';

            // 检查数据是否存在
            if (!dashboardData || !dashboardData.sessionVsAgentCntByDay) {

                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">暂无数据</td></tr>';
                return;
            }

            const sessionData = dashboardData.sessionVsAgentCntByDay;
            const dates = sessionData.dates || [];
            const validCounts = sessionData.valid_session_counts || [];
            const invalidCounts = sessionData.invalid_session_counts || [];
            const agentCounts = sessionData.daily_agent_totals || [];  // 🎯 使用新的每日unique客服数据

            // 检查数据完整性
            if (dates.length === 0 || validCounts.length === 0) {
                console.warn('⚠️ 每日汇总表格：数据不完整');
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">数据不完整</td></tr>';
                return;
            }


            console.log('📊 每日unique客服数据:', agentCounts);

            // 🎯 Initialize weekly totals
            let weeklyTotalAgents = 0;
            let weeklyTotalValid = 0;
            let weeklyTotalInvalid = 0;

            // 🎯 Calculate overall weekly totals
            dates.forEach((date, dayIndex) => {
                if (dayIndex >= validCounts.length || dayIndex >= invalidCounts.length || dayIndex >= agentCounts.length) {
                    return;
                }

                const dayValidCounts = validCounts[dayIndex] || [];
                const dayInvalidCounts = invalidCounts[dayIndex] || [];
                const dailyUniqueAgents = agentCounts[dayIndex] || 0;  // 🎯 直接取每日unique客服数

                const totalValidSessions = dayValidCounts.reduce((sum, count) => sum + count, 0);
                const totalInvalidSessions = dayInvalidCounts.reduce((sum, count) => sum + count, 0);

                weeklyTotalAgents += dailyUniqueAgents;  // 🎯 累加每日unique客服数
                weeklyTotalValid += totalValidSessions;
                weeklyTotalInvalid += totalInvalidSessions;
            });

            // 为每天生成表格行
            dates.forEach((date, dayIndex) => {
                if (dayIndex >= validCounts.length || dayIndex >= invalidCounts.length || dayIndex >= agentCounts.length) {
                    console.warn(`⚠️ 第${dayIndex}天数据不完整，跳过`);
                    return;
                }

                // 计算当天的总计
                const dayValidCounts = validCounts[dayIndex] || [];
                const dayInvalidCounts = invalidCounts[dayIndex] || [];
                const dailyUniqueAgents = agentCounts[dayIndex] || 0;  // 🎯 直接取每日unique客服数（数字）

                // 汇总一天24小时的会话数据
                const totalValidSessions = dayValidCounts.reduce((sum, count) => sum + count, 0);
                const totalInvalidSessions = dayInvalidCounts.reduce((sum, count) => sum + count, 0);

                // 🎯 不再对客服数进行reduce，直接使用每日unique客服数
                const totalAgentCount = dailyUniqueAgents;

                // 计算工作负载（会话数/客服人数）
                const workload = totalAgentCount > 0 ?
                    ((totalValidSessions + totalInvalidSessions) / totalAgentCount).toFixed(1) + ' sessions/agent' :
                    '0 sessions/agent';



                // 创建表格行
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.style.transition = 'background-color 0.3s ease';

                // 鼠标悬停效果
                row.addEventListener('mouseenter', function () {
                    this.style.backgroundColor = '#f8f9fa';
                });
                row.addEventListener('mouseleave', function () {
                    this.style.backgroundColor = '';
                });

                row.innerHTML = `
                    <td style="padding: 12px 8px; text-align: center;">
                        <strong>${date}</strong>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500;">${totalAgentCount}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #4CAF50;">${totalValidSessions}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #FF9800;">${totalInvalidSessions}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #2196F3;">${workload}</td>
                `;

                tableBody.appendChild(row);
            });

            // 🎯 Add weekly total row (at the top)
            if (dates.length > 0) {
                const weeklyTotalWorkload = weeklyTotalAgents > 0 ?
                    ((weeklyTotalValid + weeklyTotalInvalid) / weeklyTotalAgents).toFixed(1) + ' sessions/agent' :
                    '0 sessions/agent';

                const summaryRow = document.createElement('tr');
                summaryRow.style.borderBottom = '1px solid #eee';
                summaryRow.style.transition = 'background-color 0.3s ease';

                // 鼠标悬停效果
                summaryRow.addEventListener('mouseenter', function () {
                    this.style.backgroundColor = '#f8f9fa';
                });
                summaryRow.addEventListener('mouseleave', function () {
                    this.style.backgroundColor = '';
                });

                summaryRow.innerHTML = `
                    <td style="padding: 12px 8px; text-align: center;">
                        <strong>Total</strong>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500;"></td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #4CAF50;">${weeklyTotalValid}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #FF9800;">${weeklyTotalInvalid}</td>
                    <td style="padding: 12px 8px; text-align: center; font-weight: 500; color: #2196F3;"></td>
                `;

                tableBody.appendChild(summaryRow);
            }
        }

        // 在页面加载完成后渲染表格
        document.querySelectorAll('.time-tabs .tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const dailySummarySection = document.getElementById('daily-summary-section');
                const dailySummaryContainer = document.getElementById('daily-summary-table-container');

                if (this.dataset.time === 'other') {
                    // 显示表格
                    if (dailySummarySection) dailySummarySection.style.display = 'block';
                    if (dailySummaryContainer) dailySummaryContainer.style.display = 'flex';

                    setTimeout(() => {
                        renderDailySummaryTable();
                    }, 600);
                } else {
                    // 隐藏表格
                    if (dailySummarySection) dailySummarySection.style.display = 'none';
                    if (dailySummaryContainer) dailySummaryContainer.style.display = 'none';
                }
            });
        });

        // 页面初始化时隐藏表格（因为默认不在"客服资源调度与利用率分析"tab）
        document.addEventListener('DOMContentLoaded', function () {
            const dailySummarySection = document.getElementById('daily-summary-section');
            const dailySummaryContainer = document.getElementById('daily-summary-table-container');

            // 初始隐藏
            if (dailySummarySection) dailySummarySection.style.display = 'none';
            if (dailySummaryContainer) dailySummaryContainer.style.display = 'none';

            // 检查当前活跃的tab
            const activeTab = document.querySelector('.time-tabs .tab.active');
            if (activeTab && activeTab.dataset.time === 'other') {
                // 如果初始就在"客服资源调度与利用率分析"tab，则显示表格
                if (dailySummarySection) dailySummarySection.style.display = 'block';
                if (dailySummaryContainer) dailySummaryContainer.style.display = 'flex';

                setTimeout(() => {
                    renderDailySummaryTable();
                }, 500);
            }
        });

        // 更新统计数据
        function updateStatistics() {
            if (!dashboardData) return;

            // 获取本周和上周数据
            const currentOverview = dashboardData.currentPeriod?.overview;
            const previousOverview = dashboardData.previousPeriod?.overview;
            if (!currentOverview || !previousOverview) return;

            // 更新本周数据统计卡片
            const currentCards = document.querySelectorAll('#current-content .comparison-card');
            if (currentCards.length >= 5) {
                currentCards[0].querySelector('.current-value').textContent = Math.min(7, currentOverview.agentCount);
                currentCards[1].querySelector('.current-value').textContent = currentOverview.totalOrders;
                currentCards[2].querySelector('.current-value').textContent = currentOverview.averageScore.toFixed(1);
                currentCards[3].querySelector('.current-value').textContent = currentOverview.firstResponseRate + '%';
                currentCards[4].querySelector('.current-value').textContent = currentOverview.responseIn30sRate + '%';
            }

            // 更新对比数据统计卡片
            updateComparisonStats(currentOverview, previousOverview);

            // 更新月度数据统计卡片
            const monthlyOverview = dashboardData.monthlyOverview || {
                totalMonthlyOrders: 310,
                monthlyAverageScore: 47.8,
                monthlyPassRate: 89.5,
                activeAgents: 13,
                improvementRate: 78.2
            };

            const monthlyCards = document.querySelectorAll('#monthly-content .comparison-card');
            if (monthlyCards.length >= 5) {
                const monthlyMultiplier = currentBusinessType === 'language' ? 0.7 : 1;
                monthlyCards[0].querySelector('.current-value').textContent = Math.floor(monthlyOverview.totalMonthlyOrders * monthlyMultiplier);
                monthlyCards[1].querySelector('.current-value').textContent = (monthlyOverview.monthlyAverageScore - (currentBusinessType === 'language' ? 1.0 : 0)).toFixed(1);
                monthlyCards[2].querySelector('.current-value').textContent = (monthlyOverview.monthlyFirstResponseRate - (currentBusinessType === 'language' ? 2.0 : 0)).toFixed(1) + '%';
                monthlyCards[3].querySelector('.current-value').textContent = monthlyOverview.activeAgents;
                monthlyCards[4].querySelector('.current-value').textContent = (monthlyOverview.improvementRate + (currentBusinessType === 'language' ? 5.0 : 0)).toFixed(1) + '%';
            }
        }

        // 更新对比统计数据
        function updateComparisonStats(currentOverview, previousOverview) {
            console.log('更新对比统计数据:', { currentOverview, previousOverview });

            if (!currentOverview || !previousOverview) {
                console.warn('缺少本周或上周数据，无法更新对比统计');
                return;
            }

            // 🎯 新增：获取本周和上周的日期范围，用于标题显示
            const currentPeriod = dashboardData.metadata?.periodInfo?.currentPeriod || '本周';
            const previousPeriod = dashboardData.metadata?.periodInfo?.previousPeriod || '上周';
            const titleSuffix = `${currentPeriod} vs ${previousPeriod}`;

            // 🎯 更新所有对比界面的图表标题
            updateComparisonTitles(titleSuffix);

            // 更新全部业务对比统计卡片
            const comparisonCards = document.querySelectorAll('#comparison-all-business-view .comparison-card');
            if (comparisonCards.length >= 5) {
                // 客服人员数
                updateComparisonCard(comparisonCards[0], currentOverview.agentCount, previousOverview.agentCount, false);

                // 质检工单数 - 使用真实的totalOrders
                updateComparisonCard(comparisonCards[1], currentOverview.totalOrders, previousOverview.totalOrders, true);

                // 平均得分
                updateComparisonCard(comparisonCards[2], currentOverview.averageScore, previousOverview.averageScore, true, 1);

                // 首响率
                updateComparisonCard(comparisonCards[3], currentOverview.firstResponseRate, previousOverview.firstResponseRate, true, 1, '%');

                // 响应30s应答率
                updateComparisonCard(comparisonCards[4], currentOverview.responseIn30sRate, previousOverview.responseIn30sRate, true, 1, '%');
            }

            // 更新规范用语对比统计
            updateLanguageComparisonStats(currentOverview, previousOverview);

            // 更新服务态度对比统计
            updateAttitudeComparisonStats(currentOverview, previousOverview);
        }

        function updateComparisonTitles(titleSuffix) {
            const chartTitles = document.querySelectorAll('#comparison-content .chart-title');

            chartTitles.forEach((title, index) => {
                // 获取原始文本，移除所有可能的后缀
                let originalText = title.textContent;

                // 移除所有可能的日期后缀和重复内容
                originalText = originalText.replace(/\s*\(.*\).*$/g, ''); // 移除括号及后面所有内容
                originalText = originalText.replace(/\s*\d{4}-\d{2}-\d{2}.*$/g, ''); // 移除日期及后面所有内容
                originalText = originalText.trim(); // 移除首尾空格

                switch (originalText) {
                    case '全部业务得分分布变化':
                        title.innerHTML = `全部业务得分分布变化<br>${titleSuffix}`;
                        break;
                    case '全部业务详细对比数据':
                        title.innerHTML = `全部业务详细对比数据<br>${titleSuffix}`;
                        break;
                    case '规范用语得分分布对比':
                        title.innerHTML = `规范用语得分分布对比<br>${titleSuffix}`;
                        break;
                    case '客服规范详细对比数据':
                        title.innerHTML = `客服规范详细对比数据<br>${titleSuffix}`;
                        break;
                    case '服务态度得分分布对比':
                        title.innerHTML = `服务态度得分分布对比<br>${titleSuffix}`;
                        break;
                    case '服务态度详细对比数据':
                        title.innerHTML = `服务态度详细对比数据<br>${titleSuffix}`;
                        break;
                    default:
                        // 对于其他标题，也添加换行
                        title.innerHTML = `${originalText}<br>${titleSuffix}`;
                        break;
                }
            });
        }

        // 修复规范用语对比统计
        function updateLanguageComparisonStats(currentOverview, previousOverview) {
            if (!dashboardData?.personalReports) {
                console.warn('缺少personalReports数据，无法更新规范用语对比');
                return;
            }

            const reports = dashboardData.personalReports;
            let currentIssues = 0, previousIssues = 0;
            let improvementCount = 0;
            let agentCount = 0;
            let previousAgentCount = 0;

            // ✅ 使用真实的工单总数，而不是个人报告数量
            const currentTotalOrders = currentOverview.totalOrders || 0;
            const previousTotalOrders = previousOverview.totalOrders || 0;

            Object.values(reports).forEach(report => {
                if (report.overview && report.languageQuality) {
                    // 统计本周数据
                    agentCount++;
                    currentIssues += report.languageQuality.totalIssues || 0;

                    // 统计上周数据（只统计真正有上周数据的客服）
                    if (report.previousOverview?.languageScore !== undefined) {
                        previousAgentCount++;
                        previousIssues += (report.languageQuality.previousTotalIssues || 0);

                        const currentScore = report.overview.languageScore || 0;
                        const previousScore = report.previousOverview.languageScore;
                        if (currentScore > previousScore) {
                            improvementCount++;
                        }
                    }
                }
            });

            // 🔧 直接使用 JSON 数据中的平均分，不再自己计算
            const currentAverage = currentOverview.languageAverageScore || currentOverview.realLanguageAverage || 0;
            const previousAverage = previousOverview.languageAverageScore || previousOverview.realLanguageAverage || 0;

            // 🔧 客服数量也直接使用 JSON 数据
            const finalCurrentAgentCount = currentOverview.languageAgentCount || agentCount;
            const finalPreviousAgentCount = previousOverview.languageAgentCount || previousOverview.agentCount || previousAgentCount;

            const languageCards = document.querySelectorAll('#comparison-language-business-view .comparison-card');
            if (languageCards.length >= 3) { // 🎯 改为3个卡片
                updateComparisonCard(languageCards[0], finalCurrentAgentCount, finalPreviousAgentCount, false);
                updateComparisonCard(languageCards[1], currentTotalOrders, previousTotalOrders, true, 0);
                updateComparisonCard(languageCards[2], currentAverage, previousAverage, true, 1);
            };
        }

        // 更新单个对比卡片
        function updateComparisonCard(card, currentValue, previousValue, showPercentChange = true, decimals = 0, suffix = '') {
            const currentDisplay = decimals > 0 ? currentValue.toFixed(decimals) : Math.round(currentValue);
            const previousDisplay = decimals > 0 ? previousValue.toFixed(decimals) : Math.round(previousValue);

            card.querySelector('.current-value').textContent = currentDisplay + suffix;
            card.querySelector('.previous-value').textContent = previousDisplay + suffix;

            const changeIndicator = card.querySelector('.change-indicator');
            if (currentValue === previousValue) {
                changeIndicator.textContent = '持平';
                changeIndicator.className = 'change-indicator change-neutral';
            } else if (showPercentChange) {
                const percentChange = ((currentValue - previousValue) / previousValue * 100);
                const changeText = (percentChange >= 0 ? '+' : '') + percentChange.toFixed(1) + '%';
                changeIndicator.textContent = changeText;
                changeIndicator.className = percentChange >= 0 ? 'change-indicator change-positive' : 'change-indicator change-negative';
            } else {
                const absoluteChange = currentValue - previousValue;
                const changeText = (absoluteChange >= 0 ? '+' : '') + absoluteChange;
                changeIndicator.textContent = changeText;
                changeIndicator.className = absoluteChange >= 0 ? 'change-indicator change-positive' : 'change-indicator change-negative';
            }
        }

        function updateAttitudeComparisonStats(currentOverview, previousOverview) {
            if (!dashboardData?.personalReports) {
                console.warn('缺少personalReports数据，无法更新服务态度对比');
                return;
            }

            const reports = dashboardData.personalReports;
            let currentIssues = 0, previousIssues = 0;
            let improvementCount = 0;
            let agentCount = 0;
            let previousAgentCount = 0;

            // ✅ 使用真实的工单总数
            const currentTotalOrders = currentOverview.totalOrders || 0;
            const previousTotalOrders = previousOverview.totalOrders || 0;

            Object.values(reports).forEach(report => {
                if (report.overview && report.serviceAttitude) {
                    // 统计本周数据
                    agentCount++;
                    currentIssues += report.serviceAttitude.totalIssues || 0;

                    // 统计上周数据（只统计真正有上周数据的客服）
                    if (report.previousOverview?.attitudeScore !== undefined) {
                        previousAgentCount++;
                        previousIssues += (report.serviceAttitude.previousTotalIssues || 0);

                        const currentScore = report.overview.attitudeScore || 0;
                        const previousScore = report.previousOverview.attitudeScore;
                        if (currentScore > previousScore) {
                            improvementCount++;
                        }
                    }
                }
            });

            // 🔧 直接使用 JSON 数据中的平均分，不再自己计算
            const currentAverage = currentOverview.attitudeAverageScore || currentOverview.realAttitudeAverage || 0;
            const previousAverage = previousOverview.attitudeAverageScore || previousOverview.realAttitudeAverage || 0;

            // 🔧 客服数量也直接使用 JSON 数据
            const finalCurrentAgentCount = currentOverview.attitudeAgentCount || agentCount;
            const finalPreviousAgentCount = previousOverview.attitudeAgentCount || previousOverview.agentCount || previousAgentCount;

            const currentFirstResponseRate = currentOverview.firstResponseRate;
            const previousFirstResponseRate = previousOverview.firstResponseRate;
            const currentResponseIn30sRate = currentOverview.responseIn30sRate;
            const previousResponseIn30sRate = previousOverview.responseIn30sRate;

            const attitudeCards = document.querySelectorAll('#comparison-attitude-business-view .comparison-card');
            if (attitudeCards.length >= 5) { // 🎯 现在有5个卡片了
                // 卡片0：客服人数
                updateComparisonCard(attitudeCards[0], finalCurrentAgentCount, finalPreviousAgentCount, false);

                // 卡片1：质检工单数
                updateComparisonCard(attitudeCards[1], currentTotalOrders, previousTotalOrders, true); // true表示需要显示百分比变化

                // 卡片2：平均得分
                updateComparisonCard(attitudeCards[2], currentAverage, previousAverage, true, 1); // 1为小数位数

                // 🎯 卡片3：首响率
                updateComparisonCard(attitudeCards[3], currentFirstResponseRate, previousFirstResponseRate, true, 1, '%');

                // 🎯 卡片4：响应30s应答率
                updateComparisonCard(attitudeCards[4], currentResponseIn30sRate, previousResponseIn30sRate, true, 1, '%');
            };
        }

        // 更新洞察内容
        function updateInsights() {
            if (!dashboardData || !dashboardData.insights) return;
        }

        // 标签切换功能
        function initTabSwitching() {
            // 时间标签切换
            document.querySelectorAll('.time-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    // 移除所有active类
                    const businessTabs = document.querySelector('.business-tabs');
                    document.querySelectorAll('.time-tabs .tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(c => c.classList.remove('active'));

                    // 添加active类到当前标签
                    this.classList.add('active');

                    // 显示对应内容
                    const timeType = this.dataset.time;
                    if (timeType === 'comparison') {
                        if (businessTabs) {
                            businessTabs.style.display = '';
                        }
                        document.getElementById('comparison-content').classList.add('active');
                        // 销毁所有图表后重新初始化
                        destroyAllCharts();
                        setTimeout(() => {
                            switchBusinessView(currentBusinessType);
                        }, 100);
                    } else if (timeType === 'current') {
                        if (businessTabs) {
                            businessTabs.style.display = '';
                        }
                        document.getElementById('current-content').classList.add('active');
                        // 销毁所有图表后重新初始化
                        destroyAllCharts();
                        setTimeout(() => {
                            switchBusinessView(currentBusinessType);
                        }, 100);
                    } else if (timeType === 'monthly') {
                        if (businessTabs) {
                            businessTabs.style.display = '';
                        }
                        document.getElementById('monthly-content').classList.add('active');
                        // 销毁所有图表后重新初始化
                        destroyAllCharts();
                        setTimeout(() => {
                            switchBusinessView(currentBusinessType);
                        }, 100);
                    } else if (timeType === 'other') {
                        if (businessTabs) {
                            businessTabs.style.display = 'none';
                        }
                        document.getElementById('other-content').classList.add('active');
                        setTimeout(() => {
                            renderMessagePeakChart();
                            renderMsgVsAgentTabs();
                            renderMsgVsAgentByDayChart(0);
                        }, 400);
                    } else if (timeType === 'withdrawal') {
                        if (businessTabs) {
                            businessTabs.style.display = 'none';
                        }
                        document.getElementById('withdrawal-content').classList.add('active');
                        setTimeout(() => {

                            initializeWithdrawalCharts();
                            // 出金审核详细数据
                            generateWithdrawalDetailsTableBody();
                        }, 400);
                    }
                });
            });

            // 业务标签切换
            document.querySelectorAll('.business-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.business-tabs .tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // 切换业务类型
                    const businessType = this.dataset.business;
                    currentBusinessType = businessType;
                    console.log('切换到业务类型:', businessType);

                    // 销毁所有图表
                    destroyAllCharts();

                    // 更新页面内容
                    updatePageContent();
                });
            });
        }



        // 图表配置
        Chart.defaults.font.family = 'Microsoft YaHei';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;

        // 初始化所有图表
        function initCharts() {
            initDistributionChart();
            generateComparisonTable();
        }

        // 得分分布变化图 - 修复版本：使用JSON中的真实数据
        function initDistributionChart() {
            destroyChart('distributionChart');

            const ctx = document.getElementById('distributionChart').getContext('2d');

            // ✅ 检查必要的数据是否存在
            if (!dashboardData) {
                console.error('❌ 得分分布图初始化失败：缺少dashboardData');
                showChartError(ctx.canvas.parentElement, '缺少基础数据');
                return;
            }

            const scoreRanges = [
                { range: '<35', min: 0, max: 35 },
                { range: '35-40', min: 35, max: 40 },
                { range: '40-45', min: 40, max: 45 },
                { range: '45-47', min: 45, max: 47 },
                { range: '47-49', min: 47, max: 49 },
                { range: '49-50', min: 49, max: 50 },
                { range: '50+', min: 50, max: 100 }
            ];

            let currentRanges = [0, 0, 0, 0, 0, 0, 0];
            let previousRanges = [0, 0, 0, 0, 0, 0, 0];

            // ✅ 第一步：统计本周分布（预期19人）
            console.log('=== 统计本周总分分布 ===');
            if (dashboardData.personalReports) {
                Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                    if (report.overview && report.overview.totalScore !== undefined) {
                        const score = report.overview.totalScore;

                        // 分类得分到对应区间
                        for (let i = 0; i < scoreRanges.length; i++) {
                            const range = scoreRanges[i];
                            if (range.max === 100 ? score >= range.min : (score >= range.min && score < range.max)) {
                                currentRanges[i]++;
                                break;
                            }
                        }
                    }
                });
            }

            // ✅ 第二步：统计上周分布（预期13人）
            console.log('=== 统计上周总分分布 ===');

            // 优先从previousPeriod.personalReports读取
            if (dashboardData.previousPeriod && dashboardData.previousPeriod.personalReports) {
                console.log('✅ 使用previousPeriod.personalReports数据源');
                const previousPersonalReports = dashboardData.previousPeriod.personalReports;
                console.log(`🔍 上周personalReports客服总数: ${Object.keys(previousPersonalReports).length}`);
                console.log(`🔍 上周personalReports客服名单: ${Object.keys(previousPersonalReports)}`);

                Object.entries(dashboardData.previousPeriod.personalReports).forEach(([agentName, report]) => {

                    console.log(`🔍 检查上周客服: ${agentName}`, {
                        hasOverview: !!report.overview,
                        hasTotalScore: report.overview?.totalScore !== undefined,
                        totalScore: report.overview?.totalScore
                    });
                    if (report.overview && report.overview.totalScore !== undefined) {
                        const score = report.overview.totalScore;
                        console.log(`✅ 上周客服总分: ${agentName}, 得分: ${score}`);

                        // 分类得分到对应区间
                        for (let i = 0; i < scoreRanges.length; i++) {
                            const range = scoreRanges[i];
                            if (range.max === 100 ? score >= range.min : (score >= range.min && score < range.max)) {
                                previousRanges[i]++;
                                break;
                            }
                        }
                    }
                });
            }
            // fallback: 使用本周的previousOverview
            else if (dashboardData.personalReports) {
                console.log('⚠️ 未找到previousPeriod.personalReports，使用fallback方式');
                Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                    if (report.previousOverview && report.previousOverview.totalScore !== undefined) {
                        const score = report.previousOverview.totalScore;
                        console.log(`✅ 上周客服总分(fallback): ${agentName}, 得分: ${score}`);

                        // 分类得分到对应区间
                        for (let i = 0; i < scoreRanges.length; i++) {
                            const range = scoreRanges[i];
                            if (range.max === 100 ? score >= range.min : (score >= range.min && score < range.max)) {
                                previousRanges[i]++;
                                break;
                            }
                        }
                    }
                });
            } else {
                console.warn('❌ 无法找到上周总分数据');
            }

            // ✅ 第三步：验证和输出结果
            const currentTotal = currentRanges.reduce((a, b) => a + b, 0);
            const previousTotal = previousRanges.reduce((a, b) => a + b, 0);

            console.log('=== 📊 总分分布统计结果 ===');
            console.log(`📈 本周分布:`, currentRanges, `总计: ${currentTotal}`);
            console.log(`📉 上周分布:`, previousRanges, `总计: ${previousTotal}`);

            // 验证数据
            if (currentTotal === 0 && previousTotal === 0) {
                console.error('❌ 本周和上周都没有数据');
                showChartError(ctx.canvas.parentElement, '本周和上周都没有有效数据');
                return;
            }

            if (currentTotal === 19) {
                console.log('✅ 本周总分人数正确（19人）');
            } else {
                console.warn(`⚠️ 本周总分人数异常：预期19人，实际${currentTotal}人`);
            }

            if (previousTotal === 13) {
                console.log('✅ 上周总分人数正确（13人）');
            } else {
                console.warn(`⚠️ 上周总分人数异常：预期13人，实际${previousTotal}人`);
            }

            const labels = scoreRanges.map(item => item.range);

            // ✅ 第四步：创建图表
            chartInstances['distributionChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `This Week (Total ${currentTotal})`,
                            data: currentRanges,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: `Last Week (Total ${previousTotal})`,
                            data: previousRanges,
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: '#764ba2',
                            borderWidth: 2,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Score Range'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of People'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return `Score Range: ${context[0].label}`;
                                },
                                label: function (context) {
                                    const datasetLabel = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${datasetLabel}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });

            console.log('✅ 总分分布图已更新，本周' + currentTotal + '人，上周' + previousTotal + '人');
        }

        // 辅助函数：显示图表错误信息
        function showChartError(container, message) {
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 350px; color: #f44336; text-align: center;">
                    <div>
                        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">⚠️ 数据加载失败</div>
                        <div>${message}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 10px;">请检查数据完整性</div>
                    </div>
                </div>
            `;
        }

        function generateComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            let data = getCurrentBusinessData();
            // Limit to top 7 by current score for readability
            data = data.sort((a, b) => b.current - a.current).slice(0, 7);

            // 🎯 获取本周和上周的真实总工单数
            const currentTotalOrders = dashboardData?.currentPeriod?.overview?.totalOrders || 0;

            // 🎯 获取上周总工单数的多种方式
            let previousTotalOrders = null;

            // 方法1：从previousPeriod.overview获取
            if (dashboardData?.previousPeriod?.overview?.totalOrders) {
                previousTotalOrders = dashboardData.previousPeriod.overview.totalOrders;
                console.log('✅ 从previousPeriod.overview获取上周总工单数:', previousTotalOrders);
            }
            // 方法2：从previousPeriod直接获取
            else if (dashboardData?.previousPeriod?.totalOrders) {
                previousTotalOrders = dashboardData.previousPeriod.totalOrders;
                console.log('✅ 从previousPeriod获取上周总工单数:', previousTotalOrders);
            }
            // 方法3：从previousPeriod.agents累计计算
            else if (dashboardData?.previousPeriod?.agents) {
                previousTotalOrders = dashboardData.previousPeriod.agents.reduce((sum, agent) => sum + (agent.orderCount || 0), 0);
                console.log('✅ 从previousPeriod.agents累计计算上周总工单数:', previousTotalOrders);
            }
            // 方法4：从metadata获取
            else if (dashboardData?.metadata?.previousPeriodTotalOrders) {
                previousTotalOrders = dashboardData.metadata.previousPeriodTotalOrders;
                console.log('✅ 从metadata获取上周总工单数:', previousTotalOrders);
            }
            // 兜底：设为0
            else {
                previousTotalOrders = 0;
                console.warn('⚠️ 未找到上周总工单数，设为0');
            }

            console.log('📊 工单数对比:', {
                本周总数: currentTotalOrders,
                上周总数: previousTotalOrders
            });

            // 只保留本周有数据的客服
            const comparableData = data.filter(agent => {
                const hasCurrent = agent.current !== undefined && agent.current !== null && agent.current !== "-";
                return hasCurrent && agent.currentCount !== -1;
            });

            // 分层排序：有上周数据的在上面，没有上周数据的在下面
            comparableData.sort((a, b) => {
                const aHasPrevious = a.previous !== undefined && a.previous !== null && a.previous !== "-" && a.previousCount !== -1;
                const bHasPrevious = b.previous !== undefined && b.previous !== null && b.previous !== "-" && b.previousCount !== -1;

                if (aHasPrevious !== bHasPrevious) {
                    return aHasPrevious ? -1 : 1;
                }

                if (aHasPrevious && bHasPrevious) {
                    return b.current - a.current;
                }

                return b.current - a.current;
            });

            comparableData.forEach(agent => {
                const row = tbody.insertRow();

                const hasPrevious = agent.previous !== undefined && agent.previous !== null && agent.previous !== "-";
                const hasPreviousCount = agent.previousCount !== undefined && agent.previousCount !== -1;

                const scoreChange = hasPrevious ? agent.current - agent.previous : 0;

                // 🎯 根据业务类型决定显示内容
                if (currentBusinessType === 'language') {
                    // 规范用语业务：显示问题数/工单数、占比和占比变化

                    // 从 dashboardData 获取真实问题数据
                    const personalReport = dashboardData?.personalReports?.[agent.name];
                    const currentIssueCount = personalReport?.languageQuality?.totalIssues || 0;
                    const previousIssueCount = personalReport?.languageQuality?.previousTotalIssues || 0;

                    // 计算本周和上周问题工单占比
                    const currentRatio = agent.currentCount > 0 ?
                        ((currentIssueCount / agent.currentCount) * 100) : 0;

                    const previousRatio = (hasPreviousCount && agent.previousCount > 0) ?
                        ((previousIssueCount / agent.previousCount) * 100) : 0;

                    // 🎯 计算占比变化
                    let ratioChange = 0;
                    let ratioChangeDisplay = "-";
                    let ratioChangeClass = "stable";

                    if (hasPreviousCount && previousRatio > 0) {
                        ratioChange = currentRatio - previousRatio;
                        ratioChangeDisplay = (ratioChange > 0 ? "+" : "") + ratioChange.toFixed(1) + "%";
                        ratioChangeClass = ratioChange > 0 ? "decline" : ratioChange < 0 ? "improvement" : "stable";
                    }

                    const previousOrdersDisplay = hasPreviousCount ? agent.previousCount : "-";

                    row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">${agent.current.toFixed(1)}</span></td>
                    <td><span class="score-cell">${hasPrevious ? agent.previous.toFixed(1) : "-"}</span></td>
                    <td><span class="${hasPrevious ? (scoreChange > 0 ? 'improvement' : scoreChange < 0 ? 'decline' : 'stable') : "stable"}">
                        ${hasPrevious ? (scoreChange > 0 ? '+' : '') : "-"}${hasPrevious ? scoreChange.toFixed(1) : ""}
                    </span></td>
                        <td><strong>${currentIssueCount}/${agent.currentCount}</strong></td>
                        <td><strong>${currentRatio.toFixed(1)}%</strong></td>
                        <td><strong>${hasPreviousCount ? previousIssueCount + '/' + previousOrdersDisplay : "-/-"}</strong></td>
                        <td><strong>${hasPreviousCount ? previousRatio.toFixed(1) + "%" : "-"}</strong></td>
                        <td><span class="${ratioChangeClass}">
                            ${ratioChangeDisplay}
                    </span></td>
                `;
                } else if (currentBusinessType === 'attitude') {
                    // 服务态度业务：显示问题数/工单数、占比和占比变化

                    // 从 dashboardData 获取真实问题数据
                    const personalReport = dashboardData?.personalReports?.[agent.name];
                    const currentIssueCount = personalReport?.serviceAttitude?.totalIssues || 0;
                    const previousIssueCount = personalReport?.serviceAttitude?.previousTotalIssues || 0;

                    // 计算本周和上周问题工单占比
                    const currentRatio = agent.currentCount > 0 ?
                        ((currentIssueCount / agent.currentCount) * 100) : 0;

                    const previousRatio = (hasPreviousCount && agent.previousCount > 0) ?
                        ((previousIssueCount / agent.previousCount) * 100) : 0;

                    // 🎯 计算占比变化
                    let ratioChange = 0;
                    let ratioChangeDisplay = "-";
                    let ratioChangeClass = "stable";

                    if (hasPreviousCount && previousRatio > 0) {
                        ratioChange = currentRatio - previousRatio;
                        ratioChangeDisplay = (ratioChange > 0 ? "+" : "") + ratioChange.toFixed(1) + "%";
                        ratioChangeClass = ratioChange > 0 ? "decline" : ratioChange < 0 ? "improvement" : "stable";
                    }

                    const previousOrdersDisplay = hasPreviousCount ? agent.previousCount : "-";

                    row.innerHTML = `
                        <td><span class="agent-name-no-link">${agent.name}</span></td>
                        <td><span class="score-cell">${agent.current.toFixed(1)}</span></td>
                        <td><span class="score-cell">${hasPrevious ? agent.previous.toFixed(1) : "-"}</span></td>
                        <td><span class="${hasPrevious ? (scoreChange > 0 ? 'improvement' : scoreChange < 0 ? 'decline' : 'stable') : "stable"}">
                            ${hasPrevious ? (scoreChange > 0 ? '+' : '') : "-"}${hasPrevious ? scoreChange.toFixed(1) : ""}
                        </span></td>
                        <td><strong>${currentIssueCount}/${agent.currentCount}</strong></td>
                        <td><strong>${currentRatio.toFixed(1)}%</strong></td>
                        <td><strong>${hasPreviousCount ? previousIssueCount + '/' + previousOrdersDisplay : "-/-"}</strong></td>
                        <td><strong>${hasPreviousCount ? previousRatio.toFixed(1) + "%" : "-"}</strong></td>
                        <td><span class="${ratioChangeClass}">
                            ${ratioChangeDisplay}
                        </span></td>
                    `;
                } else {
                    // 全部业务：保持原有显示（6列）
                    const currentOrdersDisplay = agent.currentCount;
                    const previousOrdersDisplay = hasPreviousCount ? `${agent.previousCount}` : "-";

                    row.innerHTML = `
                        <td><span class="agent-name-no-link">${agent.name}</span></td>
                        <td><span class="score-cell">${agent.current.toFixed(1)}</span></td>
                        <td><span class="score-cell">${hasPrevious ? agent.previous.toFixed(1) : "-"}</span></td>
                        <td><span class="${hasPrevious ? (scoreChange > 0 ? 'improvement' : scoreChange < 0 ? 'decline' : 'stable') : "stable"}">
                            ${hasPrevious ? (scoreChange > 0 ? '+' : '') : "-"}${hasPrevious ? scoreChange.toFixed(1) : ""}
                        </span></td>
                        <td><strong>${currentOrdersDisplay}</strong></td>
                        <td><strong>${previousOrdersDisplay}</strong></td>
                    `;
                }
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function () {
            await loadData(); // 先加载数据
            initTabSwitching();

            // 确保初始状态正确显示
            updatePageContent(); // 更新页面内容，包括调用switchBusinessView

            // 如果当前是本周数据tab，则初始化图表
            const activeTimeTab = document.querySelector('.time-tabs .tab.active');
            if (!activeTimeTab || activeTimeTab.dataset.time === 'current') {
                setTimeout(() => {
                    initCurrentCharts(); // 默认加载本周数据图表
                }, 200);
            }
        });

        // 初始化月度趋势图表
        function initMonthlyCharts() {
            initWeeklyComparisonChart();
            generateMonthlyTrendTable();
            updateMonthlyTrendStats();
        }

        // 周度表现对比图
        function initWeeklyComparisonChart() {
            destroyChart('weeklyComparisonChart');

            const ctx = document.getElementById('weeklyComparisonChart').getContext('2d');

            const trendData = getCurrentMonthlyTrendData();
            const weeklyData = trendData.weeklyData;
            console.log("--------------")
            console.log(weeklyData);
            console.log("--------------")
            chartInstances['weeklyComparisonChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Average Score',
                            data: [weeklyData.week1.avg, weeklyData.week2.avg, weeklyData.week3.avg, weeklyData.week4.avg],
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Tickets',
                            data: [weeklyData.week1.workload, weeklyData.week2.workload, weeklyData.week3.workload, weeklyData.week4.workload],
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: '#764ba2',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 30,
                            max: 50,
                            title: {
                                display: true,
                                text: 'Average Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Tickets'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成月度趋势表格
        function generateMonthlyTrendTable() {
            const tbody = document.getElementById('monthlyTrendTableBody');
            tbody.innerHTML = '';

            // 检查数据是否存在
            if (!dashboardData?.monthlyTrend?.monthlyTrendSummary?.agentsMonthlyTrends) {
                console.warn('缺少agentsMonthlyTrends数据');
                return;
            }
            const totalOrders = dashboardData.monthlyOverview.totalMonthlyOrders || 0;
            let agentsMonthlyTrends = dashboardData.monthlyTrend.monthlyTrendSummary.agentsMonthlyTrends;
            console.log('agentsMonthlyTrends:', agentsMonthlyTrends);

            // 🎯 按均分排序（从高到低）
            agentsMonthlyTrends.sort((a, b) => {
                // 计算A的均分
                const aWeeklyScores = a.weekly_scores || [0, 0, 0, 0];
                const aValidScores = aWeeklyScores.filter(score => score > 0);
                const aAverage = aValidScores.length > 0 ?
                    (aValidScores.reduce((sum, score) => sum + score, 0) / aValidScores.length) : 0;

                // 计算B的均分
                const bWeeklyScores = b.weekly_scores || [0, 0, 0, 0];
                const bValidScores = bWeeklyScores.filter(score => score > 0);
                const bAverage = bValidScores.length > 0 ?
                    (bValidScores.reduce((sum, score) => sum + score, 0) / bValidScores.length) : 0;

                return bAverage - aAverage;  // 降序排列（均分高的在前）
            });

            agentsMonthlyTrends.slice(0, 7).forEach(agent => {
                const row = tbody.insertRow();

                // 直接使用 agent.weekly_scores，确保数据完整性
                const weeklyScores = agent.weekly_scores || [0, 0, 0, 0];

                // 调试输出
                console.log(`${agent.name} 的周度得分:`, weeklyScores);

                // 确保数组长度为4
                while (weeklyScores.length < 4) {
                    weeklyScores.push(0);
                }

                const validScores = weeklyScores.filter(score => score > 0);
                const averageScore = validScores.length > 0 ?
                    (validScores.reduce((sum, score) => sum + score, 0) / validScores.length) : 0;

                row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">
                        ${averageScore > 0 ? averageScore.toFixed(1) : '-'}
                    </span></td>
                    <td><span class="score-cell">${weeklyScores[0] > 0 ? weeklyScores[0].toFixed(1) : '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[1] > 0 ? weeklyScores[1].toFixed(1) : '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[2] > 0 ? weeklyScores[2].toFixed(1) : '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[3] > 0 ? weeklyScores[3].toFixed(1) : '-'}</span></td>
                    <td><strong>${agent.total_workload}</strong></td>
                `;
            });
        }
        // 初始化本周数据图表
        function initCurrentCharts() {
            initCurrentDistributionChart();
            initCurrentRankingChart();
            generateCurrentTable();
        }

        // 本周数据 - 得分分布图
        function initCurrentDistributionChart() {
            destroyChart('currentDistributionChart');

            const ctx = document.getElementById('currentDistributionChart').getContext('2d');

            // 始终基于实际客服数据计算分布，确保一致性
            const scoreRanges = [
                { range: '30-35', min: 30, max: 35, color: '#f44336' },
                { range: '35-40', min: 35, max: 40, color: '#f44336' },
                { range: '40-45', min: 40, max: 45, color: '#f44336' },
                { range: '45-47', min: 45, max: 47, color: '#FF9800' },
                { range: '47-49', min: 47, max: 49, color: '#2196F3' },
                { range: '49-50', min: 49, max: 50, color: '#4CAF50' },
                { range: '50+', min: 50, max: 100, color: '#4CAF50' }
            ];

            // Use the same top 7 agents as Score Ranking for consistency
            let data = getCurrentBusinessData();
            data = data.sort((a, b) => b.current - a.current).slice(0, 7);

            const rangeData = scoreRanges.map(range => {
                const agentsInRange = data.filter(agent =>
                    agent.current >= range.min &&
                    (range.max === 100 ? agent.current >= range.min : agent.current < range.max)
                );
                return {
                    ...range,
                    count: agentsInRange.length,
                    names: agentsInRange.map(a => a.name)
                };
            });

            chartInstances['currentDistributionChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rangeData.map(r => r.range),
                    datasets: [{
                        label: 'Number of Agents',
                        data: rangeData.map(r => r.count),
                        backgroundColor: rangeData.map(r => r.color),
                        borderColor: rangeData.map(r => r.color),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        barThickness: 40,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Score Range',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Agents',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    const index = context[0].dataIndex;
                                    const range = rangeData[index];
                                    return `Score Range: ${range.range}`;
                                },
                                label: function (context) {
                                    const index = context.dataIndex;
                                    const range = rangeData[index];
                                    if (range.count === 0) return 'No agents in this range';
                                    const names = range.names.join(', ');
                                    return `Agents (${range.count}): ${names}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 本周数据 - 客服评分排名图
        function initCurrentRankingChart() {
            destroyChart('currentRankingChart');

            const ctx = document.getElementById('currentRankingChart').getContext('2d');

            // Use Top 7 agents by current score for readability
            let data = getCurrentBusinessData();
            data = data.sort((a, b) => b.current - a.current).slice(0, 7);

            // 为每个客服分配固定颜色
            function getAgentColor(agentName) {
                const colorMap = {
                    'Jessica': '#FF6384',
                    'daria': '#36A2EB',
                    'Miya': '#FFCE56',
                    'Euphemia': '#4BC0C0',
                    'lemon': '#9966FF',
                    'Arya': '#FF9F40',
                    'Zara': '#FF6B9D',
                    'Gloria': '#C9CBCF',
                    'Sara': '#FFB366',
                    'Hera': '#66FFB2',
                    'clara': '#B366FF',
                    'Lucas': '#FF6666',
                    'zhenhou': '#FFAA66',
                    'jackkob	': '#00C49F'
                };
                return colorMap[agentName] || '#999999';
            }

            chartInstances['currentRankingChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(agent => agent.name === 'jackkob	' || agent.name === 'jackkob	' ? 'jackkob	' : agent.name),
                    datasets: [{
                        label: 'This Week Score',
                        data: data.map(agent => agent.current),
                        backgroundColor: data.map(agent => getAgentColor(agent.name === 'jackkob	' || agent.name === 'jackkob	' ? 'jackkob	' : agent.name)),
                        borderColor: data.map(agent => getAgentColor(agent.name === 'jackkob	' || agent.name === 'jackkob	' ? 'jackkob	' : agent.name)),
                        borderRadius: 6,
                        borderSkipped: false,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 50,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const agent = data[context.dataIndex];
                                    const name = (agent.name === 'jackkob	' || agent.name === 'jackkob	') ? 'jackkob	' : agent.name;
                                    return `${name}: ${agent.current.toFixed(1)} (${agent.currentCount} tickets)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成本周数据表格
        function generateCurrentTable() {
            const tbody = document.getElementById('currentTableBody');
            tbody.innerHTML = '';

            const data = getCurrentBusinessData();

            // 为每个客服计算总分，并创建包含所有信息的新数组
            const dataWithTotalScores = data.map(agent => {
                const realAgentData = dashboardData?.currentPeriod?.agents?.find(a => a.name === agent.name);
                const aiScore = agent.current;
                const aiOrderCount = agent.currentCount;
                // Fake Manual QA data when missing
                const humanScore = (realAgentData && typeof realAgentData.human_score === 'number') ? realAgentData.human_score : (Math.random() * 3 + 44);
                const humanOrderCount = (realAgentData && typeof realAgentData.human_order_count === 'number') ? realAgentData.human_order_count : Math.floor(Math.random() * 10) + 5;
                const totalScore = aiScore + humanScore;

                return {
                    ...agent,
                    aiScore,
                    aiOrderCount,
                    humanScore,
                    humanOrderCount,
                    totalScore,
                    realAgentData
                };
            });

            // 🎯 按总分降序排序（分数高的排在前面）
            dataWithTotalScores.sort((a, b) => b.totalScore - a.totalScore);

            // 获取总的质检工单数
            const totalQualityCheckOrders = dashboardData?.currentPeriod?.overview?.totalOrders || 79;

            // Populate fake response time table data if missing
            const responseBody = document.getElementById('responseTimeTableBody');
            if (responseBody && responseBody.children.length === 0) {
                const sampleAgents = dataWithTotalScores.slice(0, 7).map(a => a.name);
                responseBody.innerHTML = '';
                sampleAgents.forEach(name => {
                    const fr30 = (80 + Math.random() * 15).toFixed(1);
                    const fr60 = Math.max(fr30, (90 + Math.random() * 8)).toFixed(1);
                    const fr3m = Math.max(fr60, (97 + Math.random() * 3)).toFixed(1);
                    const fr5m = '100.0';
                    const in30 = (70 + Math.random() * 20).toFixed(1);
                    const in60 = Math.max(in30, (85 + Math.random() * 10)).toFixed(1);
                    const in3m = Math.max(in60, (93 + Math.random() * 5)).toFixed(1);
                    const in5m = '100.0';
                    const total = Math.floor(200 + Math.random() * 200);
                    const valid = Math.floor(total * (0.85 + Math.random() * 0.1));
                    const invalid = total - valid;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${name}</td><td>${fr30}%</td><td>${fr60}%</td><td>${fr3m}%</td><td>${fr5m}%</td><td>${in30}%</td><td>${in60}%</td><td>${in3m}%</td><td>${in5m}%</td><td>${total}</td><td>${valid}</td><td>${invalid}</td>`;
                    responseBody.appendChild(tr);
                });
            }

            const highWorkloadBody = document.getElementById('highWorkloadTableBody');
            if (highWorkloadBody && highWorkloadBody.children.length === 0) {
                const sampleAgents = dataWithTotalScores.slice(0, 7).map(a => a.name);
                highWorkloadBody.innerHTML = '';
                sampleAgents.forEach(name => {
                    const fr30 = (60 + Math.random() * 20).toFixed(1);
                    const fr60 = Math.max(fr30, (80 + Math.random() * 15)).toFixed(1);
                    const fr3m = Math.max(fr60, (90 + Math.random() * 8)).toFixed(1);
                    const fr5m = Math.max(fr3m, (97 + Math.random() * 3)).toFixed(1);
                    const in30 = (50 + Math.random() * 25).toFixed(1);
                    const in60 = Math.max(in30, (75 + Math.random() * 15)).toFixed(1);
                    const in3m = Math.max(in60, (88 + Math.random() * 8)).toFixed(1);
                    const in5m = Math.max(in3m, (95 + Math.random() * 5)).toFixed(1);
                    const total = Math.floor(40 + Math.random() * 60);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${name}</td><td>${fr30}%</td><td>${fr60}%</td><td>${fr3m}%</td><td>${fr5m}%</td><td>${in30}%</td><td>${in60}%</td><td>${in3m}%</td><td>${in5m}%</td><td>${total}</td>`;
                    highWorkloadBody.appendChild(tr);
                });
            }

            // Limit to top 7 agents
            dataWithTotalScores.slice(0, 7).forEach((agent, index) => {
                const row = tbody.insertRow();

                // 直接使用JSON中的质量等级，而不是通过分数计算
                const qualityLevel = agent.qualityLevel || '一般';

                // 根据质量等级设置CSS类
                let scoreClass;
                switch (qualityLevel) {
                    case '优秀': scoreClass = 'improvement'; break;
                    case '良好': scoreClass = 'stable'; break;
                    case '一般': scoreClass = 'stable'; break;
                    case '待改进': scoreClass = 'decline'; break;
                    default: scoreClass = 'stable';
                }

                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td><span class="agent-name" data-agent="${agent.name.replace(/"/g, '&quot;')}">${(agent.name === 'jackkob	' || agent.name === 'jackkob	') ? 'jackkob	' : agent.name}</span></td>
                    <td><span class="score-cell" style="font-weight: bold;">${agent.totalScore.toFixed(1)}</span></td>
                    <td><span class="score-cell">${agent.aiScore.toFixed(1)}</span></td>
                    <td><strong>${agent.aiOrderCount}</strong></td>
                    <td><span class="score-cell">${agent.humanScore > 0 ? agent.humanScore.toFixed(1) : '-'}</span></td>
                    <td><strong>${agent.humanOrderCount > 0 ? agent.humanOrderCount : '-'}</strong></td>
                `;
            });
        }
        // 切换业务视图
        function switchBusinessView(businessType) {
            // 本周数据视图切换
            const allBusinessView = document.getElementById('all-business-view');
            const languageBusinessView = document.getElementById('language-business-view');
            const attitudeBusinessView = document.getElementById('attitude-business-view');

            // 本周 vs 上周视图切换
            const comparisonAllBusinessView = document.getElementById('comparison-all-business-view');
            const comparisonLanguageBusinessView = document.getElementById('comparison-language-business-view');
            const comparisonAttitudeBusinessView = document.getElementById('comparison-attitude-business-view');

            // 本月趋势视图切换
            const monthlyAllBusinessView = document.getElementById('monthly-all-business-view');
            const monthlyLanguageBusinessView = document.getElementById('monthly-language-business-view');
            const monthlyAttitudeBusinessView = document.getElementById('monthly-attitude-business-view');

            if (businessType === 'language') {
                // 切换到规范用语视图
                if (allBusinessView) {
                    allBusinessView.style.display = 'none';
                    languageBusinessView.style.display = 'block';
                    if (attitudeBusinessView) attitudeBusinessView.style.display = 'none';
                }
                // 隐藏响应时间相关表格
                const responseTimeTable = document.getElementById('response-time-table');
                const highWorkloadTable = document.getElementById('high-workload-table');
                if (responseTimeTable) responseTimeTable.style.display = 'none';
                if (highWorkloadTable) highWorkloadTable.style.display = 'none';
                if (comparisonAllBusinessView) {
                    comparisonAllBusinessView.style.display = 'none';
                    comparisonLanguageBusinessView.style.display = 'block';
                    if (comparisonAttitudeBusinessView) comparisonAttitudeBusinessView.style.display = 'none';
                }
                if (monthlyAllBusinessView) {
                    monthlyAllBusinessView.style.display = 'none';
                    monthlyLanguageBusinessView.style.display = 'block';
                    if (monthlyAttitudeBusinessView) monthlyAttitudeBusinessView.style.display = 'none';
                }

                // 初始化规范用语专项图表
                setTimeout(() => {
                    const activeTimeTab = document.querySelector('.time-tabs .tab.active');
                    if (activeTimeTab) {
                        const timeType = activeTimeTab.dataset.time;
                        if (timeType === 'current') {
                            initLanguageCharts();
                            generateLanguageTable();
                        } else if (timeType === 'comparison') {
                            initLanguageComparisonCharts();
                            generateLanguageComparisonTable();
                        } else if (timeType === 'monthly') {
                            initLanguageMonthlyCharts();
                            generateLanguageMonthlyTable();
                        }
                    }
                }, 100);
            } else if (businessType === 'attitude') {
                // 切换到服务态度视图
                if (allBusinessView) {
                    allBusinessView.style.display = 'none';
                    languageBusinessView.style.display = 'none';
                    if (attitudeBusinessView) attitudeBusinessView.style.display = 'block';
                }
                // 隐藏响应时间相关表格
                const responseTimeTable = document.getElementById('response-time-table');
                const highWorkloadTable = document.getElementById('high-workload-table');
                if (responseTimeTable) responseTimeTable.style.display = 'none';
                if (highWorkloadTable) highWorkloadTable.style.display = 'none';
                if (comparisonAllBusinessView) {
                    comparisonAllBusinessView.style.display = 'none';
                    comparisonLanguageBusinessView.style.display = 'none';
                    if (comparisonAttitudeBusinessView) comparisonAttitudeBusinessView.style.display = 'block';
                }
                if (monthlyAllBusinessView) {
                    monthlyAllBusinessView.style.display = 'none';
                    monthlyLanguageBusinessView.style.display = 'none';
                    if (monthlyAttitudeBusinessView) monthlyAttitudeBusinessView.style.display = 'block';
                }

                // 初始化服务态度专项图表
                setTimeout(() => {
                    const activeTimeTab = document.querySelector('.time-tabs .tab.active');
                    if (activeTimeTab) {
                        const timeType = activeTimeTab.dataset.time;
                        if (timeType === 'current') {
                            initAttitudeCharts();
                            generateAttitudeTable();
                        } else if (timeType === 'comparison') {
                            initAttitudeComparisonCharts();
                            generateAttitudeComparisonTable();
                        } else if (timeType === 'monthly') {
                            initAttitudeMonthlyCharts();
                            generateAttitudeMonthlyTable();
                        }
                    }
                }, 100);
            } else {
                // 切换到全部业务视图
                if (allBusinessView) {
                    allBusinessView.style.display = 'block';
                    languageBusinessView.style.display = 'none';
                    if (attitudeBusinessView) attitudeBusinessView.style.display = 'none';
                }
                // 显示响应时间相关表格
                const responseTimeTable = document.getElementById('response-time-table');
                const highWorkloadTable = document.getElementById('high-workload-table');
                if (responseTimeTable) responseTimeTable.style.display = 'block';
                if (highWorkloadTable) highWorkloadTable.style.display = 'block';
                if (comparisonAllBusinessView) {
                    comparisonAllBusinessView.style.display = 'block';
                    comparisonLanguageBusinessView.style.display = 'none';
                    if (comparisonAttitudeBusinessView) comparisonAttitudeBusinessView.style.display = 'none';
                }
                if (monthlyAllBusinessView) {
                    monthlyAllBusinessView.style.display = 'block';
                    monthlyLanguageBusinessView.style.display = 'none';
                    if (monthlyAttitudeBusinessView) monthlyAttitudeBusinessView.style.display = 'none';
                }

                // 重新初始化全部业务图表
                setTimeout(() => {
                    const activeTimeTab = document.querySelector('.time-tabs .tab.active');
                    if (activeTimeTab) {
                        const timeType = activeTimeTab.dataset.time;
                        if (timeType === 'current') {
                            initCurrentCharts();
                        } else if (timeType === 'comparison') {
                            initCharts();
                        } else if (timeType === 'monthly') {
                            initMonthlyCharts();
                        }
                    }
                }, 100);
            }
        }

        // 初始化规范用语专项图表
        function initLanguageCharts() {
            initLanguageRankingChart();
            // initLanguageDistributionChart();
            updateLanguagePassRate();
        }

        // 更新规范用语达标率
        function updateLanguagePassRate() {
            // 计算达标率（得分≥18分的比例）
            const passCount = languageSpecialData.filter(agent => agent.score >= 18).length;
            const passRate = (passCount / languageSpecialData.length * 100);

            // 直接使用JSON中的totalIssues字段计算规范用语问题总数
            let totalIssues = 0;
            if (dashboardData && dashboardData.personalReports) {
                // 遍历所有客服的personalReports数据
                Object.values(dashboardData.personalReports).forEach(report => {
                    if (report.languageQuality && report.languageQuality.totalIssues) {
                        totalIssues += report.languageQuality.totalIssues;
                    }
                });
            } else {
                // 如果没有JSON数据，使用映射后的issues计算（后备方案）
                totalIssues = languageSpecialData.reduce((total, agent) => {
                    return total + Object.values(agent.issues).reduce((sum, count) => sum + count, 0);
                }, 0);
            }

            // 计算平均得分
            const averageScore = languageSpecialData.reduce((sum, agent) => sum + agent.score, 0) / languageSpecialData.length;

            // 使用100条记录的真实平均分（如果有的话）
            const realAverageScore = dashboardData?.currentPeriod?.overview?.realLanguageAverage || averageScore;

            // 直接使用JSON中的agentCount，与全部业务界面保持一致
            const agentCount = dashboardData?.currentPeriod?.overview?.agentCount || languageSpecialData.length;

            console.log('规范用语问题数计算：', {
                totalIssues,
                personalReportsCount: dashboardData?.personalReports ? Object.keys(dashboardData.personalReports).length : 0,
                hasPersonalReports: !!dashboardData?.personalReports
            });

            // 更新本周数据页面的规范用语统计卡片
            const languageCards = document.querySelectorAll('#language-business-view .comparison-card');
            if (languageCards.length >= 3) {
                const totalOrders = dashboardData?.currentPeriod?.overview?.totalOrders ?? 0;
                languageCards[0].querySelector('.current-value').textContent = Math.min(7, agentCount); // 显示Top-7数量
                languageCards[1].querySelector('.current-value').textContent = totalOrders; // 使用真实平均得分
                languageCards[2].querySelector('.current-value').textContent = realAverageScore.toFixed(1); // 使用真实平均得分
            }

            // 更新语言质量问题卡片
            updateLanguageIssueCards();
        }

        // 更新语言质量问题卡片
        function updateLanguageIssueCards() {
            // 统计各种问题的总数（包括所有类型和"其他"）
            const issueStats = {
                '服务禁语': 0,        // A01
                '重复性描述': 0,      // A02  
                '不礼貌用词': 0,      // A03
                '缺少开首语': 0,      // A04
                '缺少结束语': 0,      // A05
                '错别字': 0,          // A06
                '语句不通': 0,        // A07
                '其他': 0             // A08
            };

            // 从languageSpecialData统计问题
            languageSpecialData.forEach(agent => {
                Object.entries(agent.issues).forEach(([issue, count]) => {
                    if (issueStats.hasOwnProperty(issue)) {
                        issueStats[issue] += count;
                    }
                });
            });

            // 总的检查次数（13个客服）
            const totalChecks = languageSpecialData.length;

            // 生成问题卡片HTML
            const issueCards = Object.entries(issueStats).map(([issue, count]) => {
                let rateClass = 'error-rate-low';
                if (count >= 5) rateClass = 'error-rate-high';
                else if (count >= 3) rateClass = 'error-rate-medium';

                const issueMap = {
                    '服务禁语': 'Prohibited Phrases',
                    '重复性描述': 'Repetitive Description',
                    '不礼貌用词': 'Impolite Words',
                    '缺少开首语': 'Missing Greeting',
                    '缺少结束语': 'Missing Closing',
                    '错别字': 'Typos',
                    '语句不通': 'Incoherent Sentences',
                    '其他': 'Other'
                };

                const title = issueMap[issue] || issue;

                return `
                    <div class="issue-card">
                        <div class="issue-title">${title}</div>
                        <div class="issue-count ${rateClass}">${count}</div>
                    </div>
                `;
            }).join('');
            console.log(issueCards);
            // 更新DOM
            const languageIssuesGrid = document.getElementById('languageIssuesGrid');
            if (languageIssuesGrid) {
                languageIssuesGrid.innerHTML = issueCards;
            }
        }

        // 初始化服务态度专项图表
        function initAttitudeCharts() {
            initAttitudeRankingChart();
            updateAttitudeStats();
        }

        // 更新服务态度统计数据
        function updateAttitudeStats() {
            // 使用 attitudeSummary 的数据
            const attitudeSummary = jsonData.attitudeSummary;

            const totalOrders = dashboardData?.currentPeriod?.overview?.totalOrders ?? 0;
            // 更新本周数据页面的服务态度统计卡片
            const attitudeCards = document.querySelectorAll('#attitude-business-view .comparison-card');
            if (attitudeCards.length >= 5) {
                attitudeCards[0].querySelector('.current-value').textContent = Math.min(7, attitudeSummary.agentCount);
                attitudeCards[1].querySelector('.current-value').textContent = totalOrders;
                attitudeCards[2].querySelector('.current-value').textContent = attitudeSummary.averageScore;
                attitudeCards[3].querySelector('.current-value').textContent = attitudeSummary.firstResponseRate + '%';
                attitudeCards[4].querySelector('.current-value').textContent = attitudeSummary.responseIn30sRate + '%';
            }

            // 更新服务态度问题卡片
            updateAttitudeIssueCards();
        }

        // 更新服务态度问题卡片
        function updateAttitudeIssueCards() {
            // 只保留三个问题
            const issueStats = {
                '响应超时': 0,
                '服务语气不佳': 0,
                '情绪安抚不足': 0
            };
            // 从attitudeSpecialData统计问题
            attitudeSpecialData.forEach(agent => {
                Object.entries(agent.issues).forEach(([issue, count]) => {
                    if (issueStats.hasOwnProperty(issue)) {
                        issueStats[issue] += count;
                    }
                });
            });
            // 总的检查次数（13个客服）
            const totalChecks = attitudeSpecialData.length;
            // 生成问题卡片HTML
            const issueCards = Object.entries(issueStats).map(([issue, count]) => {
                const errorRate = ((count / totalChecks) * 100).toFixed(1);
                let rateClass = 'error-rate-low';
                if (count >= 5) rateClass = 'error-rate-high';
                else if (count >= 3) rateClass = 'error-rate-medium';
                const map = {
                    '响应超时': 'Response Timeout',
                    '服务语气不佳': 'Poor Service Tone',
                    '情绪安抚不足': 'Insufficient Emotional Support'
                };
                const title = map[issue] || issue;
                return `
                    <div class="issue-card">
                        <div class="issue-title">${title}</div>
                        <div class="issue-count ${rateClass}">${count}</div>
                        <div class="issue-rate">${errorRate}% error rate</div>
                    </div>
                `;
            }).join('');
            // 更新DOM
            const attitudeIssuesGrid = document.getElementById('attitudeIssuesGrid');
            if (attitudeIssuesGrid) {
                attitudeIssuesGrid.innerHTML = issueCards;
            }
        }




        // 服务态度得分排名图
        function initAttitudeRankingChart() {
            destroyChart('attitudeRankingChart');

            const ctx = document.getElementById('attitudeRankingChart').getContext('2d');

            // 数据验证和调试
            console.log('Raw attitudeSpecialData:', attitudeSpecialData);

            // 按得分排序，确保score是数字
            let sortedData = [...attitudeSpecialData]
                .filter(agent => agent && typeof agent.score === 'number' && !isNaN(agent.score))
                .sort((a, b) => b.score - a.score);

            // Limit to top 7
            sortedData = sortedData.slice(0, 7);

            console.log('Sorted attitudeSpecialData:', sortedData);

            if (sortedData.length === 0) {
                console.error('没有有效的服务态度数据');
                return;
            }

            // 动态计算最大值
            const maxScore = Math.max(...sortedData.map(agent => agent.score));
            const xAxisMax = Math.max(30, Math.ceil(maxScore * 1.1));

            // 生成颜色映射
            const agentColorMap = generateAgentColorMap(attitudeSpecialData, 'attitude');

            chartInstances['attitudeRankingChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(agent => agent.name),
                    datasets: [{
                        label: 'Service Attitude Score',
                        data: sortedData.map(agent => Number(agent.score)),
                        backgroundColor: sortedData.map(agent => agentColorMap[agent.name] || '#4CAF50'),
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: xAxisMax,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 生成服务态度表格
        function generateAttitudeTable() {
            const overallBody = document.getElementById('attitudeOverallTableBody');
            const positiveBody = document.getElementById('attitudePositiveTableBody');
            const negativeBody = document.getElementById('attitudeNegativeTableBody');
            const naturalBody = document.getElementById('attitudeNaturalTableBody');

            // 清空所有表格
            overallBody.innerHTML = '';
            positiveBody.innerHTML = '';
            negativeBody.innerHTML = '';
            naturalBody.innerHTML = '';

            // 异步加载数据
            setTimeout(() => {
                // 从jsonData获取客服数据
                const agents = jsonData.currentPeriod.agents || [];

                // 🎯 修复：正确计算各情绪类型的真实工单总数
                let overallTotalOrders = null;
                let positiveTotalOrders = null;
                let negativeTotalOrders = null;
                let neutralTotalOrders = null;

                // 方法1：优先从预计算的情绪类型总数获取
                if (jsonData.emotionTypeTotals) {
                    console.log('✅ 使用预计算的真实情绪类型总数');
                    overallTotalOrders = jsonData.emotionTypeTotals.overall;
                    positiveTotalOrders = jsonData.emotionTypeTotals.positive;
                    negativeTotalOrders = jsonData.emotionTypeTotals.negative;
                    neutralTotalOrders = jsonData.emotionTypeTotals.neutral;

                    console.log('各情绪类型工单总数:', {
                        overall: overallTotalOrders,
                        positive: positiveTotalOrders,
                        negative: negativeTotalOrders,
                        neutral: neutralTotalOrders
                    });
                }
                // 方法2：从conversations数组中实时统计各情绪类型工单数
                else if (jsonData.conversations && Array.isArray(jsonData.conversations)) {
                    console.log('📊 从conversations数组统计各情绪类型工单数');
                    const conversations = jsonData.conversations;

                    overallTotalOrders = conversations.length;
                    positiveTotalOrders = conversations.filter(conv => conv.emotion === 'positive').length;
                    negativeTotalOrders = conversations.filter(conv => conv.emotion === 'negative').length;
                    neutralTotalOrders = conversations.filter(conv => conv.emotion === 'neutral').length;

                    console.log('从conversations统计的各情绪类型工单总数:', {
                        overall: overallTotalOrders,
                        positive: positiveTotalOrders,
                        negative: negativeTotalOrders,
                        neutral: neutralTotalOrders
                    });
                }
                // 方法3：从各客服的detailedStats中累加统计
                else {
                    console.log('🔄 从客服detailedStats累加统计各情绪类型工单数');
                    overallTotalOrders = 0;
                    positiveTotalOrders = 0;
                    negativeTotalOrders = 0;
                    neutralTotalOrders = 0;

                    agents.forEach(agent => {
                        const detailedStats = agent.detailedStats || {};
                        overallTotalOrders += (detailedStats.overall?.orderCount || 0);
                        positiveTotalOrders += (detailedStats.positive?.orderCount || 0);
                        negativeTotalOrders += (detailedStats.negative?.orderCount || 0);
                        neutralTotalOrders += (detailedStats.neutral?.orderCount || 0);
                    });

                    console.log('从detailedStats累加的各情绪类型工单总数:', {
                        overall: overallTotalOrders,
                        positive: positiveTotalOrders,
                        negative: negativeTotalOrders,
                        neutral: neutralTotalOrders
                    });
                }

                // 计算每个客服在不同情绪类型下的得分和指标
                const agentScores = agents.map(agent => {
                    // 获取详细统计数据
                    const overallStats = agent.detailedStats?.overall || {};
                    const positiveStats = agent.detailedStats?.positive || {};
                    const negativeStats = agent.detailedStats?.negative || {};
                    const neutralStats = agent.detailedStats?.neutral || {};

                    return {
                        name: agent.name,
                        overall: {
                            courtesy: overallStats.averageCourtesyScore || 0,
                            comfort: overallStats.averageComfortScore || 0,
                            totalOrders: overallStats.orderCount || 0,
                            responseTime: overallStats.averageResponseTimeScore || 0,
                            attitudeTotal: overallStats.averageServiceAttitudeScore || 0,
                            firstResponseRate: overallStats.firstResponseRate || 0,
                            avgFirstResponseTime: overallStats.avgFirstResponseTime || 0,
                            avgResponseTime: overallStats.avgResponseTime || 0,
                            response30sRate: overallStats.response30sRate || 0
                        },
                        positive: {
                            courtesy: positiveStats.averageCourtesyScore || 0,
                            comfort: positiveStats.averageComfortScore || 0,
                            totalOrders: positiveStats.orderCount || 0,
                            responseTime: positiveStats.averageResponseTimeScore || 0,
                            attitudeTotal: positiveStats.averageServiceAttitudeScore || 0,
                            firstResponseRate: positiveStats.firstResponseRate || 0,
                            avgFirstResponseTime: positiveStats.avgFirstResponseTime || 0,
                            avgResponseTime: positiveStats.avgResponseTime || 0,
                            response30sRate: positiveStats.response30sRate || 0
                        },
                        negative: {
                            courtesy: negativeStats.averageCourtesyScore || 0,
                            comfort: negativeStats.averageComfortScore || 0,
                            totalOrders: negativeStats.orderCount || 0,
                            responseTime: negativeStats.averageResponseTimeScore || 0,
                            attitudeTotal: negativeStats.averageServiceAttitudeScore || 0,
                            firstResponseRate: negativeStats.firstResponseRate || 0,
                            avgFirstResponseTime: negativeStats.avgFirstResponseTime || 0,
                            avgResponseTime: negativeStats.avgResponseTime || 0,
                            response30sRate: negativeStats.response30sRate || 0
                        },
                        neutral: {
                            courtesy: neutralStats.averageCourtesyScore || 0,
                            comfort: neutralStats.averageComfortScore || 0,
                            totalOrders: neutralStats.orderCount || 0,
                            responseTime: neutralStats.averageResponseTimeScore || 0,
                            attitudeTotal: neutralStats.averageServiceAttitudeScore || 0,
                            firstResponseRate: neutralStats.firstResponseRate || 0,
                            avgFirstResponseTime: neutralStats.avgFirstResponseTime || 0,
                            avgResponseTime: neutralStats.avgResponseTime || 0,
                            response30sRate: neutralStats.response30sRate || 0
                        }
                    };
                });

                // 生成表格行的函数
                function generateRow(agentName, stats, index, totalOrders) {
                    // 🎯 修复：按照新的HTML表头顺序重新排列列
                    return `
                            <td>${index + 1}</td>                                    <!-- 第1列：排名 -->
                            <td><span class="agent-name-no-link">${agentName}</span></td>  <!-- 第2列：客服姓名 -->
                            <td>${stats.courtesy.toFixed(1)}</td>                   <!-- 第3列：礼貌得分 -->
                            <td>${stats.comfort.toFixed(1)}</td>                    <!-- 第4列：安抚得分 -->
                            <td>${stats.responseTime.toFixed(1)}</td>               <!-- 第5列：响应时间得分 -->
                            <td><strong>${stats.attitudeTotal.toFixed(1)}</strong></td>  <!-- 第6列：服务态度总分 -->
                            <td>${stats.firstResponseRate.toFixed(1)}</td>          <!-- 第7列：首响率(%) -->
                            <td>${stats.avgFirstResponseTime.toFixed(1)}</td>       <!-- 第8列：平均首响时间(s) -->
                            <td>${stats.avgResponseTime.toFixed(1)}</td>            <!-- 第9列：平均响应时间(s) -->
                            <td>${stats.response30sRate.toFixed(1)}</td>            <!-- 第10列：30s应答率(%) -->
                            <td><strong>${stats.totalOrders}</strong></td>              <!-- 第11列：质检工单数量(抽样/总数) -->
                        `;
                }


                // 填充Overall表格
                agentScores.sort((a, b) => b.overall.attitudeTotal - a.overall.attitudeTotal).slice(0, 7).forEach((agent, index) => {
                    const row = overallBody.insertRow();
                    row.innerHTML = generateRow(agent.name, agent.overall, index, overallTotalOrders);
                });

                // 填充Positive表格
                const positiveAgents = agentScores.filter(agent => agent.positive.attitudeTotal > 0);
                positiveAgents.sort((a, b) => b.positive.attitudeTotal - a.positive.attitudeTotal).slice(0, 7).forEach((agent, index) => {
                    const row = positiveBody.insertRow();
                    row.innerHTML = generateRow(agent.name, agent.positive, index, positiveTotalOrders);
                });

                // 填充Negative表格
                const negativeAgents = agentScores.filter(agent => agent.negative.attitudeTotal > 0);
                negativeAgents.sort((a, b) => b.negative.attitudeTotal - a.negative.attitudeTotal).slice(0, 7).forEach((agent, index) => {
                    const row = negativeBody.insertRow();
                    row.innerHTML = generateRow(agent.name, agent.negative, index, negativeTotalOrders);
                });

                // 填充Neutral表格
                const neutralAgents = agentScores.filter(agent => agent.neutral.attitudeTotal > 0);
                neutralAgents.sort((a, b) => b.neutral.attitudeTotal - a.neutral.attitudeTotal).slice(0, 7).forEach((agent, index) => {
                    const row = naturalBody.insertRow();
                    row.innerHTML = generateRow(agent.name, agent.neutral, index, neutralTotalOrders);
                });

            }, 500); // 模拟加载延迟
        }
        // 规范用语得分排名图
        function initLanguageRankingChart() {
            destroyChart('languageRankingChart');

            const ctx = document.getElementById('languageRankingChart').getContext('2d');

            // 数据验证和调试
            console.log('Raw languageSpecialData:', languageSpecialData);

            // 按得分排序，确保score是数字
            let sortedData = [...languageSpecialData]
                .filter(agent => agent && typeof agent.score === 'number' && !isNaN(agent.score))
                .sort((a, b) => b.score - a.score);

            // Limit to top 7
            sortedData = sortedData.slice(0, 7);

            console.log('Sorted languageSpecialData:', sortedData);

            if (sortedData.length === 0) {
                console.error('没有有效的规范用语数据');
                return;
            }

            // 动态计算最大值
            const maxScore = Math.max(...sortedData.map(agent => agent.score));
            const xAxisMax = Math.max(20, Math.ceil(maxScore * 1.1));

            // 生成颜色映射
            const agentColorMap = generateAgentColorMap(languageSpecialData, 'language');

            chartInstances['languageRankingChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedData.map(agent => agent.name),
                    datasets: [{
                        label: 'Standard Language Score',
                        data: sortedData.map(agent => Number(agent.score)),
                        backgroundColor: sortedData.map(agent => agentColorMap[agent.name] || '#4CAF50'),
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: xAxisMax,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Score'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // 规范用语得分分布图
        function initLanguageDistributionChart() {
            destroyChart('languageDistributionChart');

            const ctx = document.getElementById('languageDistributionChart').getContext('2d');

            const scoreDistribution = {
                '18-20分(优秀)': languageSpecialData.filter(a => a.score >= 18).length,
                '16-17分(良好)': languageSpecialData.filter(a => a.score >= 16 && a.score < 18).length,
                '14-15分(一般)': languageSpecialData.filter(a => a.score >= 14 && a.score < 16).length,
                '<14分(待改进)': languageSpecialData.filter(a => a.score < 14).length
            };

            // 确保所有数据都显示，包括0值
            const labels = Object.keys(scoreDistribution);
            const dataValues = Object.values(scoreDistribution);

            chartInstances['languageDistributionChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#f44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                generateLabels: function (chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, index) => {
                                            const value = data.datasets[0].data[index];
                                            return {
                                                text: `${label}: ${value}人`,
                                                fillStyle: data.datasets[0].backgroundColor[index],
                                                strokeStyle: data.datasets[0].backgroundColor[index],
                                                lineWidth: 2,
                                                hidden: false, // 始终显示所有标签
                                                index: index
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }

        // 2. 修改generateLanguageTable函数
        function generateLanguageTable() {
            const tbody = document.getElementById('languageTableBody');
            tbody.innerHTML = '';

            const sortedData = [...languageSpecialData]
                .sort((a, b) => b.score - a.score)
                .slice(0, 7);

            // 🎯 获取规范用语的总工单数（从统计卡片中获取）
            const totalOrders = dashboardData?.currentPeriod?.overview?.totalOrders || 79; // 使用质检工单数作为总数

            sortedData.forEach((agent, index) => {
                const row = tbody.insertRow();

                // 🔧 直接从dashboardData获取真实工单数，而不是从getCurrentBusinessData()
                const realAgentData = dashboardData?.currentPeriod?.agents?.find(a => a.name === agent.name);
                const realOrderCount = realAgentData ? realAgentData.orderCount : 1;

                row.innerHTML = `
                <td>${index + 1}</td>
                <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><strong>${realOrderCount}</strong></td>
                    <td><strong>${agent.score.toFixed(1)}</strong></td>
                <td><span class="issue-indicator ${agent.issues.服务禁语 ? 'issue-yes' : 'issue-no'}">${agent.issues.服务禁语 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.重复性描述 ? 'issue-yes' : 'issue-no'}">${agent.issues.重复性描述 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.不礼貌用词 ? 'issue-yes' : 'issue-no'}">${agent.issues.不礼貌用词 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.缺少开首语 ? 'issue-yes' : 'issue-no'}">${agent.issues.缺少开首语 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.缺少结束语 ? 'issue-yes' : 'issue-no'}">${agent.issues.缺少结束语 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.错别字 ? 'issue-yes' : 'issue-no'}">${agent.issues.错别字 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.语句不通 ? 'issue-yes' : 'issue-no'}">${agent.issues.语句不通 ? '✕' : '✓'}</span></td>
                <td><span class="issue-indicator ${agent.issues.其他 ? 'issue-yes' : 'issue-no'}">${agent.issues.其他 ? '✕' : '✓'}</span></td>
            `;
            });
        }

        // 3. 同样修改规范用语对比表格的generateLanguageComparisonTable函数
        function generateLanguageComparisonTable() {
            const tbody = document.getElementById('languageComparisonTableBody');
            tbody.innerHTML = '';

            if (!dashboardData || !dashboardData.personalReports) return;

            // 从JSON数据构建对比数据
            const comparisonData = [];
            Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                if (report.overview && report.languageQuality) {
                    // 🎯 获取工单数据 - 使用和全部业务一样的数据源
                    const currentAgentData = dashboardData.currentPeriod?.agents?.find(a => a.name === agentName);
                    const previousAgentData = dashboardData.previousPeriod?.agents?.find(a => a.name === agentName);

                    comparisonData.push({
                        name: agentName,
                        currentScore: report.overview.languageScore,
                        previousScore: report.previousOverview?.languageScore || -1,
                        currentIssueCount: report.languageQuality.totalIssues || 0,
                        previousIssueCount: report.languageQuality.previousTotalIssues || 0,
                        // 🎯 添加工单数据
                        currentOrders: currentAgentData?.orderCount || 0,
                        previousOrders: previousAgentData?.orderCount || -1
                    });
                }
            });

            // 按本周得分排序
            comparisonData.sort((a, b) => {
                const aHasPrevious = a.previousScore !== -1;
                const bHasPrevious = b.previousScore !== -1;

                if (aHasPrevious !== bHasPrevious) {
                    return aHasPrevious ? -1 : 1;
                }

                return b.currentScore - a.currentScore;
            });

            comparisonData
                .sort((a, b) => b.currentScore - a.currentScore)
                .slice(0, 7)
                .forEach(agent => {
                    const row = tbody.insertRow();

                    const scoreChange = agent.previousScore !== -1 ? agent.currentScore - agent.previousScore : 0;

                    // 🎯 计算本周问题工单占比：问题数/工单数
                    const currentRatio = agent.currentOrders > 0 ?
                        ((agent.currentIssueCount / agent.currentOrders) * 100) : 0;

                    // 🎯 计算上周问题工单占比
                    const previousRatio = (agent.previousOrders !== -1 && agent.previousOrders > 0) ?
                        ((agent.previousIssueCount / agent.previousOrders) * 100) : 0;

                    // 🎯 计算占比变化（百分点变化）
                    let ratioChange = 0;
                    let ratioChangeDisplay = "-";
                    let ratioChangeClass = "stable";

                    if (agent.previousOrders !== -1 && previousRatio > 0) {
                        ratioChange = currentRatio - previousRatio;
                        ratioChangeDisplay = (ratioChange > 0 ? "+" : "") + ratioChange.toFixed(1) + "%";
                        ratioChangeClass = ratioChange > 0 ? "decline" : ratioChange < 0 ? "improvement" : "stable";
                    }

                    // 🎯 上周数据显示处理
                    const previousIssueDisplay = agent.previousIssueCount !== undefined ? agent.previousIssueCount : "-";
                    const previousOrderDisplay = agent.previousOrders !== -1 ? agent.previousOrders : "-";

                    row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">${agent.currentScore.toFixed(1)}</span></td>
                    <td><span class="score-cell">${agent.previousScore === -1 ? "-" : agent.previousScore.toFixed(1)}</span></td>
                    <td><span class="${agent.previousScore === -1 ? 'stable' : scoreChange > 0 ? 'improvement' : scoreChange < 0 ? 'decline' : 'stable'}">
                        ${agent.previousScore === -1 ? "-" : (scoreChange > 0 ? '+' : '') + scoreChange.toFixed(1)}
                    </span></td>
                    <td><strong>${agent.currentIssueCount}/${agent.currentOrders}</strong></td>
                    <td><strong>${currentRatio.toFixed(1)}%</strong></td>
                    <td><strong>${previousIssueDisplay}/${previousOrderDisplay}</strong></td>
                    <td><strong>${agent.previousOrders !== -1 ? previousRatio.toFixed(1) + "%" : "-"}</strong></td>
                    <td><span class="${ratioChangeClass}">
                        ${ratioChangeDisplay}
                    </span></td>
            `;
                });
        }

        // 初始化规范用语对比图表
        function initLanguageComparisonCharts() {
            initLanguageScoreComparisonChart();
        }

        // 规范用语得分分布对比图 - 修复版本
        function initLanguageScoreComparisonChart() {
            destroyChart('languageScoreComparisonChart');

            const ctx = document.getElementById('languageScoreComparisonChart').getContext('2d');

            const scoreRanges = ['<14', '14-15', '16-17', '18-20'];

            let currentDistribution = [0, 0, 0, 0];
            let previousDistribution = [0, 0, 0, 0];

            if (dashboardData) {

                // ✅ 第一步：统计本周所有客服（预期19人）
                console.log('=== 统计本周规范用语分布 ===');
                if (dashboardData.personalReports) {
                    Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                        if (report.overview && report.overview.languageScore !== undefined) {
                            const currentScore = report.overview.languageScore;
                            console.log(`✅ 本周客服: ${agentName}, 规范用语得分: ${currentScore}`);

                            // 分类本周得分
                            if (currentScore >= 18) {
                                currentDistribution[3]++;        // 18-20分
                            } else if (currentScore >= 16) {
                                currentDistribution[2]++;        // 16-17分  
                            } else if (currentScore >= 14) {
                                currentDistribution[1]++;        // 14-15分
                            } else {
                                currentDistribution[0]++;        // <14分
                            }
                        }
                    });
                }

                // ✅ 第二步：统计上周所有客服（预期13人）
                console.log('=== 统计上周规范用语分布 ===');

                // 优先从previousPeriod.personalReports读取
                if (dashboardData.previousPeriod && dashboardData.previousPeriod.personalReports) {
                    console.log('✅ 使用previousPeriod.personalReports数据源');
                    Object.entries(dashboardData.previousPeriod.personalReports).forEach(([agentName, report]) => {
                        if (report.overview && report.overview.languageScore !== undefined) {
                            const previousScore = report.overview.languageScore;
                            console.log(`✅ 上周客服: ${agentName}, 规范用语得分: ${previousScore}`);

                            // 分类上周得分
                            if (previousScore >= 18) {
                                previousDistribution[3]++;       // 18-20分
                            } else if (previousScore >= 16) {
                                previousDistribution[2]++;       // 16-17分
                            } else if (previousScore >= 14) {
                                previousDistribution[1]++;       // 14-15分
                            } else {
                                previousDistribution[0]++;       // <14分
                            }
                        }
                    });
                }
                // fallback: 如果没有单独的previousPeriod数据，使用本周的previousOverview
                else if (dashboardData.personalReports) {
                    console.log('⚠️ 未找到previousPeriod.personalReports，使用fallback方式');
                    Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                        if (report.previousOverview && report.previousOverview.languageScore !== undefined) {
                            const previousScore = report.previousOverview.languageScore;
                            console.log(`✅ 上周客服(fallback): ${agentName}, 规范用语得分: ${previousScore}`);

                            // 分类上周得分
                            if (previousScore >= 18) {
                                previousDistribution[3]++;       // 18-20分
                            } else if (previousScore >= 16) {
                                previousDistribution[2]++;       // 16-17分
                            } else if (previousScore >= 14) {
                                previousDistribution[1]++;       // 14-15分
                            } else {
                                previousDistribution[0]++;       // <14分
                            }
                        }
                    });
                } else {
                    console.warn('❌ 无法找到上周数据');
                }

            } else {
                console.error('❌ dashboardData不存在');
                // 使用默认数据
                currentDistribution = [1, 3, 4, 2];
                previousDistribution = [0, 2, 3, 1];
            }

            // ✅ 第三步：验证和输出结果
            const currentTotal = currentDistribution.reduce((a, b) => a + b, 0);
            const previousTotal = previousDistribution.reduce((a, b) => a + b, 0);

            // 验证数据是否符合预期
            if (currentTotal === 19) {
                console.log('✅ 本周人数正确（19人）');
            } else {
                console.warn(`⚠️ 本周人数异常：预期19人，实际${currentTotal}人`);
            }

            if (previousTotal === 13) {
                console.log('✅ 上周人数正确（13人）');
            } else {
                console.warn(`⚠️ 上周人数异常：预期13人，实际${previousTotal}人`);
            }

            // ✅ 第四步：构建图表数据
            const datasets = [
                {
                    label: `This Week (Total ${currentTotal})`,
                    data: currentDistribution,
                    backgroundColor: 'rgba(76, 175, 80, 0.8)',
                    borderColor: '#4CAF50',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ];

            // 添加上周数据集
            if (previousTotal > 0) {
                datasets.push({
                    label: `Last Week (Total ${previousTotal})`,
                    data: previousDistribution,
                    backgroundColor: 'rgba(255, 152, 0, 0.8)',
                    borderColor: '#FF9800',
                    borderWidth: 2,
                    borderRadius: 6
                });
                console.log(`✅ 图表将显示：本周${currentTotal}人，上周${previousTotal}人`);
            } else {
                console.log('⚠️ 上周无数据，图表只显示本周分布');
            }

            // ✅ 第五步：创建图表
            chartInstances['languageScoreComparisonChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scoreRanges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Score Range'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of People'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return `Score Range: ${context[0].label}`;
                                },
                                label: function (context) {
                                    const datasetLabel = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${datasetLabel}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // 初始化规范用语月度图表
        function initLanguageMonthlyCharts() {
            initLanguageDailyScoreTrendChart();
            initLanguageIssueMonthlyTrendChart();
            generateLanguageMonthlyTable();
            updateLanguageMonthlyStats();
        }

        // 规范用语每日得分趋势图
        // 规范用语每日得分趋势图
        function initLanguageDailyScoreTrendChart() {
            destroyChart('languageDailyScoreTrendChart');

            const ctx = document.getElementById('languageDailyScoreTrendChart').getContext('2d');

            // 🎯 获取每周数据并计算问题出现率百分比
            const weeklyData = dashboardData.monthlyTrend.monthlyTrendSummary.languageMonthlyTrends.weeklyData;
            // Normalize week labels to English (e.g., '第1周' -> 'Week 1')
            const weeks = weeklyData.map(w => {
                const val = w.week;
                if (typeof val === 'string') {
                    return val.replace('第', 'Week ').replace('周', '');
                }
                return val;
            });
            const avgScores = weeklyData.map(w => w.average_score);

            // 🎯 关键修改：计算问题出现率百分比，而不是绝对数量
            const issueRates = weeklyData.map(w => {
                const totalIssues = w.total_issues || 0;
                const workload = w.workload || 1; // 避免除以0
                return (totalIssues / workload) * 100; // 转换为百分比
            });

            console.log('🎯 规范用语周度数据 (百分比版本):', { weeks, avgScores, issueRates });

            chartInstances['languageDailyScoreTrendChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Weekly Average Score',
                            data: avgScores,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Weekly Issue Rate (%)',
                            data: issueRates, // 🎯 使用百分比数据
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: '#f44336',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: Math.min(...avgScores) - 1,
                            max: Math.max(...avgScores) + 1,
                            title: {
                                display: true,
                                text: 'Average Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Issue Rate (%)'
                            },
                            ticks: {
                                stepSize: 0.5, // 🎯 设置步长为0.5%
                                callback: function (value) {
                                    return value.toFixed(1) + '%'; // 🎯 添加%符号
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    if (context.datasetIndex === 1) { // 问题出现率数据集
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 规范用语问题类型月度趋势图
        function initLanguageIssueMonthlyTrendChart() {
            destroyChart('languageIssueMonthlyTrendChart');

            const ctx = document.getElementById('languageIssueMonthlyTrendChart').getContext('2d');

            // 动态获取数据
            let weeks = [];
            let datasets = [];

            if (dashboardData && dashboardData.monthlyTrend && dashboardData.monthlyTrend.weeklyOverview) {
                const weeklyData = dashboardData.monthlyTrend.weeklyOverview;
                weeks = weeklyData.map(w => {
                    const val = w.week;
                    return typeof val === 'string' ? val.replace('第', 'Week ').replace('周', '') : val;
                });

                // 获取每周工单量
                const weeklyWorkloads = weeklyData.map(w => w.workload);

                // Define CN->EN mapping and colors for legend labels
                const issueMap = {
                    '服务禁语': { label: 'Prohibited Phrases', color: '#f44336' },
                    '重复性描述': { label: 'Repetitive Description', color: '#e91e63' },
                    '不礼貌用词': { label: 'Impolite Words', color: '#9c27b0' },
                    '缺少开首语': { label: 'Missing Greeting', color: '#673ab7' },
                    '缺少结束语': { label: 'Missing Closing', color: '#3f51b5' },
                    '错别字': { label: 'Typos', color: '#2196f3' },
                    '语句不通': { label: 'Incoherent Sentences', color: '#03a9f4' },
                    '其他': { label: 'Other', color: '#009688' }
                };

                // Build datasets using CN keys for data and EN labels for legend
                Object.entries(issueMap).forEach(([cnKey, meta]) => {
                    const data = weeklyData.map((week, index) => {
                        const issuesData = week.issues_by_type || {};
                        const issueCount = issuesData[cnKey] || 0;
                        const workload = weeklyWorkloads[index] || 1;
                        return ((issueCount / workload) * 100);
                    });
                    const hasData = data.some(v => v > 0);
                    if (hasData) {
                        const color = meta.color;
                        datasets.push({
                            label: meta.label,
                            data,
                            borderColor: color,
                            backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: color
                        });
                    }
                });

                console.log('Loaded issue type trend data (percentage):', { weeks, datasets });
            }

            chartInstances['languageIssueMonthlyTrendChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets  // 使用动态生成的数据集
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Issue Rate (%)'
                            },
                            ticks: {
                                stepSize: 0.5,
                                callback: function (value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function (context) {
                                    return context[0].label;
                                },
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // 生成规范用语月度表格
        function generateLanguageMonthlyTable() {
            const tbody = document.getElementById('languageMonthlyTrendTableBody');
            tbody.innerHTML = '';

            // 获取规范用语月度趋势数据
            let agentTrendsData = [];
            if (dashboardData && dashboardData.monthlyTrend &&
                dashboardData.monthlyTrend.monthlyTrendSummary.languageAgentMonthlyTrends) {
                agentTrendsData = dashboardData.monthlyTrend.monthlyTrendSummary.languageAgentMonthlyTrends;
            }

            // 🎯 获取全部业务的工单总数数据，确保和客服名字正确对应
            let agentWorkloadData = {};
            if (dashboardData && dashboardData.monthlyTrend &&
                dashboardData.monthlyTrend.monthlyTrendSummary.agentsMonthlyTrends) {
                const allBusinessTrends = dashboardData.monthlyTrend.monthlyTrendSummary.agentsMonthlyTrends;
                // 建立 客服名字 -> 工单总数 的映射
                allBusinessTrends.forEach(agent => {
                    agentWorkloadData[agent.name] = agent.total_workload || 0;
                });
            }

            // 🎯 获取全部业务的总工单数（用于显示分母）
            const totalOrders = dashboardData?.monthlyOverview?.totalMonthlyOrders || 0;

            // 🎯 按月度均分排序（从高到低）
            agentTrendsData.sort((a, b) => {
                const aAverage = a.monthly_average || 0;
                const bAverage = b.monthly_average || 0;
                return bAverage - aAverage; // 降序排列，分数高的在前
            });

            // 🎯 按排名填充表格
            agentTrendsData.slice(0, 7).forEach((agent, index) => {
                const row = tbody.insertRow();
                const weeklyScores = agent.weekly_scores;

                // 使用从 output.js 计算好的月度均分
                const monthlyAverage = agent.monthly_average || 0;

                // 🎯 获取该客服对应的工单总数
                const agentWorkload = agentWorkloadData[agent.name] || 0;
                const workloadDisplay = `${agentWorkload}`;

                row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">${monthlyAverage > 0 ? monthlyAverage.toFixed(1) : '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[0] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[1] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[2] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[3] || '-'}</span></td>
                    <td><strong>${workloadDisplay}</strong></td>
                `;
            });
        }
        // 更新规范用语月度统计数据
        function updateLanguageMonthlyStats() {
            if (!dashboardData) return;

            // 获取月度数据
            const monthlyOverview = dashboardData.monthlyOverview || {
                totalMonthlyOrders: 583,
                monthlyAverageScore: 42.4,
                activeAgents: 19
            };

            // 获取规范用语月度数据
            let monthly_average = 17.2; // 默认值
            if (dashboardData?.monthlyTrend?.monthlyTrendSummary?.languageMonthlyTrends?.monthlyStats) {
                monthly_average = dashboardData.monthlyTrend.monthlyTrendSummary.languageMonthlyTrends.monthlyStats.monthly_average;
            }

            let monthlyActiveAgents = monthlyOverview.activeAgents; // 从 Python 计算得出

            // 更新规范用语月度统计卡片
            const languageMonthlyCards = document.querySelectorAll('#monthly-language-business-view .comparison-card');
            if (languageMonthlyCards.length >= 3) {
                languageMonthlyCards[0].querySelector('.current-value').textContent = monthlyActiveAgents;        // 本月客服人数
                languageMonthlyCards[1].querySelector('.current-value').textContent = monthlyOverview.totalMonthlyOrders;  // 本月总工单
                languageMonthlyCards[2].querySelector('.current-value').textContent = monthly_average.toFixed(1);
            }
        }

        // 初始化服务态度月度图表
        function initAttitudeMonthlyCharts() {
            initAttitudeDailyScoreTrendChart();
            initAttitudeIndicatorMonthlyTrendChart();
            generateAttitudeMonthlyTable();
            updateAttitudeMonthlyStats();
        }

        // 服务态度周度表现对比图
        function initAttitudeDailyScoreTrendChart() {
            destroyChart('attitudeDailyScoreTrendChart');

            const ctx = document.getElementById('attitudeDailyScoreTrendChart').getContext('2d');

            // 动态获取数据
            let weeks = [];
            let avgScores = [];
            let issueRates = []; // 🎯 改为问题出现率

            if (dashboardData && dashboardData.monthlyTrend &&
                dashboardData.monthlyTrend.monthlyTrendSummary.attitudeMonthlyTrends) {
                const weeklyData = dashboardData.monthlyTrend.monthlyTrendSummary.attitudeMonthlyTrends.weeklyData;

                weeks = weeklyData.map(w => {
                    const val = w.week;
                    return typeof val === 'string' ? val.replace('第', 'Week ').replace('周', '') : val;
                });
                avgScores = weeklyData.map(w => w.average_score);

                // 🎯 关键修改：计算问题出现率百分比
                issueRates = weeklyData.map(w => {
                    const totalIssues = w.total_issues || 0;
                    const workload = w.workload || 1; // 避免除以0
                    return (totalIssues / workload) * 100; // 转换为百分比
                });

                console.log('🎯 服务态度周度数据 (百分比版本):', { weeks, avgScores, issueRates });
            } else {
                // 兜底数据
                console.warn('No attitude monthly trend data, using defaults');
                weeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                avgScores = [27.8, 28.1, 28.4, 28.7];
                issueRates = [2.5, 2.1, 1.8, 1.5]; // 默认百分比数据
            }

            chartInstances['attitudeDailyScoreTrendChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [
                        {
                            label: 'Weekly Average Score',
                            data: avgScores,  // 动态数据
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Weekly Issue Rate (%)',
                            data: issueRates,  // 🎯 使用百分比数据
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: '#f44336',
                            borderWidth: 2,
                            borderRadius: 6,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: Math.min(...avgScores) - 1,  // 动态设置最小值
                            max: Math.max(...avgScores) + 1,  // 动态设置最大值
                            title: {
                                display: true,
                                text: 'Average Score'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Issue Rate (%)'
                            },
                            ticks: {
                                stepSize: 0.5, // 🎯 设置步长为0.5%
                                callback: function (value) {
                                    return value.toFixed(1) + '%'; // 🎯 添加%符号
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    if (context.datasetIndex === 1) { // 问题出现率数据集
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 服务态度问题月度趋势图（修改为百分比版本）
        function initAttitudeIndicatorMonthlyTrendChart() {
            destroyChart('attitudeIndicatorMonthlyTrendChart');

            const ctx = document.getElementById('attitudeIndicatorMonthlyTrendChart').getContext('2d');

            // 动态获取数据
            let weeks = [];
            let datasets = [];

            if (dashboardData && dashboardData.monthlyTrend && dashboardData.monthlyTrend.weeklyOverview) {
                const weeklyData = dashboardData.monthlyTrend.weeklyOverview;
                weeks = weeklyData.map(w => {
                    const val = w.week;
                    return typeof val === 'string' ? val.replace('第', 'Week ').replace('周', '') : val;
                });

                // 获取每周的工单量数据
                const weeklyWorkloads = weeklyData.map(w => w.workload);

                // 定义服务态度问题类型（用中文键读取数据，用英文作为图例显示）
                const attitudeIssueTypes = [
                    { cnKey: '礼貌分数', label: 'Politeness Score', color: '#f44336' },
                    { cnKey: '安抚分数', label: 'Empathy Score', color: '#e91e63' },
                    { cnKey: '响应时间分数', label: 'Response Time Score', color: '#9c27b0' }
                ];

                // 为每种问题类型创建数据集
                attitudeIssueTypes.forEach(issueConfig => {
                    const data = weeklyData.map((week, index) => {
                        const attitudeIssuesData = week.attitude_issues_by_type || {};
                        // 优先使用中文键读取，如果没有再尝试英文label
                        const issueCount = (attitudeIssuesData[issueConfig.cnKey] ?? attitudeIssuesData[issueConfig.label]) || 0;
                        const workload = weeklyWorkloads[index];
                        // 🎯 关键修改：将问题数量转换为百分比
                        return (issueCount / workload) * 100;
                    });

                    // 只有当该问题类型在某周有数据时才添加到图表
                    const hasData = data.some(value => value > 0);
                    if (hasData) {
                        datasets.push({
                            label: issueConfig.label,
                            data: data,  // 🎯 现在是百分比数据
                            borderColor: issueConfig.color,
                            backgroundColor: issueConfig.color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: issueConfig.color
                        });
                    }
                });

                console.log('动态加载服务态度问题趋势数据（百分比）:', { weeks, datasets });
            }

            chartInstances['attitudeIndicatorMonthlyTrendChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Issue Rate (%)'
                            },
                            ticks: {
                                stepSize: 0.5,  // 🎯 修改：步长改为0.5%
                                callback: function (value) {
                                    return value.toFixed(1) + '%';  // 🎯 修改：显示时添加%符号
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function (context) {
                                    return context[0].label;
                                },
                                label: function (context) {
                                    // 🎯 修改：工具提示显示百分比格式
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        function generateWithdrawalDetailsTableBody() {
            const overallBody = document.getElementById(`withdrawalOverallTableBody`);
            overallBody.innerHTML = '';

            setTimeout(() => {
                let agentsData = [];
                if (dashboardData.auditStats && dashboardData.auditStats.overall && Array.isArray(dashboardData.auditStats.overall.agents) && dashboardData.auditStats.overall.agents.length) {
                    agentsData = dashboardData.auditStats.overall.agents;
                } else {
                    // Fallback fake data for table (7 reviewers)
                    const sampleNames = ['Daria', 'Hera', 'Jessica', 'Rebecca', 'Jenna', 'Euphemia', 'jackkob	'];
                    agentsData = sampleNames.map(name => {
                        const total = Math.floor(Math.random() * 60) + 40; // 40-99
                        const within3min = Math.max(Math.floor(total * (0.75 + Math.random() * 0.2)), 1);
                        const within1min = Math.max(Math.floor(total * (0.35 + Math.random() * 0.25)), 0);
                        const over3min = Math.max(total - within3min, 0);
                        return {
                            name,
                            total,
                            within1min,
                            within1min_rate: total ? (within1min / total) * 100 : 0,
                            within3min,
                            within3min_rate: total ? (within3min / total) * 100 : 0,
                            over3min,
                            over3min_rate: total ? (over3min / total) * 100 : 0
                        };
                    });
                }

                // Limit to 7 reviewers
                agentsData.slice(0, 7).forEach(agent => {
                    const row = overallBody.insertRow();
                    row.innerHTML = `
                        <td><span class="agent-name-no-link">${agent.name}</span></td>
                        <td><span class="score-cell">${agent.total}</span></td>
                        <td><span class="score-cell">${agent.within1min}</span></td>
                        <td><span class="score-cell">${(typeof agent.within1min_rate === 'number' ? agent.within1min_rate : 0).toFixed(1)}%</span></td>
                        <td><span class="score-cell">${agent.within3min}</span></td>
                        <td><span class="score-cell">${(typeof agent.within3min_rate === 'number' ? agent.within3min_rate : 0).toFixed(1)}%</span></td>
                        <td><span class="score-cell">${agent.over3min}</span></td>
                        <td><span class="score-cell">${(typeof agent.over3min_rate === 'number' ? agent.over3min_rate : 0).toFixed(1)}%</span></td>
                    `;
                });
            }, 400);
        }

        // 生成服务态度月度表格
        function generateAttitudeMonthlyTable() {
            const tbody = document.getElementById('attitudeMonthlyTrendTableBody');
            tbody.innerHTML = '';

            // 获取服务态度月度趋势数据
            let agentTrendsData = [];
            if (dashboardData && dashboardData.monthlyTrend &&
                dashboardData.monthlyTrend.monthlyTrendSummary.attitudeAgentMonthlyTrends) {
                agentTrendsData = dashboardData.monthlyTrend.monthlyTrendSummary.attitudeAgentMonthlyTrends;
                console.log('动态加载服务态度客服月度趋势数据:', agentTrendsData);
            } else {
                console.warn('未找到服务态度客服月度趋势数据，使用默认数据');
            }

            // 🎯 获取全部业务的工单总数数据，确保和客服名字正确对应
            let agentWorkloadData = {};
            if (dashboardData && dashboardData.monthlyTrend &&
                dashboardData.monthlyTrend.monthlyTrendSummary.agentsMonthlyTrends) {
                const allBusinessTrends = dashboardData.monthlyTrend.monthlyTrendSummary.agentsMonthlyTrends;
                // 建立 客服名字 -> 工单总数 的映射
                allBusinessTrends.forEach(agent => {
                    agentWorkloadData[agent.name] = agent.total_workload || 0;
                });
            }

            // 🎯 获取全部业务的总工单数（用于显示分母）
            const totalOrders = dashboardData?.monthlyOverview?.totalMonthlyOrders || 0;

            // 🎯 按月度均分排序（从高到低）
            agentTrendsData.sort((a, b) => {
                const aAverage = a.monthly_average || 0;
                const bAverage = b.monthly_average || 0;
                return bAverage - aAverage; // 降序排列，分数高的在前
            });

            // 🎯 按排名填充表格 - 仅展示前7名
            agentTrendsData.slice(0, 7).forEach((agent, index) => {
                const row = tbody.insertRow();
                const weeklyScores = agent.weekly_scores;

                // 使用从 output.js 计算好的月度均分
                const monthlyAverage = agent.monthly_average || 0;

                // 🎯 获取该客服对应的工单总数
                const agentWorkload = agentWorkloadData[agent.name] || 0;
                const workloadDisplay = `${agentWorkload}`;

                row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">${monthlyAverage > 0 ? monthlyAverage.toFixed(1) : '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[0] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[1] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[2] || '-'}</span></td>
                    <td><span class="score-cell">${weeklyScores[3] || '-'}</span></td>
                    <td><strong>${workloadDisplay}</strong></td>
                `;
            });
        }

        // 更新服务态度月度统计数据
        function updateAttitudeMonthlyStats() {
            if (!dashboardData) return;

            // 获取月度数据 - 不使用默认值
            const monthlyOverview = dashboardData.monthlyOverview;
            if (!monthlyOverview) {
                console.warn('缺少monthlyOverview数据，无法更新服务态度月度统计');
                return;
            }

            // 获取服务态度月度数据 - 不使用默认值
            let monthlyAverageScore = null;
            if (dashboardData?.monthlyTrend?.monthlyTrendSummary?.attitudeMonthlyTrends?.monthlyStats) {
                monthlyAverageScore = dashboardData.monthlyTrend.monthlyTrendSummary.attitudeMonthlyTrends.monthlyStats.monthly_average;
            }

            if (monthlyAverageScore === null) {
                console.warn('缺少attitudeMonthlyTrends数据，无法更新服务态度月度平均分');
                return;
            }

            // 更新服务态度月度统计卡片
            const attitudeMonthlyCards = document.querySelectorAll('#monthly-attitude-business-view .comparison-card');
            if (attitudeMonthlyCards.length >= 5) {
                attitudeMonthlyCards[0].querySelector('.current-value').textContent = monthlyOverview.activeAgents;
                attitudeMonthlyCards[1].querySelector('.current-value').textContent = monthlyOverview.totalMonthlyOrders;
                attitudeMonthlyCards[2].querySelector('.current-value').textContent = monthlyAverageScore.toFixed(1);
                attitudeMonthlyCards[3].querySelector('.current-value').textContent = monthlyOverview.monthlyFirstResponseRate.toFixed(1) + '%';
                attitudeMonthlyCards[4].querySelector('.current-value').textContent = monthlyOverview.monthlyResponseIn30sRate.toFixed(1) + '%';
            }
        }

        // 打开个人报告
        function openPersonalReport(agentName) {
            // 获取当前选中的时间段
            const activeTimeTab = document.querySelector('.time-tabs .tab.active');
            const timeType = activeTimeTab ? activeTimeTab.dataset.time : 'current';

            // 从JSON数据中获取个人报告数据
            console.log(dashboardData);
            if (!dashboardData || !dashboardData.personalReports || !dashboardData.personalReports[agentName]) {
                alert('未找到该客服的详细报告数据，请确保dashboard_data.json包含完整的personalReports数据');
                return;
            }

            const personalReport = dashboardData.personalReports[agentName];
            const agentData = getCurrentBusinessData().find(agent => agent.name === agentName);

            if (!agentData) {
                alert('未找到该客服的数据');
                return;
            }

            // 根据时间段生成不同的报告
            let reportHTML;
            if (timeType === 'comparison') {
                reportHTML = generateComparisonReportHTML(agentName, personalReport, agentData);
            } else if (timeType === 'monthly') {
                reportHTML = generateMonthlyReportHTML(agentName, personalReport, agentData);
            } else {
                reportHTML = generatePersonalReportHTML(agentName, personalReport, agentData);
            }

            // 在新窗口中打开报告
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        }

        // 生成个人报告HTML
        function generatePersonalReportHTML(agentName, personalReport, agentData) {
            const currentDate = new Date().toLocaleDateString('zh-CN');

            // 从JSON数据中读取所有信息
            const overview = personalReport.overview;
            const languageQuality = personalReport.languageQuality;
            const serviceAttitude = personalReport.serviceAttitude;

            // 使用JSON中的准确数据
            const aiScore = agentData.current;
            const humanScore = overview.humanScore;
            const totalScore = aiScore + humanScore;
            const humanOrderCount = overview.humanOrderCount
            const languageScore = overview.languageScore;
            const attitudeScore = overview.attitudeScore;
            const ranking = overview.ranking;
            const teamAverage = overview.teamAverage;
            const scoreDiff = overview.scoreDiff;
            const qualityLevel = overview.qualityLevel;
            const firstResponseRate = overview.firstResponseRate;
            const responseIn30sRate = overview.responseIn30sRate;
            const orderCount = agentData.currentCount;
            const teamSize = dashboardData.currentPeriod.overview.agentCount;

            // 计算规范用语问题数量和统计
            const languageIssueCount = languageQuality.totalIssues;
            const languageIssues = languageQuality.issues;

            // 计算服务态度问题数量和统计
            const attitudeIssueCount = serviceAttitude.totalIssues;
            const attitudeIssues = serviceAttitude.issues;

            // 分析规范用语错误最多的三项
            let languageTopErrors = '';
            if (languageIssueCount > 0) {
                const errorItems = Object.entries(languageIssues)
                    .filter(([issue, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                if (errorItems.length > 0) {
                    languageTopErrors = `
                        <div class="top-errors-section">
                            <h4 style="color: #d32f2f; margin-bottom: 10px;">🔍 错误最多的问题类型：</h4>
                            <div class="error-stats">
                                ${errorItems.map(([issue, count], index) => {
                        const percentage = ((count / languageIssueCount) * 100).toFixed(1);
                        // 去掉A0x_前缀
                        const displayIssue = issue.replace(/^A\d+_/, '');
                        return `
                                        <div class="error-stat-item">
                                            <span class="error-rank">${index + 1}.</span>
                                            <span class="error-name">${displayIssue}</span>
                                            <span class="error-count">${count}次</span>
                                            <span class="error-percentage">(${percentage}%)</span>
            </div>
                                    `;
                    }).join('')}
        </div>
                    `;
                }
            }

            // 分析服务态度错误最多的三项
            let attitudeTopErrors = '';
            if (attitudeIssueCount > 0) {
                const errorItems = Object.entries(attitudeIssues)
                    .filter(([issue, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);

                if (errorItems.length > 0) {
                    attitudeTopErrors = `
                        <div class="top-errors-section">
                            <h4 style="color: #d32f2f; margin-bottom: 10px;">🔍 错误最多的问题类型：</h4>
                            <div class="error-stats">
                                ${errorItems.map(([issue, count], index) => {
                        const percentage = ((count / attitudeIssueCount) * 100).toFixed(1);
                        // 去掉A0x_前缀
                        const displayIssue = issue.replace(/^A\d+_/, '');
                        return `
                                        <div class="error-stat-item">
                                            <span class="error-rank">${index + 1}.</span>
                                            <span class="error-name">${displayIssue}</span>
                                            <span class="error-count">${count}次</span>
                                            <span class="error-percentage">(${percentage}%)</span>
                </div>
                                    `;
                    }).join('')}
                </div>
            </div>
                    `;
                }
            }



            const languageIssuesHTML = Object.entries(languageIssues).map(([issue, count]) => {
                // 去掉问题类型前面的 "A0x_" 前缀
                const displayIssue = issue.replace(/^A\d+_/, '');

                let percentageText = '';
                if (count > 0 && languageIssueCount > 0) {
                    const percentage = ((count / languageIssueCount) * 100).toFixed(1);
                    percentageText = ` (${percentage}%)`;
                }

                // 为有问题的项目添加对话图标，并从detailedIssues中获取所有示例
                let dialogIcon = '';
                let collapsibleContent = '';
                if (count > 0 && languageQuality.detailedIssues) {
                    // 找到所有相同类型的问题示例
                    const allIssueExamples = languageQuality.detailedIssues.filter(item => item.type.replace(/^A\d+_/, '') === issue);

                    if (allIssueExamples.length > 0) {
                        dialogIcon = '';
                        // 创建包含所有示例的可折叠内容区域
                        const allExamplesHTML = allIssueExamples.map((example, index) => `
                            <div class="issue-example">
                                ${example.detail ? `
                                    <div class="issue-example">
                                        <strong>具体问题 ${index + 1}: </strong>
                                        <div class="suggestion-text">${example.detail}</div>
                                    </div>
                                ` : ''}
                                ${example.suggestion ? `
                                    <div class="issue-example">
                                        <strong>建议 ${index + 1}:</strong>
                                        <div class="suggestion-text">${example.suggestion}</div>
                                    </div>
                                ` : ''}
                                <strong>会话 ${index + 1}:</strong>
                                <div class="example-text">${example.dialogExample}</div>
                            </div>
                        `).join('');

                        collapsibleContent = `
                            <div class="issue-content">
                                ${allExamplesHTML}
                            </div>
                        `;
                    }
                }

                // 生成唯一的ID用于折叠功能
                const issueId = displayIssue.replace(/\s+/g, '-').toLowerCase();
                const hasFailed = count > 0;
                console.log(`Collapsible content: ${collapsibleContent}`);
                if (hasFailed) {
                    // 失败的项目使用CSS折叠
                    return `
                        <div class="issue-item issue-fail">
                            <input type="checkbox" id="toggle-${issueId}" class="toggle-checkbox">
                            <label for="toggle-${issueId}" class="issue-header">
                                <div style="display: flex; align-items: center;">
                                    <span class="collapse-icon">▶</span>
                                    <span>${displayIssue}${percentageText}${dialogIcon}</span>
                                </div>
                                <span class="issue-status">❌</span>
                            </label>
                            ${collapsibleContent}
                        </div>
                    `;
                } else {
                    // 通过的项目保持简单
                    return `
                        <div class="issue-item issue-pass">
                            <div class="issue-header">
                                <span>${displayIssue}${percentageText}${dialogIcon}</span>
                                <span class="issue-status">✅</span>
                            </div>
                        </div>
                    `;
                }
            }).join('');


            const attitudeIssuesHTML = Object.entries(attitudeIssues).map(([issue, count]) => {
                let percentageText = '';
                if (count > 0 && attitudeIssueCount > 0) {
                    const percentage = ((count / attitudeIssueCount) * 100).toFixed(1);
                    percentageText = ` (${percentage}%)`;
                }
                let dialogIcon = '';
                let collapsibleContent = '';

                if (count > 0 && serviceAttitude.detailedIssues) {
                    const allIssueExamples = serviceAttitude.detailedIssues.filter(item => item.type === issue);

                    if (allIssueExamples.length > 0) {
                        dialogIcon = '';
                        const allExamplesHTML = allIssueExamples.map((example, index) => `
                            <div class="issue-example">
                                ${example.level_explanation ? `
                                    <div class="issue-detail">
                                        <strong>问题说明 ${index + 1}:</strong>
                                        <div class="details-text">${example.level_explanation}</div>
                                    </div>
                                ` : ''}
                            ${example.suggestion ? `
                                    <div class="issue-suggestion">
                                        <strong>建议 ${index + 1}:</strong>
                                        <div class="suggestion-text">${example.suggestion}</div>
                                    </div>
                                ` : ''}
                                <strong>会话 ${index + 1}:</strong>
                                <div class="example-text">${example.dialogExample}</div>
                            </div>
                        `).join('');

                        collapsibleContent = `
                            <div class="issue-content">
                                ${allExamplesHTML}
                            </div>
                        `;
                    }
                }

                // 生成唯一的ID用于折叠功能
                const issueId = `attitude-${issue.replace(/\s+/g, '-').toLowerCase()}`;
                const hasFailed = count > 0;

                if (hasFailed) {
                    // 失败的项目使用CSS折叠
                    return `
                        <div class="issue-item issue-fail">
                            <input type="checkbox" id="toggle-${issueId}" class="toggle-checkbox">
                            <label for="toggle-${issueId}" class="issue-header">
                                <div style="display: flex; align-items: center;">
                                    <span class="collapse-icon">▶</span>
                                    <span>${issue}${percentageText}${dialogIcon}</span>
                                </div>
                                <span class="issue-status">❌</span>
                            </label>
                            ${collapsibleContent}
                        </div>
                    `;
                } else {
                    // 通过的项目保持简单
                    return `
                        <div class="issue-item issue-pass">
                            <div class="issue-header">
                                <span>${issue}${percentageText}${dialogIcon}</span>
                                <span class="issue-status">✅</span>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客服个人质检详细报告</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1px;
        }
        
        .report-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }
        
        .report-title {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
        
        .report-date {
            color: #666;
            font-size: 1rem;
        }
        
        .report-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .report-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .score-highlight {
            background: linear-gradient(135deg, #e8f5e8, #f3e5f5);
            border-left-color: #4caf50;
        }
        
        .report-card-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-card-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .analysis-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .issue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .issue-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .issue-item {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            margin-bottom: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .issue-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .toggle-checkbox {
            display: none;
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .issue-header:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }

        .issue-fail .issue-header:hover {
            background-color: rgba(244, 67, 54, 0.05);
        }

        .collapse-icon {
            font-size: 0.9rem;
            color: #666;
            margin-right: 8px;
            transition: transform 0.3s ease;
        }

        .toggle-checkbox:checked + .issue-header .collapse-icon {
            transform: rotate(90deg);
        }

        .issue-content {
            max-height: 0;
            overflow: hidden;
            padding: 0 16px;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .toggle-checkbox:checked ~ .issue-content {
            max-height: 400px;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e2e8f0;
            border-top: 1px solid #e2e8f0;
        }

        .issue-content::-webkit-scrollbar {
            width: 8px;
        }

        .issue-content::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
            margin: 2px;
        }

        .issue-content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .issue-content::-webkit-scrollbar-thumb:hover {
            background: #5a67d8;
        }

        .issue-example, .issue-suggestion, .issue-detail {
            margin-bottom: 12px;
        }

        .issue-example:last-child, .issue-suggestion:last-child, .issue-detail:last-child {
            margin-bottom: 0;
        }

        .example-text, .suggestion-text, .details-text {
            margin-top: 4px;
            padding: 8px 12px;
            background-color: #f7fafc;
            border-left: 3px solid #667eea;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-height: none;
            height: auto;
        }

        .suggestion-text {
            border-left-color: #4caf50;
        }
        
        .details-text {
            border-left-color: #4caf50;
        }
        
        .issue-pass {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        
        .issue-fail {
            background: #ffebee;
            border-color: #f44336;
        }
        
        .issue-status {
            font-size: 1.2rem;
        }
        
        .top-errors-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
        }
        
        .error-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .error-stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #ff9800;
        }
        
        .error-rank {
            font-weight: bold;
            color: #ff9800;
        }
        
        .error-name {
            flex: 1;
            font-weight: 500;
        }
        
        .error-count {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .error-percentage {
            color: #666;
            font-size: 0.9rem;
        }
        
        .comparison-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: width 0.3s ease;
        }
        
        .back-button, .print-button {
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .back-button {
            background: #667eea;
            color: white;
        }
        
        .print-button {
            background: #2196F3;
            color: white;
            margin-left: 10px;
        }
        
        .back-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .print-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .back-button, .print-button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <div>
                <div class="report-title">${agentName} - 个人质检详细报告</div>
                <div class="report-date">报告日期：${currentDate}</div>
            </div>
            <div>
                <button class="back-button" onclick="window.close()">关闭报告</button>
                <button class="print-button" onclick="window.print()">打印报告</button>
                </div>
            </div>

        <div class="report-section">
            <div class="section-title">📊 综合表现概览</div>
            <div class="report-grid">
                <div class="report-card score-highlight">
                    <div class="report-card-title">总分</div>
                    <div class="report-card-value">${totalScore.toFixed(1)}</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">业务质检平均分</div>
                    <div class="report-card-value">${humanScore.toFixed(1)}</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">业务质检工单数</div>
                    <div class="report-card-value">${humanOrderCount > 0 ? humanOrderCount : '-'}</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">AI质检平均分</div>
                    <div class="report-card-value">${aiScore.toFixed(1)}</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">AI质检工单数量</div>
                    <div class="report-card-value">${orderCount}</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">首响率</div>
                    <div class="report-card-value">${firstResponseRate}%</div>
                </div>
                <div class="report-card">
                    <div class="report-card-title">响应30s应答率</div>
                    <div class="report-card-value">${responseIn30sRate}%</div>
                </div>
            </div>
        </div>

        <div class="report-section">
            <div class="section-title">📝 规范用语详细分析</div>
            <div class="analysis-section">
                <div class="analysis-header">
                    <span><strong>本周得分：${languageScore.toFixed(1)} (${languageScore >= 20 ? '+' + (languageScore - 20).toFixed(1) : '扣' + (20 - languageScore).toFixed(1)}分)</strong></span>
                    <span style="color: #d32f2f;">共发现 ${languageIssueCount} 个问题</span>
                </div>
                ${languageTopErrors}
                <div class="issue-grid">
                    ${languageIssuesHTML}
                </div>
            </div>
        </div>

        <div class="report-section">
            <div class="section-title">💬 服务态度详细分析</div>
            <div class="analysis-section">
                <div class="analysis-header">
                    <span><strong>本周得分：${attitudeScore.toFixed(1)} (${attitudeScore >= 30 ? '+' + (attitudeScore - 30).toFixed(1) : '扣' + (30 - attitudeScore).toFixed(1)}分)</strong></span>
                    <span style="color: #d32f2f;">共发现 ${attitudeIssueCount} 个问题</span>
                </div>
                ${attitudeTopErrors}
                <div class="issue-grid">
                    ${attitudeIssuesHTML}
                </div>
        </div>
    </div>

        <div class="report-section">
            <div class="section-title">🎯 团队对比与排名</div>
            <div class="comparison-section">
                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-card-title">总排名</div>
                        <div class="report-card-value">第 ${ranking} 名 / 共 ${teamSize} 人</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.max(10, (teamSize - ranking + 1) / teamSize * 100)}%"></div>
                        </div>
                    </div>
                    <div class="report-card">
                        <div class="report-card-title">与团队均分差距</div>
                        <div class="report-card-value" style="color: ${scoreDiff >= 0 ? '#4CAF50' : '#f44336'}">${scoreDiff >= 0 ? '+' : ''}${scoreDiff} 分</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0; color: #666;">
            <p>本报告由 Deepcoin 客服质检系统自动生成</p>
            <p>如有疑问请联系质检部门</p>
        </div>
    </div>
</body>
</html>
            `;
        }

        // 初始化服务态度对比图表
        function initAttitudeComparisonCharts() {
            initAttitudeScoreComparisonChart();
        }

        // 服务态度得分分布对比图
        function initAttitudeScoreComparisonChart() {
            destroyChart('attitudeScoreComparisonChart');

            const ctx = document.getElementById('attitudeScoreComparisonChart').getContext('2d');

            const scoreRanges = ['<20', '20-25', '25-30', '>30'];

            let currentDistribution = [0, 0, 0, 0];
            let previousDistribution = [0, 0, 0, 0];

            // 统计本周服务态度数据
            if (dashboardData && dashboardData.personalReports) {
                Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                    if (report.overview && report.overview.attitudeScore !== undefined) {
                        const currentScore = report.overview.attitudeScore;
                        console.log(`本周服务态度得分处理: ${agentName}, 得分: ${currentScore}`);

                        if (currentScore > 30) currentDistribution[3]++;        // >30分
                        else if (currentScore >= 25) currentDistribution[2]++;  // 25-30分
                        else if (currentScore >= 20) currentDistribution[1]++;  // 20-25分
                        else currentDistribution[0]++;                          // <20分
                    }
                });
            }

            // 统计上周服务态度数据（基于上周的完整数据源）
            if (dashboardData && dashboardData.previousPeriod && dashboardData.previousPeriod.personalReports) {
                Object.entries(dashboardData.previousPeriod.personalReports).forEach(([agentName, report]) => {
                    if (report.overview && report.overview.attitudeScore !== undefined) {
                        const previousScore = report.overview.attitudeScore;
                        console.log(`上周服务态度得分处理: ${agentName}, 得分: ${previousScore}`);

                        if (previousScore > 30) previousDistribution[3]++;
                        else if (previousScore >= 25) previousDistribution[2]++;
                        else if (previousScore >= 20) previousDistribution[1]++;
                        else previousDistribution[0]++;
                    }
                });
            } else {
                console.warn('缺少previousPeriod.personalReports数据，上周分布为空');
            }

            // 如果没有数据，使用默认分布
            if (currentDistribution.every(val => val === 0) && previousDistribution.every(val => val === 0)) {
                console.warn('缺少personalReports数据，使用默认分布');
                currentDistribution = [0, 2, 6, 2];
                previousDistribution = [0, 0, 0, 0];
            }

            console.log('服务态度得分分布统计结果：');
            console.log('本周分布:', currentDistribution);
            console.log('上周分布:', previousDistribution);

            const currentTotal = currentDistribution.reduce((a, b) => a + b, 0);
            const previousTotal = previousDistribution.reduce((a, b) => a + b, 0);

            const datasets = [
                {
                    label: `This Week (Total ${currentTotal})`,
                    data: currentDistribution,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    borderRadius: 6
                }
            ];

            if (previousTotal > 0) {
                datasets.push({
                    label: `Last Week (Total ${previousTotal})`,
                    data: previousDistribution,
                    backgroundColor: 'rgba(233, 30, 99, 0.8)',
                    borderColor: '#e91e63',
                    borderWidth: 2,
                    borderRadius: 6
                });
            }

            chartInstances['attitudeScoreComparisonChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: scoreRanges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Score Range'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of People'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    return `Score Range: ${context[0].label}`;
                                },
                                label: function (context) {
                                    const datasetLabel = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${datasetLabel}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成服务态度对比表格
        function generateAttitudeComparisonTable() {
            const tbody = document.getElementById('attitudeComparisonTableBody');
            tbody.innerHTML = '';

            if (!dashboardData || !dashboardData.personalReports) return;

            // 从JSON数据构建对比数据
            const comparisonData = [];
            Object.entries(dashboardData.personalReports).forEach(([agentName, report]) => {
                if (report.overview && report.serviceAttitude) {
                    // 🎯 获取工单数据 - 使用和全部业务一样的数据源
                    const currentAgentData = dashboardData.currentPeriod?.agents?.find(a => a.name === agentName);
                    const previousAgentData = dashboardData.previousPeriod?.agents?.find(a => a.name === agentName);

                    comparisonData.push({
                        name: agentName,
                        currentScore: report.overview.attitudeScore,
                        previousScore: report.previousOverview?.attitudeScore || -1,
                        currentIssueCount: report.serviceAttitude.totalIssues || 0,
                        previousIssueCount: report.serviceAttitude.previousTotalIssues || 0,
                        // 🎯 添加工单数据
                        currentOrders: currentAgentData?.orderCount || 0,
                        previousOrders: previousAgentData?.orderCount || -1
                    });
                }
            });

            // 排序逻辑：有上周数据的放最上面，然后是没有上周数据的
            comparisonData.sort((a, b) => {
                const aHasPrevious = a.previousScore !== -1;
                const bHasPrevious = b.previousScore !== -1;

                if (aHasPrevious !== bHasPrevious) {
                    return aHasPrevious ? -1 : 1;
                }

                return b.currentScore - a.currentScore;
            });

            comparisonData
                .sort((a, b) => b.currentScore - a.currentScore)
                .slice(0, 7)
                .forEach(agent => {
                    const row = tbody.insertRow();

                    const scoreChange = agent.previousScore !== -1 ? agent.currentScore - agent.previousScore : 0;

                    // 🎯 计算本周问题工单占比：问题数/工单数
                    const currentRatio = agent.currentOrders > 0 ?
                        ((agent.currentIssueCount / agent.currentOrders) * 100) : 0;

                    // 🎯 计算上周问题工单占比
                    const previousRatio = (agent.previousOrders !== -1 && agent.previousOrders > 0) ?
                        ((agent.previousIssueCount / agent.previousOrders) * 100) : 0;

                    // 🎯 计算占比变化（百分点变化）
                    let ratioChange = 0;
                    let ratioChangeDisplay = "-";
                    let ratioChangeClass = "stable";

                    if (agent.previousOrders !== -1 && (previousRatio > 0 || currentRatio > 0)) {
                        ratioChange = currentRatio - previousRatio;
                        ratioChangeDisplay = (ratioChange > 0 ? "+" : "") + ratioChange.toFixed(1) + "%";
                        ratioChangeClass = ratioChange > 0 ? "decline" : ratioChange < 0 ? "improvement" : "stable";
                    }

                    // 🎯 上周数据显示处理
                    const previousIssueDisplay = agent.previousIssueCount !== undefined ? agent.previousIssueCount : "-";
                    const previousOrderDisplay = agent.previousOrders !== -1 ? agent.previousOrders : "-";

                    row.innerHTML = `
                    <td><span class="agent-name-no-link">${agent.name}</span></td>
                    <td><span class="score-cell">${agent.currentScore.toFixed(1)}</span></td>
                    <td><span class="score-cell">${agent.previousScore === -1 ? "-" : agent.previousScore.toFixed(1)}</span></td>
                    <td><span class="${agent.previousScore === -1 ? 'stable' : scoreChange > 0 ? 'improvement' : scoreChange < 0 ? 'decline' : 'stable'}">
                        ${agent.previousScore === -1 ? "-" : (scoreChange > 0 ? '+' : '') + scoreChange.toFixed(1)}
                    </span></td>
                    <td><strong>${agent.currentIssueCount}/${agent.currentOrders}</strong></td>
                    <td><strong>${currentRatio.toFixed(1)}%</strong></td>
                    <td><strong>${previousIssueDisplay}/${previousOrderDisplay}</strong></td>
                    <td><strong>${agent.previousOrders !== -1 ? previousRatio.toFixed(1) + "%" : "-"}</strong></td>
                    <td><span class="${ratioChangeClass}">
                        ${ratioChangeDisplay}
                    </span></td>
                `;
                });
        }

        // 更新月度趋势统计数据
        function updateMonthlyTrendStats() {
            if (!dashboardData) return;

            // 使用JSON数据中的月度概览数据
            const monthlyOverview = dashboardData.monthlyOverview || {
                totalMonthlyOrders: 312,
                monthlyAverageScore: 47.8,
                monthlyFirstResponseRate: 96.2,
                monthlyResponseIn30sRate: 89.3,
                activeAgents: 13,
                improvementRate: 78.2
            };

            let monthlyActiveAgents = monthlyOverview.activeAgents; // 从 Python 计算得出

            // 更新月度数据统计卡片
            const monthlyCards = document.querySelectorAll('#monthly-all-business-view .comparison-card');
            if (monthlyCards.length >= 5) {
                monthlyCards[0].querySelector('.current-value').textContent = Math.min(7, monthlyActiveAgents);
                monthlyCards[1].querySelector('.current-value').textContent = monthlyOverview.totalMonthlyOrders;                    // 本月总工单
                monthlyCards[2].querySelector('.current-value').textContent = monthlyOverview.monthlyAverageScore.toFixed(1);        // 月度平均分
                monthlyCards[3].querySelector('.current-value').textContent = monthlyOverview.monthlyFirstResponseRate.toFixed(1) + '%';  // 月度首响率
                monthlyCards[4].querySelector('.current-value').textContent = monthlyOverview.monthlyResponseIn30sRate.toFixed(1) + '%';
            }
        }
        // 初始化月度趋势图表
        function initMonthlyTrendCharts() {
            initWeeklyComparisonChart(); // ⚠️ 改为正确的函数名
            generateMonthlyTrendTable();
            updateMonthlyTrendStats();
        }


        // 统一的颜色映射函数
        function getScoreColor(score, scoreType) {
            if (scoreType === 'language') {
                // 规范用语 (20分制)
                if (score >= 18) return '#4CAF50';  // 绿色 - 优秀
                if (score >= 16) return '#2196F3';  // 蓝色 - 良好
                if (score >= 14) return '#FF9800';  // 橙色 - 一般
                return '#f44336';  // 红色 - 待改进
            } else {
                // 服务态度 (30分制)
                if (score >= 27) return '#4CAF50';  // 绿色 - 优秀
                if (score >= 24) return '#2196F3';  // 蓝色 - 良好
                if (score >= 21) return '#FF9800';  // 橙色 - 一般
                return '#f44336';  // 红色 - 待改进
            }
        }

        // 为每个客服生成一致的颜色映射
        function generateAgentColorMap(agentData, scoreType) {
            const colorMap = {};
            agentData.forEach(agent => {
                colorMap[agent.name] = getScoreColor(agent.score, scoreType);
            });
            return colorMap;
        }

        // 动态渲染消息高峰区间与客服人数分布图
        function renderMessagePeakChart() {
            const container = document.getElementById('messagePeakChart');
            if (!container || !dashboardData || !dashboardData.sessionVsAgentCntByDay) return;
            if (chartInstances['messagePeakChart']) {
                chartInstances['messagePeakChart'].destroy();
            }

            const data = dashboardData.sessionVsAgentCntByDay;

            // 获取日期范围用于显示
            const dates = data.dates || [];
            const dateRangeText = dates.length > 0 ? `${dates[0]} - ${dates[dates.length - 1]}` : '';

            // 使用一周总计的数据
            const weeklyAgentCounts = data.agent_sum_count;

            // 计算一周总计的有效和无效会话数（从二维数组转为一维数组）
            const weeklyValidSessions = data.valid_session_counts.length > 0 ?
                data.valid_session_counts[0].map((_, colIndex) =>
                    data.valid_session_counts.reduce((sum, row) => sum + row[colIndex], 0)
                ) : [];

            const weeklyInvalidSessions = data.invalid_session_counts.length > 0 ?
                data.invalid_session_counts[0].map((_, colIndex) =>
                    data.invalid_session_counts.reduce((sum, row) => sum + row[colIndex], 0)
                ) : [];

            const ctx = container.getContext('2d');
            const [peakStart, peakEnd] = data.peak_interval;
            const totalHours = data.hour_labels.length;
            const hourIndices = Array.from({ length: totalHours }, (_, i) => i);
            const topN = Math.max(1, Math.round(totalHours * 0.2));

            // 使用一周总计的有效会话数来计算Top 20%
            const sorted = hourIndices.slice().sort((a, b) => weeklyValidSessions[b] - weeklyValidSessions[a]);
            const top20Idx = sorted.slice(0, topN);

            const peakBgPlugin = {
                id: 'peakBg',
                beforeDraw: chart => {
                    const { ctx, chartArea, scales } = chart;
                    if (!chartArea) return;
                    ctx.save();
                    const xStart = scales.x.getPixelForValue(peakStart);
                    const xEnd = scales.x.getPixelForValue(peakEnd);
                    ctx.fillStyle = 'rgba(255,224,178,0.35)';
                    ctx.fillRect(xStart, chartArea.top, xEnd - xStart + scales.x.getPixelForValue(1) - scales.x.getPixelForValue(0), chartArea.bottom - chartArea.top);
                    ctx.restore();
                }
            };

            const barColors = weeklyValidSessions.map((v, i) => top20Idx.includes(i) ? '#e53935' : '#4CAF50');
            const borderColors = weeklyValidSessions.map((v, i) => top20Idx.includes(i) ? '#b71c1c' : 'rgba(0,0,0,0)');

            chartInstances['messagePeakChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.hour_labels,
                    datasets: [
                        {
                            label: 'Online Agents',
                            data: weeklyAgentCounts,
                            type: 'line',
                            yAxisID: 'y1',
                            borderColor: '#1976D2',
                            backgroundColor: '#1976D2',
                            pointRadius: 4,
                            pointBackgroundColor: '#1976D2',
                            fill: false,
                            tension: 0.2,
                            order: 1
                        },
                        {
                            label: 'Valid Sessions',
                            data: weeklyValidSessions,
                            backgroundColor: barColors,
                            borderColor: borderColors,
                            borderWidth: weeklyValidSessions.map((v, i) => top20Idx.includes(i) ? 3 : 0),
                            stack: 'msg',
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.85,
                            order: 2
                        },
                        {
                            label: 'Invalid Sessions',
                            data: weeklyInvalidSessions,
                            backgroundColor: '#FF9800',
                            stack: 'msg',
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.85,
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    layout: {
                        padding: {
                            top: 25  // 为日期范围显示留出空间
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#222',
                                font: { size: 15 },
                                generateLabels: function (chart) {
                                    const orig = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    // 插入Top 20%高峰小时说明
                                    orig.push({
                                        text: 'Top 20% Peak Hours',
                                        fillStyle: '#e53935',
                                        strokeStyle: '#b71c1c',
                                        lineWidth: 2,
                                        hidden: false,
                                        index: orig.length
                                    });
                                    return orig;
                                }
                            }
                        },
                        tooltip: { mode: 'index', intersect: false },
                        title: { display: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(200,200,200,0.08)' },
                            ticks: { color: '#222', font: { size: 13 } }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: { display: true, text: 'Sessions', color: '#222' },
                            grid: { color: 'rgba(200,200,200,0.12)' },
                            ticks: { color: '#222', font: { size: 13 } }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Agents', color: '#1976D2' },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: Math.max(...weeklyAgentCounts, 10) + 2,
                            ticks: { color: '#1976D2', font: { size: 13 } }
                        }
                    }
                },
                plugins: []  // 添加两个插件
            });
        }

        // 在切换到other-content时渲染图表
        document.addEventListener('DOMContentLoaded', function () {
            // 监听tab切换
            document.querySelectorAll('.time-tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    if (this.dataset.time === 'other') {
                        setTimeout(renderMessagePeakChart, 200);
                    }
                });
            });
            // 如果页面初始就在other-content，也渲染
            if (document.getElementById('other-content').classList.contains('active')) {
                setTimeout(renderMessagePeakChart, 200);
            }
        });

        // 新增：一周每天每小时消息量与客服人数分析图表
        function renderMsgVsAgentByDayChart(dayIdx = 0) {
            const container = document.getElementById('msgVsAgentByDayChart');
            if (!container || !dashboardData || !dashboardData.sessionVsAgentCntByDay) return;
            if (chartInstances['msgVsAgentByDayChart']) {
                chartInstances['msgVsAgentByDayChart'].destroy();
            }
            const data = dashboardData.sessionVsAgentCntByDay;
            const hourLabels = data.hour_labels;
            const valid = data.valid_session_counts[dayIdx];
            const invalid = data.invalid_session_counts ? data.invalid_session_counts[dayIdx] : [];
            const agents = data.agent_counts[dayIdx];
            const totalHours = data.hour_labels.length;
            const hourIndices = Array.from({ length: totalHours }, (_, i) => i);
            const topN = Math.max(1, Math.round(totalHours * 0.2));
            const sorted = hourIndices.slice().sort((a, b) => valid[b] - valid[a]);
            const top20Idx = sorted.slice(0, topN);


            // 获取当天的数据
            const dayData = dashboardData.dailySessionVsAgent[dayIdx];

            // 获取高峰时段
            const peakHours = dayData.peak_hours || [];

            // 创建背景色数组，高峰时段用浅红色标注
            const validBgColors = valid.map((_, index) =>
                peakHours.includes(index) ? 'rgba(76, 175, 80, 0.6)' : 'rgba(76, 175, 80, 0.2)'
            );

            const barColors = valid.map((v, i) => top20Idx.includes(i) ? '#e53935' : '#4CAF50');
            const borderColors = valid.map((v, i) => top20Idx.includes(i) ? '#b71c1c' : 'rgba(0,0,0,0)');

            const ctx = container.getContext('2d');
            chartInstances['msgVsAgentByDayChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hourLabels,
                    datasets: [
                        {
                            label: 'Online Agents',
                            data: agents,
                            type: 'line',
                            yAxisID: 'y1',
                            borderColor: '#1976D2',
                            backgroundColor: '#1976D2',
                            pointRadius: 4,
                            pointBackgroundColor: '#1976D2',
                            fill: false,
                            tension: 0.2,
                            order: 1
                        },
                        {
                            label: 'Valid Sessions',
                            data: valid,
                            backgroundColor: barColors,
                            borderColor: borderColors,
                            borderWidth: valid.map((v, i) => top20Idx.includes(i) ? 3 : 0),
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.85,
                            stack: 'msg',
                            order: 2
                        },
                        {
                            label: 'Invalid Sessions',
                            data: invalid,
                            backgroundColor: '#FF9800',
                            borderRadius: 3,
                            barPercentage: 0.85,
                            categoryPercentage: 0.85,
                            stack: 'msg',
                            order: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#222',
                                font: { size: 15 },
                                generateLabels: function (chart) {
                                    const orig = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    // 添加高峰时段说明
                                    orig.push({
                                        text: 'Top 20% Peak Hours',
                                        fillStyle: '#e53935',
                                        strokeStyle: '#b71c1c',
                                        lineWidth: 2,
                                        hidden: false,
                                        index: orig.length
                                    });
                                    return orig;
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function (context) {
                                    const hour = context[0].label;
                                    const isPeakHour = peakHours.includes(context[0].dataIndex);
                                    return `${hour}${isPeakHour ? ' (Peak Hours)' : ''}`;
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(200,200,200,0.08)' },
                            ticks: { color: '#222', font: { size: 13 } }
                        },
                        y: {
                            stacked: true,
                            position: 'left',
                            title: { display: true, text: 'Sessions', color: '#222' },
                            grid: { color: 'rgba(200,200,200,0.12)' },
                            ticks: { color: '#222', font: { size: 13 } }
                        },
                        y1: {
                            position: 'right',
                            title: { display: true, text: 'Agents', color: '#1976D2' },
                            grid: { drawOnChartArea: false },
                            min: 0,
                            max: Math.max(...agents, 10) + 2,
                            ticks: { color: '#1976D2', font: { size: 13 } }
                        }
                    }
                }
            });
        }
        // 新增：渲染tab按钮
        function renderMsgVsAgentTabs() {
            const tabDiv = document.getElementById('msg-vs-agent-tabs');
            if (!tabDiv || !dashboardData || !dashboardData.sessionVsAgentCntByDay) return;
            const dates = dashboardData.sessionVsAgentCntByDay.dates;
            tabDiv.innerHTML = dates.map((d, i) => `<button class="msg-vs-agent-tab" data-idx="${i}" style="margin:0 6px;padding:7px 18px;border-radius:7px;border:none;background:${i === 0 ? '#1976D2' : '#eee'};color:${i === 0 ? '#fff' : '#222'};font-weight:600;cursor:pointer;">${d}</button>`).join('');
            tabDiv.querySelectorAll('.msg-vs-agent-tab').forEach(btn => {
                btn.onclick = function () {
                    tabDiv.querySelectorAll('.msg-vs-agent-tab').forEach(b => { b.style.background = '#eee'; b.style.color = '#222'; });
                    this.style.background = '#1976D2';
                    this.style.color = '#fff';
                    renderMsgVsAgentByDayChart(Number(this.dataset.idx));
                };
            });
        }
        // 页面初始化后渲染一周消息量与客服人数分析
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                renderMsgVsAgentTabs();
                renderMsgVsAgentByDayChart(0);
            }, 400);
        });

        // 初始化热力图
        let currentDateIndex = 0;
        let heatmapChart = null;


        function initHeatmap() {
            if (!heatmapChart) {
                heatmapChart = echarts.init(document.getElementById('heatmapChart'));
            }
            updateHeatmap();
        }

        function updateHeatmap() {
            if (!dashboardData || !dashboardData.sessionVsAgentCntByDay) return;

            const dates = dashboardData.sessionVsAgentCntByDay.dates;
            const currentDate = dates[currentDateIndex];
            document.getElementById('currentDate').textContent = currentDate;

            // 获取当天的数据
            console.log(currentDate);
            const statsArr = dashboardData.daily_agent_session_stats;
            const statsObj = statsArr.find(item => item.date === currentDate);
            const dailyData = statsObj ? statsObj.agent_session_counts : {};
            console.log(dailyData);
            // 准备数据
            let agents = Object.keys(dailyData);
            // limit to top 7 agents by total messages for the day
            const totals = agents.map(a => ({ name: a, total: (dailyData[a] || []).reduce((s, v) => s + (v || 0), 0) }));
            agents = totals.sort((a, b) => b.total - a.total).slice(0, 7).map(t => t.name);
            const hours = Array.from({ length: 24 }, (_, i) => i);
            const data = [];

            // 计算最大值用于设置颜色范围
            let maxValue = 0;
            agents.forEach(agent => {
                dailyData[agent].forEach(value => {
                    maxValue = Math.max(maxValue, value);
                });
            });

            // 生成热力图数据
            agents.forEach((agent, agentIndex) => {
                hours.forEach((hour, hourIndex) => {
                    const value = dailyData[agent][hour];
                    if (value > 0) {
                        data.push([hour, agentIndex, value]);
                    }
                });
            });

            const option = {
                backgroundColor: '#fff',
                tooltip: {
                    position: 'top',
                    formatter: function (params) {
                        return `${agents[params.value[1]]}<br>` +
                            `${params.value[0]}:00-${params.value[0] + 1}:00<br>` +
                            `Messages: ${params.value[2]}`;
                    }
                },
                grid: {
                    top: 40,
                    left: 30,
                    right: 60,
                    bottom: 40,
                    containLabel: true // 让坐标轴标签不会被裁剪
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    splitArea: { show: true },
                    axisLabel: {
                        formatter: '{value}:00',
                        color: '#222',
                        fontSize: 14
                    }
                },
                yAxis: {
                    type: 'category',
                    data: agents,
                    splitArea: { show: true },
                    axisLabel: {
                        color: '#222',
                        fontSize: 14,
                        interval: 0 // 全部显示
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxValue,
                    calculable: true,
                    orient: 'vertical',
                    left: 'right',
                    top: 'center',
                    itemWidth: 16,
                    itemHeight: 120,
                    textStyle: { color: '#222' },
                    color: ['#d94e5d', '#eac736', '#50a3ba']
                },
                series: [{
                    name: 'Messages',
                    type: 'heatmap',
                    data: data,
                    label: {
                        show: true,
                        color: '#222',
                        fontSize: 12
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }]
            };

            heatmapChart.setOption(option);
        }

        // 绑定日期切换按钮事件
        document.getElementById('prevDate').onclick = function () {
            if (currentDateIndex > 0) {
                currentDateIndex--;
                updateHeatmap();
            }
        };

        document.getElementById('nextDate').onclick = function () {
            const dates = dashboardData.sessionVsAgentCntByDay.dates;
            if (currentDateIndex < dates.length - 1) {
                currentDateIndex++;
                updateHeatmap();
            }
        };

        // 页面加载完成后初始化热力图
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                initHeatmap();
                // 监听窗口大小变化,调整图表大小
                window.addEventListener('resize', function () {
                    if (heatmapChart) {
                        heatmapChart.resize();
                    }
                });
            }, 400);
        });

        function updateAttitudeIssueCards() {
            const issueStatsCN = jsonData.currentPeriod.attitudeIssueSummary || {
                '响应超时': 0,
                '服务语气不佳': 0,
                '情绪安抚不足': 0
            };
            // Map Chinese keys to English for display
            const keyMap = {
                '响应超时': 'Response Timeout',
                '服务语气不佳': 'Poor Service Tone',
                '情绪安抚不足': 'Insufficient Emotional Support'
            };
            const issueStats = Object.fromEntries(Object.entries(issueStatsCN).map(([k, v]) => [keyMap[k] || k, v]));

            // 生成问题卡片HTML（删除出错率显示）
            const issueCards = Object.entries(issueStats).map(([issue, count]) => {
                let rateClass = 'error-rate-low';
                if (count >= 5) rateClass = 'error-rate-high';
                else if (count >= 3) rateClass = 'error-rate-medium';
                return `
                    <div class="issue-card">
                        <div class="issue-title">${issue}</div>
                        <div class="issue-count ${rateClass}">${count}</div>
                    </div>
                `;
            }).join('');

            // 更新DOM
            const attitudeIssuesGrid = document.getElementById('attitudeIssuesGrid');
            if (attitudeIssuesGrid) {
                attitudeIssuesGrid.innerHTML = issueCards;
            }
        }
        // 显示对话示例


        // 打开客服个人详情（右侧悬浮面板，使用后备数据保证可渲染）
        function openAgentDetails(agentName) {
            // 创建/获取右侧面板
            let panel = document.getElementById('agent-flyout-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'agent-flyout-panel';
                panel.style.position = 'fixed';
                panel.style.top = '80px';
                panel.style.right = '20px';
                panel.style.width = '420px';
                panel.style.maxHeight = '80vh';
                panel.style.overflowY = 'auto';
                panel.style.background = '#fff';
                panel.style.borderRadius = '14px';
                panel.style.boxShadow = '0 12px 40px rgba(0,0,0,0.25)';
                panel.style.zIndex = '9999';
                panel.style.padding = '18px 18px 12px 18px';
                document.body.appendChild(panel);
            }

            const pr = (dashboardData && dashboardData.personalReports && dashboardData.personalReports[agentName]) || null;
            const overview = pr?.overview || {};
            const language = pr?.languageQuality ? { ...pr.languageQuality } : {};
            const attitude = pr?.attitudeQuality ? { ...pr.attitudeQuality } : {};

            // 建议函数需先定义，后续会引用
            const makeSuggestion = (issue) => {
                const suggestions = {
                    'Prohibited Phrases': 'Avoid platform-restricted terms. Rephrase using compliant wording and offer alternatives.',
                    'Typos': 'Proofread before sending. Use spell-check. Keep sentences concise and clear.',
                    'Repetitive Description': 'Summarize once and refer to the summary. Remove duplicated sentences.',
                    'Response Timeout': 'Acknowledge within 30s, set expectations, and provide partial updates if needed.',
                    'Poor Service Tone': 'Use empathetic, positive language. Thank the user and avoid blame.',
                    'Insufficient Emotional Support': 'Acknowledge feelings first, then provide steps. Offer follow-up help.'
                };
                return suggestions[issue] || 'Follow standard guidelines, clarify next steps, and keep tone professional and empathetic.';
            };

            // 指标后备值
            const aiAvg = typeof overview.aiScore === 'number' ? overview.aiScore : parseFloat((45 + Math.random() * 5).toFixed(1));
            const manualAvg = typeof overview.manualScore === 'number' ? overview.manualScore : parseFloat((14 + Math.random() * 6).toFixed(1));
            const tickets = typeof overview.qaTickets === 'number' ? overview.qaTickets : Math.floor(Math.random() * 10) + 5;
            const firstResp = typeof overview.firstResponseRate === 'number' ? overview.firstResponseRate : parseFloat((80 + Math.random() * 20).toFixed(1));
            const resp30 = typeof overview.responseIn30sRate === 'number' ? overview.responseIn30sRate : parseFloat((50 + Math.random() * 30).toFixed(1));

            const langIssues = language.topIssues || ['Prohibited Phrases', 'Typos', 'Repetitive Description'];
            const attIssues = attitude.topIssues || ['Response Timeout', 'Poor Service Tone', 'Insufficient Emotional Support'];

            // 若缺少records，构造后备记录
            if (!Array.isArray(language.records) || language.records.length === 0) {
                language.records = langIssues.map(issue => ({
                    issueType: issue,
                    suggestion: makeSuggestion(issue),
                    conversationText: `User: ...\nAgent: Apologies for the confusion. We will handle it and keep you posted.`
                }));
            }
            if (!Array.isArray(attitude.records) || attitude.records.length === 0) {
                attitude.records = attIssues.map(issue => ({
                    issueType: issue,
                    suggestion: makeSuggestion(issue),
                    conversationText: `User: ...\nAgent: Thank you for your patience. I understand how you feel and will help immediately.`
                }));
            }

            const makeCollapse = (title, count, records) => `
                <div class="collapse-item">
                    <div class="collapse-header" onclick="this.parentElement.classList.toggle('active')">
                        <div class="collapse-title">${title}</div>
                        <div class="collapse-meta">${typeof count === 'number' ? 'Found ' + count + ' issue(s)' : ''}</div>
                    </div>
                    <div class="collapse-body">
                        <div class="suggestion-box">${makeSuggestion(title)}</div>
                        ${(records || []).map(r => `
                            <div class="record-item">
                                <div class="record-suggestion">${r.suggestion || makeSuggestion(title)}</div>
                                <div class="record-dialog">${r.conversationText || 'No dialog text available.'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            panel.innerHTML = `
                <div class="flyout-header">
                    <div class="flyout-title">
                        <div class="agent-avatar">${(agentName || 'A').slice(0, 1).toUpperCase()}</div>
                        <div>
                            <div style="font-size:15px; line-height:1.1;">Agent Details</div>
                            <div style="opacity:.9; font-weight:600;">${agentName} <span class="chip">Live</span></div>
                        </div>
                    </div>
                    <button class="dialog-close" onclick="document.getElementById('agent-flyout-panel')?.remove()" style="background:rgba(255,255,255,.25);color:#fff">&times;</button>
                </div>
                <div style="padding-top:6px;">
                    <div class="agent-summary-grid">
                        <div class="agent-summary-card"><div class="label">AI QA Average</div><div class="value">${aiAvg}</div></div>
                        <div class="agent-summary-card"><div class="label">Manual QA Average</div><div class="value">${manualAvg}</div></div>
                        <div class="agent-summary-card"><div class="label">QA Tickets</div><div class="value">${tickets}</div></div>
                        <div class="agent-summary-card"><div class="label">First Response Rate</div><div class="value">${firstResp}%</div></div>
                    </div>
                    <div class="agent-summary-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="agent-summary-card"><div class="label">30s Response Rate</div><div class="value">${resp30}%</div></div>
                        <div class="agent-summary-card"><div class="label">Total Score</div><div class="value">${(aiAvg + manualAvg).toFixed(1)}</div></div>
                    </div>

                    <div class="agent-section-title">Standard Language - Issues & AI Suggestions</div>
                    ${(() => {
                    const grouped = (language.records || []).reduce((acc, r) => {
                        const key = r.issueType || 'Other';
                        (acc[key] = acc[key] || []).push(r);
                        return acc;
                    }, {});
                    const keys = Object.keys(grouped).length ? Object.keys(grouped) : langIssues;
                    return keys.slice(0, 3).map(k => makeCollapse(k, (grouped[k] || []).length, grouped[k])).join('');
                })()}

                    <div class="agent-section-title">Service Attitude - Issues & AI Suggestions</div>
                    ${(() => {
                    const grouped = (attitude.records || []).reduce((acc, r) => {
                        const key = r.issueType || 'Other';
                        (acc[key] = acc[key] || []).push(r);
                        return acc;
                    }, {});
                    const keys = Object.keys(grouped).length ? Object.keys(grouped) : attIssues;
                    return keys.slice(0, 3).map(k => makeCollapse(k, (grouped[k] || []).length, grouped[k])).join('');
                })()}
                </div>
            `;
        }

        // Delegate click on .agent-name to open the flyout in place
        document.addEventListener('click', function (e) {
            const el = e.target;
            if (el && el.classList && el.classList.contains('agent-name') && el.dataset.agent) {
                e.preventDefault();
                const raw = el.dataset.agent;
                openAgentDetails(raw === 'jackkob	' || raw === 'jackkob	' ? 'jackkob	' : raw);
            }
        });

        // ESC键关闭对话框
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeDialog();
            }
        });

        function switchSubTab(button, tabId) {
            // 移除所有tab的active类
            const tabs = document.querySelectorAll('.sub-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // 移除所有内容的active类
            const contents = document.querySelectorAll('.sub-tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // 给当前点击的tab和对应内容添加active类
            button.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        // 初始化出金审核相关图表
        function initializeWithdrawalCharts() {
            // 1. 审核趋势图（用auditStats.normal/advanced的total/within3min等数据）
            const trendCanvas = document.getElementById('withdrawalTrendChart');
            const trendCtx = trendCanvas ? trendCanvas.getContext('2d') : null;
            if (withdrawalTrendChartInstance) {
                withdrawalTrendChartInstance.destroy();
            }

            const auditStats = jsonData.auditStats?.overall;
            const dateRange = auditStats?.time_range || '';

            const chartTitles = document.querySelectorAll('#withdrawal-content .chart-title');
            if (chartTitles.length >= 3 && dateRange) {
                chartTitles[0].textContent = `Withdrawal Review Distribution (${dateRange})`;
                chartTitles[1].textContent = `Review Count by Agent (${dateRange})`;
                chartTitles[2].textContent = `Manual Withdrawal Review Details (${dateRange})`;
            }

            let stats = (jsonData.auditStats && jsonData.auditStats.overall) ? jsonData.auditStats.overall : { total: 0, agents: [] };
            if (!stats.agents || stats.agents.length === 0) {
                const sampleNames = ['Daria', 'Hera', 'Jessica', 'Rebecca', 'Jenna', 'Euphemia', 'jackkob	'];
                const agents = sampleNames.map(name => {
                    const total = Math.floor(Math.random() * 60) + 40;
                    const within3min = Math.max(Math.floor(total * (0.75 + Math.random() * 0.2)), 1);
                    const within1min = Math.max(Math.floor(total * (0.35 + Math.random() * 0.25)), 0);
                    const over3min = Math.max(total - within3min, 0);
                    return {
                        name,
                        total,
                        within1min,
                        within1min_rate: total ? (within1min / total) * 100 : 0,
                        within3min,
                        within3min_rate: total ? (within3min / total) * 100 : 0,
                        over3min,
                        over3min_rate: total ? (over3min / total) * 100 : 0,
                        rate: total ? (within3min / total) * 100 : 0
                    };
                });
                stats = { time_range: dateRange || '', agents, total: agents.reduce((s, a) => s + a.total, 0) };
            }

            // Update summary cards
            try {
                const total = stats.total ?? stats.agents.reduce((s, a) => s + (a.total || 0), 0);
                const within1minTotal = stats.agents.reduce((s, a) => s + (a.within1min || 0), 0);
                const within3minTotal = stats.agents.reduce((s, a) => s + (a.within3min || 0), 0);
                const totalEl = document.getElementById('total-withdrawal-count');
                const manualEl = document.getElementById('total-manual-audit-count');
                const within1minCntEl = document.getElementById('within-1min-count');
                const within1minRateEl = document.getElementById('within-1min-rate');
                const within3minCntEl = document.getElementById('within-3min-count');
                const within3minRateEl = document.getElementById('within-3min-rate');
                if (totalEl) totalEl.textContent = String(total);
                if (manualEl) manualEl.textContent = String(total);
                if (within1minCntEl) within1minCntEl.textContent = String(within1minTotal);
                if (within1minRateEl) within1minRateEl.textContent = total ? `${((within1minTotal / total) * 100).toFixed(1)}%` : '0.0%';
                if (within3minCntEl) within3minCntEl.textContent = String(within3minTotal);
                if (within3minRateEl) within3minRateEl.textContent = total ? `${((within3minTotal / total) * 100).toFixed(1)}%` : '0.0%';
            } catch (e) { }

            // Limit to 7 agents for charts
            const limitedAgents = stats.agents.slice(0, 7);
            const agentNames = limitedAgents.map(a => a.name);
            const agentRates = limitedAgents.map(a => (typeof a.within3min_rate === 'number' ? a.within3min_rate : (a.rate || 0)));
            const colorPalette = ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#AB47BC', '#00ACC1', '#FF7043'];

            if (trendCtx) {
                withdrawalTrendChartInstance = new Chart(trendCtx, {
                    type: 'bar',
                    data: {
                        labels: agentNames,
                        datasets: [{
                            label: 'Within 3 min Rate (%)',
                            data: agentRates,
                            backgroundColor: colorPalette,
                            borderColor: colorPalette,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        layout: { padding: 0 },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    drawBorder: false,
                                    drawTicks: false
                                }
                            }
                        }
                    }
                });
            }

            // 2. 审核时长分布图（举例用普通审核各审核员的总单数）
            const timeCanvas = document.getElementById('withdrawalTimeChart');
            const timeCtx = timeCanvas ? timeCanvas.getContext('2d') : null;
            if (withdrawalTimeChartInstance) {
                withdrawalTimeChartInstance.destroy();
            }
            const agentTotals = limitedAgents.map(a => a.total);
            if (timeCtx) {
                withdrawalTimeChartInstance = new Chart(timeCtx, {
                    type: 'bar',
                    data: {
                        labels: agentNames,
                        datasets: [{
                            label: 'Total Reviews',
                            data: agentTotals,
                            backgroundColor: colorPalette,
                            borderColor: colorPalette,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        layout: { padding: 0 },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false,
                                    drawTicks: false
                                }
                            }
                        }
                    }
                });
            }

            // 3. 新增：出金审核时效趋势折线图
            initializeWithdrawalTrendLineChart();

            // charts removed; nothing to show/hide here

            console.log('Withdrawal charts rendered');
        }

        // 出金审核时效趋势折线图
        let withdrawalTrendLineChartInstance = null;

        function initializeWithdrawalTrendLineChart() {
            const ctx = document.getElementById('withdrawalTrendLineChart');
            if (!ctx) return;

            if (withdrawalTrendLineChartInstance) {
                withdrawalTrendLineChartInstance.destroy();
            }

            // 获取周度趋势数据
            const weeklyData = jsonData.auditStats?.weeklyTrend || [];

            if (weeklyData.length === 0) {
                // Fallback fake trend data in English
                const fakeWeeks = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                const within1 = fakeWeeks.map(() => parseFloat((60 + Math.random() * 20).toFixed(1)) / 100);
                const within3 = fakeWeeks.map(() => parseFloat((85 + Math.random() * 10).toFixed(1)) / 100);
                weeklyData.push(...fakeWeeks.map((w, i) => ({ week: w, within1min_rate: within1[i], within3min_rate: within3[i] })));
            }

            // 处理数据：过滤NaN并将0.78格式转换为78%格式
            const validData = weeklyData.filter(item => {
                return item.week &&
                    !isNaN(item.within1min_rate) &&
                    !isNaN(item.within3min_rate) &&
                    item.within1min_rate !== null &&
                    item.within3min_rate !== null;
            });

            if (validData.length === 0) {
                console.log('没有有效的周度趋势数据');
                return;
            }

            const labels = validData.map(item => item.week);
            const within1minData = validData.map(item => parseFloat((item.within1min_rate * 100).toFixed(1)));
            const within3minData = validData.map(item => parseFloat((item.within3min_rate * 100).toFixed(1)));

            // 计算Y轴最小值：找到1min和3min占比中的最低值，然后减10%
            const allRates = [...within1minData, ...within3minData];
            const minRate = Math.min(...allRates);
            const yAxisMin = Math.max(0, Math.floor(minRate - 10)); // 最低不低于0%，向下取整

            console.log('数据处理结果:', {
                validDataCount: validData.length,
                minRate: minRate,
                yAxisMin: yAxisMin,
                within1minData: within1minData,
                within3minData: within3minData
            });

            withdrawalTrendLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Within 1 min Rate',
                            data: within1minData,
                            borderColor: '#4285F4',
                            backgroundColor: '#4285F4',
                            fill: false,
                            tension: 0.1,
                            pointBackgroundColor: '#4285F4',
                            pointBorderColor: '#4285F4',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Within 3 min Rate',
                            data: within3minData,
                            borderColor: '#EA4335',
                            backgroundColor: '#EA4335',
                            fill: false,
                            tension: 0.1,
                            pointBackgroundColor: '#EA4335',
                            pointBorderColor: '#EA4335',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Week'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Percentage (%)'
                            },
                            min: yAxisMin,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
    </script>
</body>

</html>